<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lotus - ç®¡ç†è€…ãƒšãƒ¼ã‚¸</title>
    <link rel="stylesheet" href="../assets/app.css?v=7">
</head>

<body>
    <div class="page-banner">
        <img id="banner-logo" src="../assets/logo-wh.png" alt="Lotus" class="banner-logo">
        <h1 class="banner-title">ç®¡ç†è€…</h1>
        <div class="banner-spacer"></div>
        <img id="nanashi-mumei-gif" src="../assets/nanashi-mumei.gif" alt="Nanashi Mumei"
            style="height: 50px; width: auto; margin-right: 10px; cursor: pointer;">
        <button class="banner-logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div id="accounting-period-banner"
        style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); padding: 15px 20px; text-align: center; font-size: 20px; font-weight: bold; color: white; border-bottom: 3px solid #a71e2a; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <span id="accounting-period-text" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">è¨ˆä¸ŠæœŸé–“ã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>
    <style>
        @media (prefers-color-scheme: dark) {
            #accounting-period-banner {
                background: linear-gradient(135deg, #ff4757 0%, #dc3545 100%) !important;
                border-bottom-color: #ff6b7a !important;
                box-shadow: 0 2px 8px rgba(255, 71, 87, 0.3) !important;
            }

            #accounting-period-text {
                text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5) !important;
            }
        }
    </style>

    <section class="full-width-section">
        <h2>è³¼å…¥å¸Œæœ›ãƒªã‚¹ãƒˆ</h2>

        <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="search-form"
            style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin-top: 0; margin-bottom: 15px;">æ¤œç´¢æ¡ä»¶</h3>
            <div class="search-row"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                <div>
                    <label for="searchRequestNo">å—ä»˜ç•ªå·:</label>
                    <input type="text" id="searchRequestNo" placeholder="å—ä»˜ç•ªå·ã‚’å…¥åŠ›">
                </div>
                <div>
                    <label for="searchMember">æ°å:</label>
                    <select id="searchMember">
                        <option value="">ã™ã¹ã¦</option>
                    </select>
                </div>
                <div>
                    <label for="searchDepartment">éƒ¨ç½²:</label>
                    <select id="searchDepartment">
                        <option value="">ã™ã¹ã¦</option>
                    </select>
                </div>
                <div>
                    <label for="searchSummary">æ¦‚è¦:</label>
                    <select id="searchSummary">
                        <option value="">ã™ã¹ã¦</option>
                    </select>
                </div>
            </div>
            <div class="search-row">
                <label>çŠ¶æ…‹:</label>
                <div class="state-checkboxes" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="state_NEW" checked> ğŸ“‹ æœªå—ç†
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="state_ACCEPTED" checked> ğŸ”µ å—ç†æ¸ˆã¿
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="state_CASH_GIVEN" checked> ğŸ’° ç¾é‡‘æ¸¡ã—æ¸ˆã¿
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="state_COLLECTED" checked> ğŸ“„ å›åæ¸ˆã¿
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="state_RECEIPT_DONE" checked> ğŸ‰ å‡¦ç†å®Œäº†
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="state_FINALIZED"> âœ… è¨˜å…¥å®Œäº†
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="state_REJECTED" checked> âŒ å´ä¸‹
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="state_CASH_WITHDRAWN" checked> ğŸ§ ä¸‹ã‚ã—æ¸ˆã¿
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="state_PAID" checked> ğŸ’³ æ”¯æ‰•ã„æ¸ˆã¿
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="state_TRANSFERRED" checked> ğŸ¦ æŒ¯è¾¼æ¸ˆã¿
                    </label>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <button type="button" id="clearSearch" class="btn-secondary">æ¤œç´¢æ¡ä»¶ã‚¯ãƒªã‚¢</button>
                <span id="searchResultCount" style="margin-left: 15px; color: var(--muted);"></span>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>å—ä»˜ç•ªå·</th>
                    <th>æ°å</th>
                    <th>éƒ¨ç½²</th>
                    <th>æ¦‚è¦</th>
                    <th>çŠ¶æ…‹</th>
                    <th>æ¸¡ã—é¡</th>
                    <th>å‡¦ç†æ¸ˆã¿é¡</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="requests"></tbody>
        </table>
        <div class="request-actions">
            <button id="reload_requests">æ›´æ–°</button>
            <button id="recalculate_processed_amounts" class="btn-secondary">å‡¦ç†æ¸ˆã¿é¡å†è¨ˆç®—</button>
            <button id="create_backup_from_list"
                style="padding: 8px 16px; background-color: #0056b3; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 500;">æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</button>
            <button id="clear_requests" class="danger-button">è³¼å…¥å¸Œæœ›ãƒªã‚¹ãƒˆã‚¯ãƒªã‚¢</button>
        </div>
    </section>

    <!-- è²¡å‹™ç®¡ç†ã‚«ãƒ¼ãƒ‰ -->
    <section class="full-width-section">
        <h2>è²¡å‹™ç®¡ç†</h2>
        <div class="finance-cards"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">

            <!-- éŠ€è¡Œæ®‹é«˜ã‚«ãƒ¼ãƒ‰ -->
            <div class="finance-card"
                style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                <h3 style="margin-top: 0; color: var(--brand);">ğŸ¦ éŠ€è¡Œæ®‹é«˜</h3>
                <div class="finance-amount"
                    style="font-size: 24px; font-weight: bold; margin: 10px 0; color: var(--text-primary);">
                    Â¥<span id="bankBalance">0</span>
                </div>
                <div class="finance-controls" style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="number" id="bankBalanceInput" placeholder="é‡‘é¡ã‚’å…¥åŠ›"
                        style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                    <button onclick="updateBankBalance()"
                        style="padding: 8px 16px; background: var(--brand); color: white; border: none; border-radius: 4px; cursor: pointer;">æ›´æ–°</button>
                </div>
                <div class="finance-controls" style="margin-bottom: 10px;">
                    <button onclick="initBankBalance()"
                        style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">åˆæœŸå€¤è¨­å®š</button>
                </div>
                <div class="finance-transactions" style="display: flex; gap: 10px;">
                    <input type="number" id="bankWithdraw" placeholder="å¼•ãå‡ºã—é¡"
                        style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                    <button onclick="withdrawFromBank()"
                        style="padding: 8px 12px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;">å¼•ãå‡ºã—</button>
                    <input type="number" id="bankDeposit" placeholder="é å…¥é¡"
                        style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                    <button onclick="depositToBank()"
                        style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">é å…¥</button>
                </div>
            </div>

            <!-- æŒã¡å‡ºã—é¡ã‚«ãƒ¼ãƒ‰ -->
            <div class="finance-card"
                style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                <h3 style="margin-top: 0; color: var(--brand);">ğŸ’° æŒã¡å‡ºã—é¡</h3>
                <div class="finance-amount"
                    style="font-size: 24px; font-weight: bold; margin: 10px 0; color: var(--text-primary);">
                    Â¥<span id="cashOnHand">0</span>
                </div>
                <div class="finance-controls" style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="number" id="cashOnHandInput" placeholder="é‡‘é¡ã‚’å…¥åŠ›"
                        style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                    <button onclick="updateCashOnHand()"
                        style="padding: 8px 16px; background: var(--brand); color: white; border: none; border-radius: 4px; cursor: pointer;">æ›´æ–°</button>
                </div>
                <div class="finance-controls" style="margin-bottom: 10px;">
                    <button onclick="initCashOnHand()"
                        style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">åˆæœŸå€¤è¨­å®š</button>
                </div>
                <div class="finance-info" style="font-size: 12px; color: var(--text-secondary);">
                    éŠ€è¡Œã‹ã‚‰ã®å¼•ãå‡ºã—ãƒ»é å…¥ã§å¤‰å‹•
                </div>
            </div>

            <!-- å‡¦ç†æ¸ˆã¿é¡ã‚«ãƒ¼ãƒ‰ -->
            <div class="finance-card"
                style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                <h3 style="margin-top: 0; color: var(--brand);">ğŸ“Š å‡¦ç†æ¸ˆã¿é¡</h3>
                <div class="finance-amount"
                    style="font-size: 24px; font-weight: bold; margin: 10px 0; color: var(--text-primary);">
                    Â¥<span id="processedAmount">0</span>
                </div>
                <div class="finance-controls" style="margin-bottom: 10px;">
                    <button onclick="recalculateProcessedAmount()"
                        style="padding: 8px 16px; background: #ffc107; color: #000; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold;">å†ç®—å‡º</button>
                    <button onclick="initFinanceTables()"
                        style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 5px;">è²¡å‹™ãƒ†ãƒ¼ãƒ–ãƒ«åˆæœŸåŒ–</button>
                </div>
                <div class="finance-info" style="font-size: 12px; color: var(--text-secondary);">
                    ãƒ¬ã‚·ãƒ¼ãƒˆã®ç·é¡ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰
                </div>
            </div>

            <!-- æœªå‡¦ç†ã®è³¼å…¥å¸Œæœ›é¡ã‚«ãƒ¼ãƒ‰ -->
            <div class="finance-card"
                style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                <h3 style="margin-top: 0; color: var(--brand);">ğŸ“‹ æœªå‡¦ç†ã®è³¼å…¥å¸Œæœ›é¡</h3>
                <div class="finance-amount"
                    style="font-size: 24px; font-weight: bold; margin: 10px 0; color: var(--text-primary);">
                    Â¥<span id="pendingAmount">0</span>
                </div>
                <div class="finance-info" style="font-size: 12px; color: var(--text-secondary);">
                    ç¾é‡‘æ¸¡ã—æ¸ˆã¿ãƒ»æŒ¯è¾¼æ¸ˆã¿ãƒ»å›åæ¸ˆã¿ã®æœªå‡¦ç†é¡
                </div>
            </div>

            <!-- ç†è«–æ‰€æŒé‡‘é¡ã‚«ãƒ¼ãƒ‰ -->
            <div class="finance-card"
                style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                <h3 style="margin-top: 0; color: var(--brand);">ğŸ§® ç†è«–æ‰€æŒé‡‘é¡</h3>
                <div class="finance-amount"
                    style="font-size: 24px; font-weight: bold; margin: 10px 0; color: var(--text-primary);">
                    Â¥<span id="theoreticalCash">0</span>
                </div>
                <div class="finance-info" style="font-size: 12px; color: var(--text-secondary);">
                    æŒã¡å‡ºã—é¡ - å‡¦ç†æ¸ˆã¿é¡ - æœªå‡¦ç†ã®è³¼å…¥å¸Œæœ›é¡
                </div>
            </div>

            <!-- æ‰€æŒé‡‘é¡å…¥åŠ›ã‚«ãƒ¼ãƒ‰ -->
            <div class="finance-card"
                style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                <h3 style="margin-top: 0; color: var(--brand);">ğŸ’µ æ‰€æŒé‡‘é¡</h3>
                <div class="finance-controls" style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="number" id="actualCashInput" placeholder="å®Ÿéš›ã®æ‰€æŒé‡‘é¡ã‚’å…¥åŠ›"
                        style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                    <button onclick="updateActualCash()"
                        style="padding: 8px 16px; background: var(--brand); color: white; border: none; border-radius: 4px; cursor: pointer;">æ›´æ–°</button>
                </div>
                <div class="finance-controls" style="margin-bottom: 10px;">
                    <button onclick="setInitialActualCash()"
                        style="padding: 6px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;">åˆæœŸå€¤ã¨ã—ã¦è¨­å®š</button>
                </div>
                <div class="finance-amount"
                    style="font-size: 20px; font-weight: bold; margin: 10px 0; color: var(--text-primary);">
                    å®Ÿéš›ã®æ‰€æŒé‡‘é¡: Â¥<span id="actualCash">0</span>
                </div>
                <div class="finance-amount" style="font-size: 18px; font-weight: bold; margin: 10px 0;">
                    å·®ç•°: Â¥<span id="cashDifference">0</span>
                </div>
                <div class="finance-info" style="font-size: 12px; color: var(--text-secondary);">
                    ç†è«–æ‰€æŒé‡‘é¡ - å®Ÿéš›ã®æ‰€æŒé‡‘é¡ -
                </div>
            </div>


        </div>

        <!-- åå…¥ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section" style="margin-bottom: 30px;">
            <h2 style="color: var(--text-primary); margin-bottom: 20px;">ğŸ’° åå…¥ç®¡ç†</h2>

            <!-- åå…¥è¨˜éŒ²ã‚«ãƒ¼ãƒ‰ -->
            <div class="finance-card"
                style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: var(--brand);">ğŸ“ åå…¥è¨˜éŒ²</h3>
                <div class="finance-controls" style="margin-bottom: 15px;">
                    <input type="number" id="incomeAmount" placeholder="åå…¥é¡ã‚’å…¥åŠ›"
                        style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 10px;">
                    <input type="text" id="incomeDescription" placeholder="åå…¥å†…å®¹ã‚’å…¥åŠ›"
                        style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 10px;">
                    <button onclick="addIncome()"
                        style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">åå…¥ã‚’è¿½åŠ </button>
                </div>
                <div class="finance-info" style="font-size: 12px; color: var(--text-secondary);">
                    åå…¥ã‚’è¨˜éŒ²ã™ã‚‹ã¨éŠ€è¡Œæ®‹é«˜ã«è‡ªå‹•åŠ ç®—ã•ã‚Œã¾ã™
                </div>
            </div>

            <!-- åå…¥ä¸€è¦§ã‚«ãƒ¼ãƒ‰ -->
            <div class="finance-card"
                style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: var(--brand);">ğŸ“‹ åå…¥ä¸€è¦§</h3>
                    <button onclick="loadIncomeList()"
                        style="padding: 6px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ä¸€è¦§ã‚’è¡¨ç¤º</button>
                </div>
                <div id="incomeList" style="max-height: 300px; overflow-y: auto;">
                    <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                        ä¸€è¦§ã‚’è¡¨ç¤ºãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„
                    </div>
                </div>
            </div>
        </div>

        <!-- å¤‰æ›´ãƒ­ã‚° -->
        <div class="finance-log"
            style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0; color: var(--brand);">ğŸ“ å¤‰æ›´ãƒ­ã‚°</h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="clearAllFundLogs()"
                        style="padding: 6px 12px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">å…¨ã‚¯ãƒªã‚¢</button>
                    <button onclick="loadFundLogs()"
                        style="padding: 6px 12px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">æ›´æ–°</button>
                    <button onclick="debugDatabase()"
                        style="padding: 6px 12px; background: #ffc107; color: #000; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;">DBç¢ºèª</button>
                </div>
            </div>
            <div id="fundLogList"
                style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 10px; background: var(--bg-primary);">
                <div style="text-align: center; color: var(--text-secondary); padding: 20px;">ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</div>
            </div>
        </div>
    </section>

    <div class="admin-grid">
        <div class="admin-card">
            <h2>è¡Œäº‹ãƒã‚¹ã‚¿</h2>
            <div class="form-group" style="margin-bottom: 15px;">
                <label style="display: inline-block; margin-right: 10px;">é–‹å§‹æ—¥:</label>
                <input type="date" id="receipt_start_date" style="margin-right: 15px;" />
                <label style="display: inline-block; margin-right: 10px;">çµ‚äº†æ—¥:</label>
                <input type="date" id="receipt_end_date" style="margin-right: 15px;" />
                <label style="display: inline-block; margin-right: 10px;">è¨ˆä¸ŠæœŸé–“:</label>
                <select id="receipt_accounting_period" style="margin-right: 15px;">
                    <option value="">ã™ã¹ã¦</option>
                </select>
                <button onclick="clearReceiptDateFilter()" class="btn-secondary" style="font-size: 12px;">æ¡ä»¶ã‚¯ãƒªã‚¢</button>
            </div>
            <div style="margin-bottom: 15px; font-size: 11px; color: var(--text-secondary, #666);">
                â€» æ—¥ä»˜æ¡ä»¶ãƒ»è¨ˆä¸ŠæœŸé–“ã‚’è¨­å®šã™ã‚‹ã¨ã€è¡Œäº‹ãƒã‚¹ã‚¿ã®ä½¿ç”¨é¡ãƒ»ç§‘ç›®åˆ¥åˆè¨ˆé‡‘é¡ãƒ»ãƒ¬ã‚·ãƒ¼ãƒˆç¢ºèªãƒ»ç§‘ç›®åˆ¥ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ãŒæ¡ä»¶ã«åˆã†ãƒ¬ã‚·ãƒ¼ãƒˆã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™
            </div>
            <table>
                <thead>
                    <tr>
                        <th>è¡Œäº‹å</th>
                        <th>ä½¿ç”¨é¡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="events"></tbody>
            </table>
            <div class="form-group">
                <input id="event_name" placeholder="è¡Œäº‹å" />
                <button id="event_add"
                    style="padding: 5px 10px; background-color: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 500;">è¿½åŠ </button>
            </div>
        </div>
        <div class="admin-card">
            <h2>éƒ¨ç½²åŠã³å½¹å“¡ã®ä¸€æ‹¬ç™»éŒ²</h2>
            <p>ã‚¨ã‚¯ã‚»ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼: 1åˆ—ç›®=éƒ¨ç½²åã€2åˆ—ç›®=æ°å</p>
            <div class="form-group">
                <input type="file" id="excel_file" accept=".xlsx,.xls" />
                <button id="bulk_upload">ä¸€æ‹¬ç™»éŒ²</button>
            </div>
            <div id="bulk_result"></div>
        </div>

        <div class="admin-card">
            <h2>éƒ¨ç½²ãƒã‚¹ã‚¿</h2>
            <table>
                <thead>
                    <tr>
                        <th>éƒ¨ç½²å</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="departments"></tbody>
            </table>
            <div class="form-group">
                <input id="dep_name" placeholder="éƒ¨ç½²å" />
                <button id="dep_add"
                    style="padding: 5px 10px; background-color: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 500;">è¿½åŠ </button>
            </div>
            <div class="form-group">
                <button id="clear_departments" class="danger-button">éƒ¨ç½²ãƒã‚¹ã‚¿ã‚¯ãƒªã‚¢</button>
            </div>
        </div>

        <div class="admin-card">
            <h2>å½¹å“¡ãƒã‚¹ã‚¿</h2>
            <table>
                <thead>
                    <tr>
                        <th>æ°å</th>
                        <th>éƒ¨ç½²</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="members"></tbody>
            </table>
            <div class="form-group">
                <input id="member_name" placeholder="å½¹å“¡å" />
                <select id="member_department">
                    <option value="">éƒ¨ç½²ã‚’é¸æŠ</option>
                </select>
                <button id="member_add"
                    style="padding: 5px 10px; background-color: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 500;">è¿½åŠ </button>
            </div>
            <div class="form-group">
                <button id="clear_members" class="danger-button">å½¹å“¡ãƒã‚¹ã‚¿ã‚¯ãƒªã‚¢</button>
            </div>
        </div>

        <div class="admin-card">
            <h2>è¨ˆä¸ŠæœŸé–“ãƒã‚¹ã‚¿</h2>
            <table>
                <thead>
                    <tr>
                        <th>æœŸé–“å</th>
                        <th>çŠ¶æ…‹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="accounting_periods"></tbody>
            </table>
            <div class="form-group">
                <input id="period_name" placeholder="æœŸé–“å" />
                <button id="period_add"
                    style="padding: 5px 10px; background-color: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 500;">è¿½åŠ </button>
            </div>
        </div>

        <div class="admin-card">
            <h2>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç†</h2>
            <div class="form-group">
                <button id="create_backup"
                    style="padding: 8px 16px; background-color: #0056b3; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 500;">æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</button>
            </div>
            <div class="form-group">
                <label>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦å¾©å…ƒ:</label>
                <input type="file" id="backup_upload" accept=".sql" />
                <button id="upload_restore" class="btn-success">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦å¾©å…ƒ</button>
            </div>
            <div class="form-group">
                <label>æœŸé–“æŒ‡å®šæ¤œç´¢:</label>
                <input type="date" id="backup_start_date" />
                <input type="date" id="backup_end_date" />
                <button id="search_backups"
                    style="padding: 8px 16px; background-color: #0056b3; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 500;">æ¤œç´¢</button>
            </div>
            <div id="backup_list"></div>
        </div>

        <div class="admin-card">
            <h2>ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h2>
            <div class="form-group">
                <label>ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                <input type="password" id="admin_current_password" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
            </div>
            <div class="form-group">
                <label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                <input type="password" id="admin_new_password" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
            </div>
            <div class="form-group">
                <label>ç¢ºèª:</label>
                <input type="password" id="admin_confirm_password" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰" />
            </div>
            <div class="form-group">
                <button id="change_admin_password"
                    style="padding: 8px 16px; background-color: #0056b3; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 500;">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
            </div>
        </div>

        <div class="admin-card">
            <h2>è²¡å‹™ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h2>
            <div class="form-group">
                <label>ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                <input type="password" id="finance_current_password" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
            </div>
            <div class="form-group">
                <label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                <input type="password" id="finance_new_password" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
            </div>
            <div class="form-group">
                <label>ç¢ºèª:</label>
                <input type="password" id="finance_confirm_password" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰" />
            </div>
            <div class="form-group">
                <button id="change_finance_password"
                    style="padding: 8px 16px; background-color: #0056b3; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 500;">è²¡å‹™ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
            </div>
        </div>

        <div class="admin-card">
            <h2>å½¹å“¡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h2>
            <div class="form-group">
                <label>ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                <input type="password" id="officer_current_password" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
            </div>
            <div class="form-group">
                <label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
                <input type="password" id="officer_new_password" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
            </div>
            <div class="form-group">
                <label>ç¢ºèª:</label>
                <input type="password" id="officer_confirm_password" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰" />
            </div>
            <div class="form-group">
                <button id="change_officer_password"
                    style="padding: 8px 16px; background-color: #0056b3; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: 500;">å½¹å“¡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
            </div>
        </div>
    </div>
    <!-- ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="receiptListModal" class="modal-overlay">
        <div class="modal-content" style="min-width:600px; max-height:80vh; overflow-y:auto;">
            <h3>ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§</h3>
            <div id="receiptList"></div>
            <div class="modal-buttons">
                <button onclick="closeReceiptListModal()" class="btn-secondary">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <style>
        .edit-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 2px;
            cursor: pointer;
            border-radius: 3px;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 2px;
            cursor: pointer;
            border-radius: 3px;
        }

        .edit-btn:hover {
            background-color: #0056b3;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .btn-secondary {
            background-color: #5a6268;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 2px;
            cursor: pointer;
            border-radius: 3px;
            font-weight: 500;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 2px;
            cursor: pointer;
            border-radius: 3px;
        }

        .btn-primary {
            background-color: #0056b3;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 2px;
            cursor: pointer;
            border-radius: 3px;
            font-weight: 500;
        }

        .danger-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 2px;
            cursor: pointer;
            border-radius: 3px;
        }

        /* ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .receipt-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
        }

        .receipt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .receipt-actions {
            display: flex;
            gap: 10px;
        }

        .receipt-detail-row {
            margin: 5px 0;
        }

        .receipt-detail-row label {
            font-weight: bold;
            margin-right: 10px;
        }


        .modal-buttons {
            margin-top: 20px;
            text-align: center;
        }
    </style>

    <!-- ç§‘ç›®åˆ¥åˆè¨ˆé‡‘é¡è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="subjectBreakdownModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="min-width: 500px;">
            <h3 id="subjectBreakdownTitle">ç§‘ç›®åˆ¥åˆè¨ˆé‡‘é¡</h3>
            <div id="subjectBreakdownContent">
                <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <div class="modal-buttons">
                <button onclick="closeSubjectBreakdownModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ç§‘ç›®åˆ¥ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="subjectReceiptsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="min-width: 700px; max-width: 90vw;">
            <h3 id="subjectReceiptsTitle">ç§‘ç›®åˆ¥ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§</h3>
            <div id="subjectReceiptsContent">
                <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <div class="modal-buttons">
                <button onclick="closeSubjectReceiptsModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // ãƒ†ãƒ¼ãƒã«å¿œã˜ã¦ãƒ­ã‚´ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
        function updateBannerLogo() {
            const logo = document.getElementById('banner-logo');
            const isDarkTheme = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (isDarkTheme) {
                logo.src = '../assets/logo-wh.png'; // ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒæ™‚ã¯ç™½ã„ãƒ­ã‚´
            } else {
                logo.src = '../assets/logo-bl.png'; // ãƒ©ã‚¤ãƒˆãƒ†ãƒ¼ãƒæ™‚ã¯é»’ã„ãƒ­ã‚´
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ­ã‚´ã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', updateBannerLogo);

        // ãƒ†ãƒ¼ãƒå¤‰æ›´ã‚’ç›£è¦–
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateBannerLogo);

        // èªè¨¼ãƒã‚§ãƒƒã‚¯é–¢æ•°
        async function checkAuth() {
            try {
                const response = await fetch('/index.php?path=/api/auth/check');
                const result = await response.json();

                if (!result.ok) {
                    alert('èªè¨¼ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚');
                    location.href = '/pages/login.html';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                alert('èªè¨¼ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚');
                location.href = '/pages/login.html';
                return false;
            }
        }

        // çŠ¶æ…‹ãƒ†ã‚­ã‚¹ãƒˆå–å¾—é–¢æ•°
        function getStateText(state) {
            const stateMap = {
                'NEW': 'ğŸ“‹ æœªå—ç†',
                'ACCEPTED': 'ğŸ”µ å—ç†æ¸ˆã¿',
                'CASH_GIVEN': 'ğŸ’° ç¾é‡‘æ¸¡ã—æ¸ˆã¿',
                'COLLECTED': 'ğŸ“„ å›åæ¸ˆã¿',
                'RECEIPT_DONE': 'ğŸ‰ å‡¦ç†å®Œäº†',
                'FINALIZED': 'âœ… è¨˜å…¥å®Œäº†',
                'REJECTED': 'âŒ å´ä¸‹',
                'CASH_WITHDRAWN': 'ğŸ§ ä¸‹ã‚ã—æ¸ˆã¿',
                'PAID': 'ğŸ’³ æ”¯æ‰•ã„æ¸ˆã¿',
                'TRANSFERRED': 'ğŸ¦ æŒ¯è¾¼æ¸ˆã¿'
            };
            return stateMap[state] || state;
        }

        // æ¤œç´¢ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let allRequests = [];
        let filteredRequests = [];

        // æ¤œç´¢æ©Ÿèƒ½
        function filterRequests() {
            const requestNo = document.getElementById('searchRequestNo').value.toLowerCase();
            const member = document.getElementById('searchMember').value;
            const department = document.getElementById('searchDepartment').value;
            const summary = document.getElementById('searchSummary').value;

            // é¸æŠã•ã‚ŒãŸçŠ¶æ…‹ã‚’å–å¾—
            const selectedStates = [];
            const stateCheckboxes = document.querySelectorAll('.state-checkboxes input[type="checkbox"]:checked');
            stateCheckboxes.forEach(checkbox => {
                const state = checkbox.id.replace('state_', '');
                selectedStates.push(state);
            });

            filteredRequests = allRequests.filter(request => {
                // å—ä»˜ç•ªå·ã§ãƒ•ã‚£ãƒ«ã‚¿
                if (requestNo && !request.request_no.toLowerCase().includes(requestNo)) {
                    return false;
                }

                // æ°åã§ãƒ•ã‚£ãƒ«ã‚¿
                if (member && request.member_name !== member) {
                    return false;
                }

                // éƒ¨ç½²ã§ãƒ•ã‚£ãƒ«ã‚¿
                if (department && request.dept_name !== department) {
                    return false;
                }

                // æ¦‚è¦ã§ãƒ•ã‚£ãƒ«ã‚¿
                if (summary && request.summary !== summary) {
                    return false;
                }

                // çŠ¶æ…‹ã§ãƒ•ã‚£ãƒ«ã‚¿
                if (selectedStates.length > 0 && !selectedStates.includes(request.state || 'NEW')) {
                    return false;
                }

                return true;
            });

            displayRequests();
            updateSearchResultCount();
        }

        // æ¤œç´¢çµæœã®è¡¨ç¤º
        function displayRequests() {
            // çŠ¶æ…‹ã§ã‚½ãƒ¼ãƒˆ
            const sortedRequests = [...filteredRequests].sort((a, b) => {
                const stateOrder = {
                    'NEW': 1,
                    'ACCEPTED': 2,
                    'CASH_GIVEN': 3,
                    'TRANSFERRED': 3,
                    'COLLECTED': 4,
                    'RECEIPT_DONE': 5,
                    'FINALIZED': 6,
                    'REJECTED': 7,
                    'CASH_WITHDRAWN': 8,
                    'PAID': 9
                };

                const aOrder = stateOrder[a.state || 'NEW'] || 10;
                const bOrder = stateOrder[b.state || 'NEW'] || 10;

                if (aOrder !== bOrder) {
                    return aOrder - bOrder;
                }

                // åŒã˜çŠ¶æ…‹ã®å ´åˆã¯å—ä»˜ç•ªå·ã§ã‚½ãƒ¼ãƒˆ
                return a.request_no.localeCompare(b.request_no);
            });

            const tbody = document.getElementById('requests');
            tbody.innerHTML = sortedRequests.map(x => `
        <tr>
            <td>${x.request_no}</td>
            <td>${x.member_name}</td>
            <td>${x.dept_name}</td>
            <td>${x.summary}</td>
            <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="state-badge state-${x.state || 'NEW'}">${getStateText(x.state || 'NEW')}</span>
                    <select id="state_${x.id}" onchange="updateState(${x.id})" style="flex: 1;">
                        <option value="NEW" ${(x.state === 'NEW' || x.state === '' || !x.state) ? 'selected' : ''}>æœªå—ç†</option>
                        <option value="ACCEPTED" ${x.state === 'ACCEPTED' ? 'selected' : ''}>å—ç†</option>
                        ${x.expects_network === 'BANK_TRANSFER' ?
                    // éŠ€è¡ŒæŒ¯è¾¼ã®å ´åˆï¼šæ¸¡ã—æ¸ˆã¿ãªã—ã€æŒ¯è¾¼æ¸ˆã¿ã‚ã‚Š
                    `
                            <option value="TRANSFERRED" ${x.state === 'TRANSFERRED' ? 'selected' : ''}>æŒ¯è¾¼æ¸ˆã¿</option>
                            <option value="COLLECTED" ${x.state === 'COLLECTED' ? 'selected' : ''}>å›åæ¸ˆã¿</option>
                            ` :
                    // ç¾é‡‘ã®å ´åˆï¼šæ¸¡ã—æ¸ˆã¿ã‚ã‚Šã€æŒ¯è¾¼æ¸ˆã¿ãªã—
                    `
                            <option value="CASH_GIVEN" ${x.state === 'CASH_GIVEN' ? 'selected' : ''}>æ¸¡ã—æ¸ˆã¿</option>
                            <option value="COLLECTED" ${x.state === 'COLLECTED' ? 'selected' : ''}>å›åæ¸ˆã¿</option>
                            `
                }
                        <option value="RECEIPT_DONE" ${x.state === 'RECEIPT_DONE' ? 'selected' : ''}>å‡¦ç†å®Œäº†</option>
                        <option value="FINALIZED" ${x.state === 'FINALIZED' ? 'selected' : ''}>è¨˜å…¥å®Œäº†</option>
                        <option value="REJECTED" ${x.state === 'REJECTED' ? 'selected' : ''}>å´ä¸‹</option>
                    </select>
                </div>
                ${x.state === 'REJECTED' && x.rejected_reason ? '<br/><small style="color: #666;">å´ä¸‹ç†ç”±: ' + x.rejected_reason + '</small>' : ''}
            </td>
            <td>
                ${x.state === 'RECEIPT_DONE' || x.state === 'FINALIZED' ?
                    (x.cash_given ? 'Â¥' + parseFloat(x.cash_given).toLocaleString() : '') :
                    `<input type="number" id="cash_given_${x.id}" value="${x.cash_given || ''}" 
                           step="0.01" min="0" style="width: 100px;" 
                           onchange="updateCashGiven(${x.id})" />`
                }
            </td>
            <td id="processed_amount_${x.id}">Â¥${(x.processed_amount || 0).toLocaleString()}</td>
            <td>
                <button onclick="viewReceipts(${x.id})">ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§</button>
                <button onclick="deleteRequest(${x.id})" class="danger-button">å‰Šé™¤</button>
            </td>
        </tr>
    `).join('');
        }

        // æ¤œç´¢çµæœæ•°ã®æ›´æ–°
        function updateSearchResultCount() {
            const countElement = document.getElementById('searchResultCount');
            countElement.textContent = `æ¤œç´¢çµæœ: ${filteredRequests.length}ä»¶ / å…¨${allRequests.length}ä»¶`;
        }

        // æ¤œç´¢æ¡ä»¶ã®ã‚¯ãƒªã‚¢
        function clearSearch() {
            document.getElementById('searchRequestNo').value = '';
            document.getElementById('searchMember').value = '';
            document.getElementById('searchDepartment').value = '';
            document.getElementById('searchSummary').value = '';

            // çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
            document.getElementById('state_NEW').checked = true;
            document.getElementById('state_ACCEPTED').checked = true;
            document.getElementById('state_CASH_GIVEN').checked = true;
            document.getElementById('state_COLLECTED').checked = true;
            document.getElementById('state_RECEIPT_DONE').checked = true;
            document.getElementById('state_FINALIZED').checked = false;
            document.getElementById('state_REJECTED').checked = true;
            document.getElementById('state_CASH_WITHDRAWN').checked = true;
            document.getElementById('state_PAID').checked = true;
            document.getElementById('state_TRANSFERRED').checked = true;

            filterRequests();
        }

        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
        function updateSearchOptions() {
            updateMemberOptions();
            updateDepartmentOptions();
            updateSummaryOptions();
        }

        // æ°åã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
        function updateMemberOptions() {
            const memberSelect = document.getElementById('searchMember');
            const currentValue = memberSelect.value;

            // ç¾åœ¨ã®æ¤œç´¢æ¡ä»¶ã§ãƒ•ã‚£ãƒ«ã‚¿ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ°åã‚’å–å¾—
            const filteredData = getFilteredDataForOptions();
            const members = [...new Set(filteredData.map(r => r.member_name))].sort();

            memberSelect.innerHTML = '<option value="">ã™ã¹ã¦</option>' +
                members.map(member => `<option value="${member}">${member}</option>`).join('');

            // ç¾åœ¨ã®å€¤ãŒæ–°ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ä¿æŒ
            if (currentValue && members.includes(currentValue)) {
                memberSelect.value = currentValue;
            }
        }

        // éƒ¨ç½²ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
        function updateDepartmentOptions() {
            const deptSelect = document.getElementById('searchDepartment');
            const currentValue = deptSelect.value;

            // ç¾åœ¨ã®æ¤œç´¢æ¡ä»¶ã§ãƒ•ã‚£ãƒ«ã‚¿ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰éƒ¨ç½²ã‚’å–å¾—
            const filteredData = getFilteredDataForOptions();
            const departments = [...new Set(filteredData.map(r => r.dept_name))].sort();

            deptSelect.innerHTML = '<option value="">ã™ã¹ã¦</option>' +
                departments.map(dept => `<option value="${dept}">${dept}</option>`).join('');

            // ç¾åœ¨ã®å€¤ãŒæ–°ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ä¿æŒ
            if (currentValue && departments.includes(currentValue)) {
                deptSelect.value = currentValue;
            }
        }

        // æ¦‚è¦ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
        function updateSummaryOptions() {
            const summarySelect = document.getElementById('searchSummary');
            const currentValue = summarySelect.value;

            // ç¾åœ¨ã®æ¤œç´¢æ¡ä»¶ã§ãƒ•ã‚£ãƒ«ã‚¿ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¦‚è¦ã‚’å–å¾—
            const filteredData = getFilteredDataForOptions();
            const summaries = [...new Set(filteredData.map(r => r.summary))].sort();

            summarySelect.innerHTML = '<option value="">ã™ã¹ã¦</option>' +
                summaries.map(summary => `<option value="${summary}">${summary}</option>`).join('');

            // ç¾åœ¨ã®å€¤ãŒæ–°ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ä¿æŒ
            if (currentValue && summaries.includes(currentValue)) {
                summarySelect.value = currentValue;
            }
        }

        // ç¾åœ¨ã®æ¤œç´¢æ¡ä»¶ï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ä»¥å¤–ï¼‰ã§ãƒ•ã‚£ãƒ«ã‚¿ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        function getFilteredDataForOptions() {
            const requestNo = document.getElementById('searchRequestNo').value.toLowerCase();

            // é¸æŠã•ã‚ŒãŸçŠ¶æ…‹ã‚’å–å¾—
            const selectedStates = [];
            const stateCheckboxes = document.querySelectorAll('.state-checkboxes input[type="checkbox"]:checked');
            stateCheckboxes.forEach(checkbox => {
                const state = checkbox.id.replace('state_', '');
                selectedStates.push(state);
            });

            return allRequests.filter(request => {
                // å—ä»˜ç•ªå·ã§ãƒ•ã‚£ãƒ«ã‚¿
                if (requestNo && !request.request_no.toLowerCase().includes(requestNo)) {
                    return false;
                }

                // çŠ¶æ…‹ã§ãƒ•ã‚£ãƒ«ã‚¿
                if (selectedStates.length > 0 && !selectedStates.includes(request.state || 'NEW')) {
                    return false;
                }

                return true;
            });
        }

        // éƒ¨ç½²é¸æŠæ™‚ã«æ°åã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
        function updateMemberOptionsOnDepartmentChange() {
            const department = document.getElementById('searchDepartment').value;
            const memberSelect = document.getElementById('searchMember');
            const currentValue = memberSelect.value;

            let filteredData;
            if (department) {
                // éƒ¨ç½²ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã®éƒ¨ç½²ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‹ã‚‰æ°åã‚’å–å¾—
                filteredData = getFilteredDataForOptions().filter(request => request.dept_name === department);
            } else {
                // éƒ¨ç½²ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ç¾åœ¨ã®æ¤œç´¢æ¡ä»¶ã§ãƒ•ã‚£ãƒ«ã‚¿ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ°åã‚’å–å¾—
                filteredData = getFilteredDataForOptions();
            }

            const members = [...new Set(filteredData.map(r => r.member_name))].sort();

            memberSelect.innerHTML = '<option value="">ã™ã¹ã¦</option>' +
                members.map(member => `<option value="${member}">${member}</option>`).join('');

            // ç¾åœ¨ã®å€¤ãŒæ–°ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ä¿æŒ
            if (currentValue && members.includes(currentValue)) {
                memberSelect.value = currentValue;
            }
        }

        // è²¡å‹™ç®¡ç†ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let fundData = {
            bankBalance: 0,
            cashOnHand: 0,
            processedAmount: 0,
            actualCash: 0
        };


        // è²¡å‹™ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿
        async function loadFundLogs() {
            try {
                console.log('è²¡å‹™ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                const response = await fetch('/index.php?path=/api/finance/logs');
                if (response.ok) {
                    const result = await response.json();
                    if (result.ok && result.data) {
                        console.log('è²¡å‹™ãƒ­ã‚°ã‚’å–å¾—:', result.data);
                        displayFundLogs(result.data);
                    }
                }
            } catch (error) {
                console.error('è²¡å‹™ãƒ­ã‚°ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // è²¡å‹™ãƒ­ã‚°ã‚’è¡¨ç¤º
        function displayFundLogs(logs) {
            const logList = document.getElementById('fundLogList');
            if (!logList) return;

            if (logs.length === 0) {
                logList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            logList.innerHTML = logs.map(log => {
                const date = new Date(log.created_at).toLocaleString('ja-JP');
                const amountText = log.amount >= 0 ? `+Â¥${log.amount.toLocaleString()}` : `Â¥${log.amount.toLocaleString()}`;
                const amountColor = log.amount >= 0 ? 'var(--success)' : 'var(--danger)';

                const descriptionText = log.description ? ` (${log.description})` : '';

                return `
            <div style="padding: 8px; border-bottom: 1px solid var(--border-color); font-size: 14px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <span>${date} - ${log.type} ${log.action}${descriptionText}</span>
                        <span style="color: ${amountColor}; font-weight: bold; margin-left: 10px;">${amountText}</span>
                    </div>
                    <button onclick="deleteFundLog(${log.id}, '${log.source || 'finance_logs'}')" style="padding: 4px 8px; background: var(--danger); color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; margin-left: 10px;">å‰Šé™¤</button>
                </div>
            </div>
        `;
            }).join('');
        }

        // å€‹åˆ¥ãƒ­ã‚°ã‚’å‰Šé™¤
        async function deleteFundLog(logId, source = 'finance_logs') {
            if (!confirm('ã“ã®ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆè²¡å‹™å€¤ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ï¼‰')) {
                return;
            }

            try {
                console.log('ãƒ­ã‚°å‰Šé™¤:', logId, 'from:', source);
                const response = await fetch(`/index.php?path=/api/finance/logs/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ logId: logId, source: source })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.ok) {
                        console.log('ãƒ­ã‚°å‰Šé™¤æˆåŠŸ');
                        alert('ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆè²¡å‹™å€¤ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ï¼‰');
                        // ãƒ­ã‚°ã‚’å†èª­ã¿è¾¼ã¿
                        await loadFundLogs();
                    } else {
                        alert('ãƒ­ã‚°ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                    }
                } else {
                    alert('ãƒ­ã‚°ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('ãƒ­ã‚°å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ­ã‚°ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // å…¨ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢
        async function clearAllFundLogs() {
            if (!confirm('ã™ã¹ã¦ã®ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                return;
            }

            try {
                console.log('å…¨ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Ÿè¡Œ');
                const response = await fetch('/index.php?path=/api/finance/logs/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.ok) {
                        console.log('å…¨ãƒ­ã‚°ã‚¯ãƒªã‚¢æˆåŠŸ');
                        alert('ã™ã¹ã¦ã®ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆè²¡å‹™å€¤ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ï¼‰');
                        // ãƒ­ã‚°ã‚’å†èª­ã¿è¾¼ã¿
                        await loadFundLogs();
                    } else {
                        alert('ãƒ­ã‚°ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                    }
                } else {
                    alert('ãƒ­ã‚°ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ­ã‚°ã®ã‚¯ãƒªã‚¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèª
        async function debugDatabase() {
            try {
                console.log('=== ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒãƒƒã‚°é–‹å§‹ ===');
                const response = await fetch('/index.php?path=/api/debug/database', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('=== ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒãƒƒã‚°çµæœ ===');
                    console.log('ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§:', result.data.tables);
                    console.log('finance_logsæ§‹é€ :', result.data.finance_logs_structure);
                    console.log('finance_logsãƒ‡ãƒ¼ã‚¿:', result.data.finance_logs_data);
                    console.log('typeåˆ¥é›†è¨ˆ:', result.data.finance_logs_by_type);
                    console.log('finance_balancesæ§‹é€ :', result.data.finance_balances_structure);
                    console.log('finance_balancesãƒ‡ãƒ¼ã‚¿:', result.data.finance_balances_data);
                    console.log('fund_logsæ§‹é€ :', result.data.fund_logs_structure);
                    console.log('fund_logsãƒ‡ãƒ¼ã‚¿:', result.data.fund_logs_data);
                    console.log('fundsæ§‹é€ :', result.data.funds_structure);
                    console.log('fundsãƒ‡ãƒ¼ã‚¿:', result.data.funds_data);
                    console.log('=== ãƒ‡ãƒãƒƒã‚°çµæœçµ‚äº† ===');

                    // ã‚¢ãƒ©ãƒ¼ãƒˆã§ä¸»è¦æƒ…å ±ã‚’è¡¨ç¤º
                    let message = 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±:\n\n';
                    message += 'ãƒ†ãƒ¼ãƒ–ãƒ«: ' + result.data.tables.join(', ') + '\n\n';

                    if (result.data.finance_logs_by_type) {
                        message += 'finance_logs typeåˆ¥é›†è¨ˆ:\n';
                        result.data.finance_logs_by_type.forEach(item => {
                            message += `- ${item.type}: ${item.count}ä»¶, åˆè¨ˆ: ${item.total}\n`;
                        });
                    }

                    alert(message);
                } else {
                    console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒãƒƒã‚°å¤±æ•—:', response.status);
                    alert('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadFundData() {
            console.log('=== è²¡å‹™ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹ ===');
            try {
                console.log('APIå‘¼ã³å‡ºã—: /api/finance');
                const response = await fetch('/index.php?path=/api/finance');
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                // è²¡å‹™ãƒ­ã‚°ã‚‚åŒæ™‚ã«èª­ã¿è¾¼ã¿
                await loadFundLogs();

                if (!response.ok) {
                    console.warn('è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    console.log('Response status:', response.status);

                    // 500ã‚¨ãƒ©ãƒ¼ã®å ´åˆã®ã¿åˆæœŸåŒ–ã‚’è©¦è¡Œ
                    if (response.status === 500) {
                        console.log('è²¡å‹™ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆæœŸåŒ–ã‚’è©¦è¡Œã—ã¾ã™...');
                        try {
                            const initResponse = await fetch('/index.php?path=/api/finance/init', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' }
                            });
                            const initResult = await initResponse.json();
                            console.log('åˆæœŸåŒ–çµæœ:', initResult);

                            if (initResult.ok) {
                                console.log('è²¡å‹™ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã—ã¾ã™ã€‚');
                                // åˆæœŸåŒ–å¾Œã€å†åº¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                                const retryResponse = await fetch('/index.php?path=/api/finance');
                                if (retryResponse.ok) {
                                    const retryResult = await retryResponse.json();
                                    if (retryResult.ok) {
                                        fundData = retryResult.data;
                                        console.log('åˆæœŸåŒ–å¾Œã®ãƒ‡ãƒ¼ã‚¿:', fundData);
                                        updateFundDisplay();
                                        updateBalanceDifference();
                                        return;
                                    }
                                }
                            }
                        } catch (initError) {
                            console.error('è²¡å‹™ãƒ†ãƒ¼ãƒ–ãƒ«åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', initError);
                        }
                    }

                    // åˆæœŸå€¤ã‚’è¨­å®šï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒï¼‰
                    fundData = { bankBalance: 0, cashOnHand: 0, processedAmount: 0 };
                    console.log('åˆæœŸå€¤è¨­å®š:', fundData);
                    updateFundDisplay();
                    return;
                }

                const result = await response.json();
                console.log('Finance API response:', result);

                if (result.ok && result.data) {
                    // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã‚’æ­£ã—ããƒãƒƒãƒ”ãƒ³ã‚°
                    fundData = {
                        bankBalance: result.data.bank_balance || 0,
                        cashOnHand: result.data.cash_amount || 0,
                        processedAmount: result.data.processed_amount || 0,
                        actualCash: result.data.actual_cash || 0
                    };
                    console.log('Fund data loaded from API:', fundData);
                    console.log('éŠ€è¡Œæ®‹é«˜:', fundData.bankBalance);
                    console.log('æŒã¡å‡ºã—é¡:', fundData.cashOnHand);
                    console.log('å‡¦ç†æ¸ˆã¿é¡:', fundData.processedAmount);
                    console.log('å®Ÿéš›ã®æ‰€æŒé‡‘é¡:', fundData.actualCash);
                    console.log('API response data:', result.data);
                    console.log('=== ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===');
                    console.log('result.data.actual_cash:', result.data.actual_cash);
                    console.log('typeof result.data.actual_cash:', typeof result.data.actual_cash);
                    console.log('result.data.actual_cash === 0:', result.data.actual_cash === 0);
                    console.log('result.data.actual_cash === "0":', result.data.actual_cash === "0");
                    console.log('result.data.actual_cash == 0:', result.data.actual_cash == 0);
                    console.log('=== ãƒ‡ãƒãƒƒã‚°æƒ…å ±çµ‚äº† ===');
                    updateFundDisplay();
                } else {
                    console.warn('è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆæœŸå€¤ã‚’è¨­å®šã—ã¾ã™ã€‚');
                    console.log('API Response:', result);
                    fundData = { bankBalance: 0, cashOnHand: 0, processedAmount: 0 };
                    updateFundDisplay();
                }
            } catch (error) {
                console.error('Load fund data error:', error);
                fundData = { bankBalance: 0, cashOnHand: 0, processedAmount: 0 };
                updateFundDisplay();
            }
            console.log('=== è²¡å‹™ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿çµ‚äº† ===');
        }

        // è²¡å‹™è¡¨ç¤ºã‚’æ›´æ–°
        async function updateFundDisplay() {
            console.log('=== updateFundDisplay é–‹å§‹ ===');
            console.log('fundData:', fundData);

            const bankBalance = fundData.bankBalance || 0;
            const cashOnHand = fundData.cashOnHand || 0;
            const processedAmount = fundData.processedAmount || 0;
            const actualCash = fundData.actualCash || 0;

            // æœªå‡¦ç†ã®è³¼å…¥å¸Œæœ›é¡ã‚’å–å¾—
            let pendingAmount = 0;
            try {
                const response = await fetch('/index.php?path=/api/finance/pending-requests');
                const result = await response.json();
                if (result.ok && result.data) {
                    pendingAmount = result.data.pending_amount || 0;
                }
            } catch (error) {
                console.error('æœªå‡¦ç†é¡å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                pendingAmount = 0;
            }

            // ç†è«–æ‰€æŒé‡‘é¡ã‚’è¨ˆç®—ï¼ˆæŒã¡å‡ºã—é¡ - å‡¦ç†æ¸ˆã¿é¡ - æœªå‡¦ç†ã®è³¼å…¥å¸Œæœ›é¡ï¼‰
            const theoreticalCash = cashOnHand - processedAmount - pendingAmount;

            // å·®ç•°ã‚’è¨ˆç®—ï¼ˆç†è«–æ‰€æŒé‡‘é¡ - å®Ÿéš›ã®æ‰€æŒé‡‘é¡ï¼‰
            const cashDifference = theoreticalCash - actualCash;

            console.log('è¡¨ç¤ºç”¨ã®å€¤ - éŠ€è¡Œæ®‹é«˜:', bankBalance);
            console.log('è¡¨ç¤ºç”¨ã®å€¤ - æŒã¡å‡ºã—é¡:', cashOnHand);
            console.log('è¡¨ç¤ºç”¨ã®å€¤ - å‡¦ç†æ¸ˆã¿é¡:', processedAmount);
            console.log('è¡¨ç¤ºç”¨ã®å€¤ - æœªå‡¦ç†ã®è³¼å…¥å¸Œæœ›é¡:', pendingAmount);
            console.log('è¡¨ç¤ºç”¨ã®å€¤ - ç†è«–æ‰€æŒé‡‘é¡:', theoreticalCash);
            console.log('è¡¨ç¤ºç”¨ã®å€¤ - å®Ÿéš›ã®æ‰€æŒé‡‘é¡:', actualCash);
            console.log('è¡¨ç¤ºç”¨ã®å€¤ - å·®ç•°:', cashDifference);

            // éŠ€è¡Œæ®‹é«˜
            const bankElement = document.getElementById('bankBalance');
            if (bankElement) {
                bankElement.textContent = bankBalance.toLocaleString();
            }

            // æŒã¡å‡ºã—é¡
            const cashElement = document.getElementById('cashOnHand');
            if (cashElement) {
                cashElement.textContent = cashOnHand.toLocaleString();
            }

            // å‡¦ç†æ¸ˆã¿é¡
            const processedElement = document.getElementById('processedAmount');
            if (processedElement) {
                processedElement.textContent = processedAmount.toLocaleString();
            }

            // æœªå‡¦ç†ã®è³¼å…¥å¸Œæœ›é¡
            const pendingElement = document.getElementById('pendingAmount');
            if (pendingElement) {
                pendingElement.textContent = pendingAmount.toLocaleString();
            }

            // ç†è«–æ‰€æŒé‡‘é¡
            const theoreticalElement = document.getElementById('theoreticalCash');
            if (theoreticalElement) {
                theoreticalElement.textContent = theoreticalCash.toLocaleString();
            }

            // å®Ÿéš›ã®æ‰€æŒé‡‘é¡
            const actualCashElement = document.getElementById('actualCash');
            if (actualCashElement) {
                actualCashElement.textContent = actualCash.toLocaleString();
            }

            // å·®ç•°
            const differenceElement = document.getElementById('cashDifference');
            if (differenceElement) {
                differenceElement.textContent = cashDifference.toLocaleString();
                // å·®ç•°ã®è‰²ã‚’è¨­å®š
                if (cashDifference > 0) {
                    differenceElement.style.color = 'var(--success)';
                } else if (cashDifference < 0) {
                    differenceElement.style.color = 'var(--danger)';
                } else {
                    differenceElement.style.color = 'var(--text-primary)';
                }
            }

            console.log('=== updateFundDisplay çµ‚äº† ===');
        }


        // éŠ€è¡Œæ®‹é«˜ã‚’æ›´æ–°
        async function updateBankBalance() {
            const amount = parseFloat(document.getElementById('bankBalanceInput').value);
            console.log('=== éŠ€è¡Œæ®‹é«˜æ›´æ–°é–‹å§‹ ===');
            console.log('å…¥åŠ›é‡‘é¡:', amount);

            if (isNaN(amount) || amount < 0) {
                alert('æœ‰åŠ¹ãªé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                console.log('APIå‘¼ã³å‡ºã—: /api/finance/bank-balance');
                const response = await fetch('/index.php?path=/api/finance/bank-balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount })
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('API Response:', result);

                if (result.ok) {
                    console.log('æ›´æ–°å‰ã®fundData:', fundData);
                    fundData.bankBalance = amount;
                    console.log('æ›´æ–°å¾Œã®fundData:', fundData);
                    updateFundDisplay();
                    addFundLog('éŠ€è¡Œæ®‹é«˜', 'ç›´æ¥æ›´æ–°', amount);
                    document.getElementById('bankBalanceInput').value = '';
                    console.log('éŠ€è¡Œæ®‹é«˜æ›´æ–°å®Œäº†');
                } else {
                    console.error('éŠ€è¡Œæ®‹é«˜æ›´æ–°å¤±æ•—:', result.message);
                    alert('éŠ€è¡Œæ®‹é«˜ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            } catch (error) {
                console.error('Update bank balance error:', error);
                alert('éŠ€è¡Œæ®‹é«˜ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
            console.log('=== éŠ€è¡Œæ®‹é«˜æ›´æ–°çµ‚äº† ===');
        }

        // éŠ€è¡Œæ®‹é«˜ã®åˆæœŸå€¤ã‚’è¨­å®š
        async function initBankBalance() {
            const amount = prompt('éŠ€è¡Œæ®‹é«˜ã®åˆæœŸå€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            console.log('=== éŠ€è¡Œæ®‹é«˜åˆæœŸå€¤è¨­å®šé–‹å§‹ ===');
            console.log('å…¥åŠ›é‡‘é¡:', amount);

            if (amount === null) {
                console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
                return;
            }

            const initAmount = parseFloat(amount);
            if (isNaN(initAmount) || initAmount < 0) {
                alert('æœ‰åŠ¹ãªé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm(`éŠ€è¡Œæ®‹é«˜ã‚’Â¥${initAmount.toLocaleString()}ã«åˆæœŸè¨­å®šã—ã¾ã™ã‹ï¼Ÿ\n\næ³¨æ„: ã“ã®æ“ä½œã¯æ—¢å­˜ã®éŠ€è¡Œæ®‹é«˜ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚`)) {
                console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç¢ºèªã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
                return;
            }

            try {
                console.log('APIå‘¼ã³å‡ºã—: /api/finance/init-bank-balance');
                const response = await fetch('/index.php?path=/api/finance/init-bank-balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: initAmount })
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('API Response:', result);

                if (result.ok) {
                    console.log('åˆæœŸè¨­å®šå‰ã®fundData:', fundData);
                    fundData.bankBalance = initAmount;
                    console.log('åˆæœŸè¨­å®šå¾Œã®fundData:', fundData);
                    updateFundDisplay();
                    addFundLog('éŠ€è¡Œæ®‹é«˜', 'åˆæœŸè¨­å®š', initAmount);
                    console.log('éŠ€è¡Œæ®‹é«˜åˆæœŸè¨­å®šå®Œäº†');
                    alert('éŠ€è¡Œæ®‹é«˜ã®åˆæœŸå€¤è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ');
                } else {
                    console.error('éŠ€è¡Œæ®‹é«˜åˆæœŸè¨­å®šå¤±æ•—:', result.message);
                    alert('éŠ€è¡Œæ®‹é«˜ã®åˆæœŸå€¤è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            } catch (error) {
                console.error('Init bank balance error:', error);
                alert('éŠ€è¡Œæ®‹é«˜ã®åˆæœŸå€¤è¨­å®šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
            console.log('=== éŠ€è¡Œæ®‹é«˜åˆæœŸå€¤è¨­å®šçµ‚äº† ===');
        }

        // æŒã¡å‡ºã—é¡ã®åˆæœŸå€¤ã‚’è¨­å®š
        async function initCashOnHand() {
            const amount = prompt('æŒã¡å‡ºã—é¡ã®åˆæœŸå€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            console.log('=== æŒã¡å‡ºã—é¡åˆæœŸå€¤è¨­å®šé–‹å§‹ ===');
            console.log('å…¥åŠ›é‡‘é¡:', amount);

            if (amount === null) {
                console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
                return;
            }

            const initAmount = parseFloat(amount);
            if (isNaN(initAmount) || initAmount < 0) {
                alert('æœ‰åŠ¹ãªé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm(`æŒã¡å‡ºã—é¡ã‚’Â¥${initAmount.toLocaleString()}ã«åˆæœŸè¨­å®šã—ã¾ã™ã‹ï¼Ÿ\n\næ³¨æ„: ã“ã®æ“ä½œã¯æ—¢å­˜ã®æŒã¡å‡ºã—é¡ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚`)) {
                console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç¢ºèªã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
                return;
            }

            try {
                console.log('APIå‘¼ã³å‡ºã—: /api/finance/init-cash-on-hand');
                const response = await fetch('/index.php?path=/api/finance/init-cash-on-hand', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: initAmount })
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('API Response:', result);

                if (result.ok) {
                    console.log('åˆæœŸè¨­å®šå‰ã®fundData:', fundData);
                    fundData.cashOnHand = initAmount;
                    console.log('åˆæœŸè¨­å®šå¾Œã®fundData:', fundData);
                    updateFundDisplay();
                    addFundLog('æŒã¡å‡ºã—é¡', 'åˆæœŸè¨­å®š', initAmount);
                    console.log('æŒã¡å‡ºã—é¡åˆæœŸè¨­å®šå®Œäº†');
                    alert('æŒã¡å‡ºã—é¡ã®åˆæœŸå€¤è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ');
                } else {
                    console.error('æŒã¡å‡ºã—é¡åˆæœŸè¨­å®šå¤±æ•—:', result.message);
                    alert('æŒã¡å‡ºã—é¡ã®åˆæœŸå€¤è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            } catch (error) {
                console.error('Init cash on hand error:', error);
                alert('æŒã¡å‡ºã—é¡ã®åˆæœŸå€¤è¨­å®šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
            console.log('=== æŒã¡å‡ºã—é¡åˆæœŸå€¤è¨­å®šçµ‚äº† ===');
        }

        // æŒã¡å‡ºã—é¡ã‚’æ›´æ–°
        async function updateCashOnHand() {
            const amount = parseFloat(document.getElementById('cashOnHandInput').value);
            console.log('=== æŒã¡å‡ºã—é¡æ›´æ–°é–‹å§‹ ===');
            console.log('å…¥åŠ›é‡‘é¡:', amount);

            if (isNaN(amount) || amount < 0) {
                alert('æœ‰åŠ¹ãªé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                console.log('APIå‘¼ã³å‡ºã—: /api/finance/cash-amount');
                const response = await fetch('/index.php?path=/api/finance/cash-amount', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount })
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('API Response:', result);

                if (result.ok) {
                    console.log('æ›´æ–°å‰ã®fundData:', fundData);
                    fundData.cashOnHand = amount;
                    console.log('æ›´æ–°å¾Œã®fundData:', fundData);
                    updateFundDisplay();
                    addFundLog('æŒã¡å‡ºã—é¡', 'ç›´æ¥æ›´æ–°', amount);
                    document.getElementById('cashOnHandInput').value = '';
                    console.log('æŒã¡å‡ºã—é¡æ›´æ–°å®Œäº†');
                } else {
                    console.error('æŒã¡å‡ºã—é¡æ›´æ–°å¤±æ•—:', result.message);
                    alert('æŒã¡å‡ºã—é¡ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            } catch (error) {
                console.error('Update cash on hand error:', error);
                alert('æŒã¡å‡ºã—é¡ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
            console.log('=== æŒã¡å‡ºã—é¡æ›´æ–°çµ‚äº† ===');
        }

        // å®Ÿéš›ã®æ‰€æŒé‡‘é¡ã‚’æ›´æ–°
        async function updateActualCash() {
            const amount = parseFloat(document.getElementById('actualCashInput').value);
            console.log('=== å®Ÿéš›ã®æ‰€æŒé‡‘é¡æ›´æ–°é–‹å§‹ ===');
            console.log('å…¥åŠ›é‡‘é¡:', amount);

            if (isNaN(amount) || amount < 0) {
                alert('æœ‰åŠ¹ãªé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                console.log('APIå‘¼ã³å‡ºã—: /api/finance/actual-cash');
                const response = await fetch('/index.php?path=/api/finance/actual-cash', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount })
                });

                console.log('Response status:', response.status);

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…ˆã«å–å¾—ã—ã¦ãƒ‡ãƒãƒƒã‚°
                const responseText = await response.text();
                console.log('Raw response:', responseText);

                let result;
                try {
                    result = JSON.parse(responseText);
                    console.log('Parsed JSON:', result);
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    console.error('Response was:', responseText);
                    alert('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + responseText.substring(0, 200));
                    return;
                }

                if (result.ok) {
                    console.log('=== å®Ÿéš›ã®æ‰€æŒé‡‘é¡æ›´æ–°ãƒ‡ãƒãƒƒã‚° ===');
                    console.log('æ›´æ–°å‰ã®fundData:', fundData);
                    console.log('è¨­å®šã™ã‚‹é‡‘é¡:', amount);
                    fundData.actualCash = amount;
                    console.log('æ›´æ–°å¾Œã®fundData:', fundData);
                    console.log('=== ãƒ‡ãƒãƒƒã‚°çµ‚äº† ===');
                    updateFundDisplay();
                    addFundLog('å®Ÿéš›ã®æ‰€æŒé‡‘é¡', 'ç›´æ¥æ›´æ–°', amount);
                    document.getElementById('actualCashInput').value = '';
                    alert('å®Ÿéš›ã®æ‰€æŒé‡‘é¡ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                } else {
                    alert('å®Ÿéš›ã®æ‰€æŒé‡‘é¡ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
                }
            } catch (error) {
                console.error('å®Ÿéš›ã®æ‰€æŒé‡‘é¡æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                alert('å®Ÿéš›ã®æ‰€æŒé‡‘é¡ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            console.log('=== å®Ÿéš›ã®æ‰€æŒé‡‘é¡æ›´æ–°çµ‚äº† ===');
        }

        // å®Ÿéš›ã®æ‰€æŒé‡‘é¡ã®åˆæœŸå€¤ã‚’è¨­å®š
        async function setInitialActualCash() {
            const amount = parseFloat(document.getElementById('actualCashInput').value);
            console.log('=== åˆæœŸå€¤è¨­å®šé–‹å§‹ ===');
            console.log('è¨­å®šé‡‘é¡:', amount);

            if (isNaN(amount) || amount < 0) {
                alert('æœ‰åŠ¹ãªé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm(`å®Ÿéš›ã®æ‰€æŒé‡‘é¡ã‚’${amount.toLocaleString()}å††ã«åˆæœŸè¨­å®šã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            try {
                console.log('APIå‘¼ã³å‡ºã—: /api/finance/actual-cash/init');
                const response = await fetch('/index.php?path=/api/finance/actual-cash/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount })
                });

                console.log('Response status:', response.status);

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…ˆã«å–å¾—ã—ã¦ãƒ‡ãƒãƒƒã‚°
                const responseText = await response.text();
                console.log('Raw response:', responseText);

                let result;
                try {
                    result = JSON.parse(responseText);
                    console.log('Parsed JSON:', result);
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    console.error('Response was:', responseText);
                    alert('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + responseText.substring(0, 200));
                    return;
                }

                if (result.ok) {
                    console.log('åˆæœŸå€¤è¨­å®šæˆåŠŸ');
                    fundData.actualCash = amount;
                    updateFundDisplay();
                    document.getElementById('actualCashInput').value = '';
                    alert('å®Ÿéš›ã®æ‰€æŒé‡‘é¡ã‚’åˆæœŸå€¤ã¨ã—ã¦è¨­å®šã—ã¾ã—ãŸ');
                } else {
                    alert('åˆæœŸå€¤ã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
                }
            } catch (error) {
                console.error('åˆæœŸå€¤è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                alert('åˆæœŸå€¤ã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            console.log('=== åˆæœŸå€¤è¨­å®šçµ‚äº† ===');
        }

        // åå…¥ã‚’è¿½åŠ 
        async function addIncome() {
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            const description = document.getElementById('incomeDescription').value.trim();

            console.log('=== åå…¥è¿½åŠ é–‹å§‹ ===');
            console.log('åå…¥é¡:', amount);
            console.log('åå…¥å†…å®¹:', description);

            if (isNaN(amount) || amount <= 0) {
                alert('æœ‰åŠ¹ãªé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!description) {
                alert('åå…¥å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                console.log('APIå‘¼ã³å‡ºã—: /api/finance/income');
                const response = await fetch('/index.php?path=/api/finance/income', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: amount,
                        description: description
                    })
                });

                console.log('Response status:', response.status);

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…ˆã«å–å¾—ã—ã¦ãƒ‡ãƒãƒƒã‚°
                const responseText = await response.text();
                console.log('Raw response:', responseText);

                let result;
                try {
                    result = JSON.parse(responseText);
                    console.log('Parsed JSON:', result);
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    console.error('Response was:', responseText);
                    alert('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + responseText.substring(0, 200));
                    return;
                }

                if (result.ok) {
                    console.log('åå…¥è¿½åŠ æˆåŠŸ');
                    // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
                    document.getElementById('incomeAmount').value = '';
                    document.getElementById('incomeDescription').value = '';

                    // è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    await loadFundData();

                    // åå…¥ä¸€è¦§ã‚‚å†èª­ã¿è¾¼ã¿
                    await loadIncomeList();

                    alert('åå…¥ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
                } else {
                    alert('åå…¥ã®è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
                }
            } catch (error) {
                console.error('åå…¥è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                alert('åå…¥ã®è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            console.log('=== åå…¥è¿½åŠ çµ‚äº† ===');
        }

        // åå…¥ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadIncomeList() {
            console.log('=== åå…¥ä¸€è¦§èª­ã¿è¾¼ã¿é–‹å§‹ ===');

            try {
                const response = await fetch('/index.php?path=/api/finance/income/list');
                console.log('Response status:', response.status);

                const result = await response.json();
                console.log('Income list API response:', result);

                if (result.ok && result.data && result.data.incomes) {
                    displayIncomeList(result.data.incomes);
                } else {
                    console.log('No income data found or invalid response structure');
                    document.getElementById('incomeList').innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">åå…¥ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                }
            } catch (error) {
                console.error('åå…¥ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('incomeList').innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">åå…¥ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
            console.log('=== åå…¥ä¸€è¦§èª­ã¿è¾¼ã¿çµ‚äº† ===');
        }

        // åå…¥ä¸€è¦§ã‚’è¡¨ç¤º
        async function displayIncomeList(incomes) {
            const incomeListElement = document.getElementById('incomeList');

            if (incomes.length === 0) {
                incomeListElement.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">åå…¥è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            // åå…¥ã®ç·é¡ã‚’è¨ˆç®—
            const totalIncome = incomes.reduce((sum, income) => sum + parseFloat(income.amount), 0);

            // éŠ€è¡Œæ®‹é«˜ã®åˆæœŸå€¤ã‚’å–å¾—
            let initialBankBalance = 0;
            try {
                const response = await fetch('/index.php?path=/api/finance/initial-balance');
                const result = await response.json();
                if (result.ok && result.data) {
                    initialBankBalance = result.data.initial_balance || 0;
                }
            } catch (error) {
                console.error('åˆæœŸå€¤å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                initialBankBalance = 0;
            }

            // åˆæœŸå€¤+åå…¥ã®ç·é¡ã‚’è¨ˆç®—
            const totalWithIncome = initialBankBalance + totalIncome;

            let html = '<div style="border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden;">';

            // ç·é¡è¡¨ç¤ºã‚’è¿½åŠ 
            html += `
        <div style="padding: 15px; background: var(--brand); color: white; border-bottom: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-size: 14px; font-weight: bold;">åˆæœŸå€¤ + åå…¥ç·é¡</div>
                    <div style="font-size: 12px; opacity: 0.9;">åˆæœŸå€¤: Â¥${initialBankBalance.toLocaleString()} + åå…¥: Â¥${totalIncome.toLocaleString()}</div>
                </div>
                <div style="font-size: 18px; font-weight: bold;">Â¥${totalWithIncome.toLocaleString()}</div>
            </div>
        </div>
    `;

            incomes.forEach((income, index) => {
                const date = new Date(income.created_at).toLocaleDateString('ja-JP');
                const amount = parseInt(income.amount).toLocaleString();
                const description = income.description || 'å†…å®¹ä¸æ˜';

                html += `
            <div style="padding: 12px; border-bottom: 1px solid var(--border-color); ${index % 2 === 0 ? 'background: var(--bg-primary);' : ''}">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: var(--text-primary);">Â¥${amount}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${description}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 12px; color: var(--text-secondary);">${date}</div>
                        <button onclick="deleteIncome(${income.id})" style="padding: 4px 8px; background: var(--danger); color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;">å‰Šé™¤</button>
                    </div>
                </div>
            </div>
        `;
            });

            html += '</div>';
            incomeListElement.innerHTML = html;
        }

        // åå…¥ã‚’å‰Šé™¤
        async function deleteIncome(incomeId) {
            if (!confirm('ã“ã®åå…¥è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼ŸéŠ€è¡Œæ®‹é«˜ã‹ã‚‰ã‚‚å·®ã—å¼•ã‹ã‚Œã¾ã™ã€‚')) {
                return;
            }

            console.log('=== åå…¥å‰Šé™¤é–‹å§‹ ===');
            console.log('å‰Šé™¤å¯¾è±¡ID:', incomeId);

            try {
                const response = await fetch('/index.php?path=/api/finance/income/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: incomeId })
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Delete response:', result);

                if (result.ok) {
                    alert('åå…¥è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                    await loadIncomeList();
                    // è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã‚‚å†èª­ã¿è¾¼ã¿
                    await loadFundData();
                } else {
                    alert('åå…¥ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
                }
            } catch (error) {
                console.error('åå…¥å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('åå…¥ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            console.log('=== åå…¥å‰Šé™¤çµ‚äº† ===');
        }

        // éŠ€è¡Œã‹ã‚‰å¼•ãå‡ºã—
        async function withdrawFromBank() {
            const amount = parseFloat(document.getElementById('bankWithdraw').value);
            if (isNaN(amount) || amount <= 0) {
                alert('æœ‰åŠ¹ãªå¼•ãå‡ºã—é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (amount > fundData.bankBalance) {
                alert('éŠ€è¡Œæ®‹é«˜ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                return;
            }

            try {
                const response = await fetch('/index.php?path=/api/finance/bank-withdraw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount })
                });

                const result = await response.json();
                if (result.ok) {
                    fundData.bankBalance -= amount;
                    fundData.cashOnHand += amount;
                    updateFundDisplay();
                    addFundLog('éŠ€è¡Œæ®‹é«˜', 'å¼•ãå‡ºã—', -amount);
                    addFundLog('æ‰€æŒé‡‘é¡', 'é å…¥', amount);
                    document.getElementById('bankWithdraw').value = '';
                } else {
                    alert('å¼•ãå‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            } catch (error) {
                console.error('Withdraw from bank error:', error);
                alert('éŠ€è¡Œã‹ã‚‰ã®å¼•ãå‡ºã—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // éŠ€è¡Œã«é å…¥
        async function depositToBank() {
            const amount = parseFloat(document.getElementById('bankDeposit').value);
            if (isNaN(amount) || amount <= 0) {
                alert('æœ‰åŠ¹ãªé å…¥é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (amount > fundData.cashOnHand) {
                alert('æ‰€æŒé‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                return;
            }

            try {
                const response = await fetch('/index.php?path=/api/finance/bank-deposit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount })
                });

                const result = await response.json();
                if (result.ok) {
                    fundData.bankBalance += amount;
                    fundData.cashOnHand -= amount;
                    updateFundDisplay();
                    addFundLog('éŠ€è¡Œæ®‹é«˜', 'é å…¥', amount);
                    addFundLog('æ‰€æŒé‡‘é¡', 'å¼•ãå‡ºã—', -amount);
                    document.getElementById('bankDeposit').value = '';
                } else {
                    alert('é å…¥ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            } catch (error) {
                console.error('Deposit to bank error:', error);
                alert('éŠ€è¡Œã¸ã®é å…¥ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // æ‰€æŒé‡‘é¡ã‹ã‚‰å¼•ãå‡ºã—
        async function withdrawFromCash() {
            const amount = parseFloat(document.getElementById('cashWithdraw').value);
            if (isNaN(amount) || amount <= 0) {
                alert('æœ‰åŠ¹ãªå¼•ãå‡ºã—é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (amount > fundData.cashOnHand) {
                alert('æ‰€æŒé‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                return;
            }

            try {
                const response = await fetch('/index.php?path=/api/finance/cash-withdraw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount })
                });

                const result = await response.json();
                if (result.ok) {
                    fundData.cashOnHand -= amount;
                    updateFundDisplay();
                    addFundLog('æ‰€æŒé‡‘é¡', 'å¼•ãå‡ºã—', -amount);
                    document.getElementById('cashWithdraw').value = '';
                } else {
                    alert('å¼•ãå‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            } catch (error) {
                console.error('Withdraw from cash error:', error);
                alert('æ‰€æŒé‡‘é¡ã‹ã‚‰ã®å¼•ãå‡ºã—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // æ‰€æŒé‡‘é¡ã«é å…¥
        async function depositToCash() {
            const amount = parseFloat(document.getElementById('cashDeposit').value);
            if (isNaN(amount) || amount <= 0) {
                alert('æœ‰åŠ¹ãªé å…¥é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const response = await fetch('/index.php?path=/api/finance/cash-deposit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount })
                });

                const result = await response.json();
                if (result.ok) {
                    fundData.cashOnHand += amount;
                    updateFundDisplay();
                    addFundLog('æ‰€æŒé‡‘é¡', 'é å…¥', amount);
                    document.getElementById('cashDeposit').value = '';
                } else {
                    alert('é å…¥ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            } catch (error) {
                console.error('Deposit to cash error:', error);
                alert('æ‰€æŒé‡‘é¡ã¸ã®é å…¥ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // å‡¦ç†æ¸ˆã¿é¡ã‚’å†ç®—å‡º
        async function recalculateProcessedAmount() {
            try {
                const response = await fetch('/index.php?path=/api/finance/recalculate-processed', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                if (result.ok) {
                    fundData.processedAmount = result.data.processed_amount;
                    updateFundDisplay();
                    addFundLog('å‡¦ç†æ¸ˆã¿é¡', 'å†ç®—å‡º', result.data.processed_amount);
                    alert(`å‡¦ç†æ¸ˆã¿é¡ã‚’å†ç®—å‡ºã—ã¾ã—ãŸ: Â¥${result.data.processed_amount.toLocaleString()}`);
                } else {
                    alert('å‡¦ç†æ¸ˆã¿é¡ã®å†ç®—å‡ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            } catch (error) {
                console.error('Recalculate processed amount error:', error);
                alert('å‡¦ç†æ¸ˆã¿é¡ã®å†ç®—å‡ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // è²¡å‹™ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆæœŸåŒ–
        async function initFinanceTables() {
            if (!confirm('è²¡å‹™ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿæ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚')) {
                return;
            }

            try {
                const response = await fetch('/index.php?path=/api/finance/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                if (result.ok) {
                    alert('è²¡å‹™ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ');
                    // è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    loadFundData();
                } else {
                    alert('è²¡å‹™ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            } catch (error) {
                console.error('Init finance tables error:', error);
                alert('è²¡å‹™ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // å¤‰æ›´ãƒ­ã‚°ã‚’è¿½åŠ 
        function addFundLog(type, action, amount) {
            const logList = document.getElementById('fundLogList');
            const now = new Date();
            const timestamp = now.toLocaleString('ja-JP');

            const logEntry = document.createElement('div');
            logEntry.style.cssText = 'padding: 8px; border-bottom: 1px solid var(--border-color); font-size: 14px;';

            const amountText = amount >= 0 ? `+Â¥${amount.toLocaleString()}` : `Â¥${amount.toLocaleString()}`;
            const amountColor = amount >= 0 ? 'var(--success)' : 'var(--danger)';

            logEntry.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span>${timestamp} - ${type} ${action}</span>
            <span style="color: ${amountColor}; font-weight: bold;">${amountText}</span>
        </div>
    `;

            // æœ€åˆã®ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤ï¼ˆãƒ­ã‚°ãŒç©ºã®å ´åˆï¼‰
            const emptyLog = logList.querySelector('div[style*="text-align: center"]');
            if (emptyLog) {
                emptyLog.remove();
            }

            // æ–°ã—ã„ãƒ­ã‚°ã‚’å…ˆé ­ã«è¿½åŠ 
            logList.insertBefore(logEntry, logList.firstChild);

            // ãƒ­ã‚°ãŒå¤šã™ãã‚‹å ´åˆã¯å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
            const logs = logList.querySelectorAll('div[style*="padding: 8px"]');
            if (logs.length > 50) {
                logs[logs.length - 1].remove();
            }
        }

        async function load() {
            // èªè¨¼ãƒã‚§ãƒƒã‚¯
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) return;

            try {
                const d = await (await fetch('/index.php?path=/api/masters/departments')).json();
                const m = await (await fetch('/index.php?path=/api/masters/members')).json();
                const p = await (await fetch('/index.php?path=/api/masters/accounting-periods')).json();

                // æ—¥ä»˜æ¡ä»¶ã‚’å–å¾—ã—ã¦è¡Œäº‹ãƒã‚¹ã‚¿ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const dateParams = getReceiptDateParams();
                const eventsUrl = `/index.php?path=/api/masters/events${dateParams ? '&' + dateParams : ''}`;
                const e = await (await fetch(eventsUrl)).json();

                if (!d.ok) {
                    const deptEl = document.getElementById('departments');
                    if (deptEl) deptEl.innerHTML = '<tr><td colspan="2">error: ' + d.message + '</td></tr>';
                    return;
                }
                if (!m.ok) {
                    const memEl = document.getElementById('members');
                    if (memEl) memEl.innerHTML = '<tr><td colspan="3">error: ' + m.message + '</td></tr>';
                    return;
                }
                if (!e.ok) {
                    const eventEl = document.getElementById('events');
                    if (eventEl) eventEl.innerHTML = '<tr><td colspan="2">error: ' + e.message + '</td></tr>';
                    return;
                }
                if (!p.ok) {
                    const periodEl = document.getElementById('accounting_periods');
                    if (periodEl) periodEl.innerHTML = '<tr><td colspan="3">error: ' + p.message + '</td></tr>';
                    return;
                }

                // è¨ˆä¸ŠæœŸé–“ä¸€è¦§ã®æ›´æ–°
                const periodEl = document.getElementById('accounting_periods');
                if (periodEl) {
                    periodEl.innerHTML = p.data.map(x => `
                <tr>
                    <td>${x.name}</td>
                    <td>
                        <button onclick="togglePeriodActive(${x.id}, ${x.is_active ? 0 : 1})" 
                                class="${x.is_active ? 'active-period-btn' : 'inactive-period-btn'}"
                                style="${x.is_active ? 'background-color: #dc3545; color: white;' : 'background-color: #6c757d; color: white;'}">
                            ${x.is_active ? 'active' : 'inactive'}
                        </button>
                    </td>
                    <td>
                        <button onclick="editPeriod(${x.id},'${x.name.replace(/'/g, "\\'")}')" class="edit-btn">ç·¨é›†</button>
                        <button onclick="deletePeriod(${x.id},'${x.name.replace(/'/g, "\\'")}')" class="delete-btn">å‰Šé™¤</button>
                    </td>
                </tr>
            `).join('');
                }

                // è¨ˆä¸ŠæœŸé–“ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®æ›´æ–°
                const periodSelect = document.getElementById('receipt_accounting_period');
                if (periodSelect) {
                    const currentValue = periodSelect.value;
                    periodSelect.innerHTML = '<option value="">ã™ã¹ã¦</option>' +
                        p.data.map(x => `<option value="${x.id}">${x.name}</option>`).join('');
                    if (currentValue) {
                        periodSelect.value = currentValue;
                    }
                }

                // activeãªè¨ˆä¸ŠæœŸé–“ã‚’å–å¾—ã—ã¦ãƒãƒŠãƒ¼ã«è¡¨ç¤º
                const activePeriod = p.data.find(x => x.is_active === 1);
                const periodBannerText = document.getElementById('accounting-period-text');
                if (periodBannerText) {
                    if (activePeriod) {
                        periodBannerText.textContent = `${activePeriod.name}è¨ˆä¸ŠæœŸé–“ä¸­ã§ã™`;
                    } else {
                        periodBannerText.textContent = 'è¨ˆä¸ŠæœŸé–“ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
                    }
                }

                // éƒ¨ç½²ä¸€è¦§ã®æ›´æ–°
                const deptEl = document.getElementById('departments');
                if (deptEl) {
                    deptEl.innerHTML = d.data.map(x => `
                <tr>
                    <td>${x.name}</td>
                    <td>
                        <button onclick="editDept(${x.id},'${x.name}')" class="edit-btn">ç·¨é›†</button>
                        <button onclick="deleteDepartment(${x.id},'${x.name}')" class="delete-btn">å‰Šé™¤</button>
                    </td>
                </tr>
            `).join('');
                }

                // ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ã®æ›´æ–°ï¼ˆä¿®æ­£ç‰ˆï¼‰
                const memEl = document.getElementById('members');
                if (memEl) {
                    memEl.innerHTML = m.data.map(x => `
                <tr>
                    <td>${x.name}</td>
                    <td>${x.department_name || 'æœªè¨­å®š'}</td>
                    <td>
                        <button onclick="editMember(${x.id},'${x.name}',${x.department_id})" class="edit-btn">ç·¨é›†</button>
                        <button onclick="deleteMember(${x.id},'${x.name}')" class="delete-btn">å‰Šé™¤</button>
                    </td>
                </tr>
            `).join('');
                }

                // è¡Œäº‹ä¸€è¦§ã®æ›´æ–°
                const eventEl = document.getElementById('events');
                if (eventEl) {
                    eventEl.innerHTML = e.data.map(x => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>${x.name}</span>
                            <button onclick="showEventSubjectBreakdown(${x.id}, '${x.name}')" 
                                    style="background: none; border: none; cursor: pointer; padding: 4px; color: var(--text, #333);"
                                    title="ç§‘ç›®åˆ¥åˆè¨ˆã‚’è¡¨ç¤º">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M6 9l6 6 6-6"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                    <td>Â¥${parseFloat(x.total_amount || 0).toLocaleString()}</td>
                      <td>
                          <button onclick="viewEventReceipts(${x.id},'${x.name}')" class="btn-info">ãƒ¬ã‚·ãƒ¼ãƒˆç¢ºèª</button>
                          <button onclick="editEvent(${x.id},'${x.name}')" class="edit-btn">ç·¨é›†</button>
                          <button onclick="deleteEvent(${x.id},'${x.name}')" class="delete-btn">å‰Šé™¤</button>
                      </td>
                </tr>
            `).join('');
                }

                // éƒ¨ç½²é¸æŠè‚¢ã®æ›´æ–°
                const memberDeptSelect = document.getElementById('member_department');
                if (memberDeptSelect) {
                    memberDeptSelect.innerHTML = '<option value="">éƒ¨ç½²ã‚’é¸æŠ</option>' +
                        d.data.map(x => `<option value="${x.id}">${x.name}</option>`).join('');
                }

            } catch (e) {
                console.error('Load error:', e);
                const deptEl = document.getElementById('departments');
                const memEl = document.getElementById('members');
                const eventEl = document.getElementById('events');

                if (deptEl) deptEl.innerHTML = '<tr><td colspan="2">ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
                if (memEl) memEl.innerHTML = '<tr><td colspan="3">ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
                if (eventEl) eventEl.innerHTML = '<tr><td colspan="2">ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
                const periodEl = document.getElementById('accounting_periods');
                if (periodEl) periodEl.innerHTML = '<tr><td colspan="3">ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
            }
        }

        async function loadRequests() {
            // èªè¨¼ãƒã‚§ãƒƒã‚¯
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) return;

            const r = await (await fetch('/index.php?path=/api/requests')).json();
            if (!r.ok) {
                const reqEl = document.getElementById('requests');
                if (reqEl) reqEl.innerHTML = '<tr><td colspan="8">error: ' + r.message + '</td></tr>';
                return;
            }

            // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            allRequests = r.data;

            // æ¤œç´¢ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
            updateSearchOptions();

            // æ¤œç´¢ã‚’å®Ÿè¡Œ
            filterRequests();


        }

        // æ¸¡ã—é¡ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        async function updateCashGiven(requestId) {
            const input = document.getElementById(`cash_given_${requestId}`);
            const amount = parseFloat(input.value) || 0;

            try {
                const r = await fetch(`/index.php?path=/api/requests/${requestId}/cash`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cash_given: amount })
                });
                const j = await r.json();
                if (!j.ok) {
                    alert('æ¸¡ã—é¡ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + j.message);
                    return;
                }
                // æˆåŠŸæ™‚ã¯ç‰¹ã«é€šçŸ¥ã—ãªã„ï¼ˆå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ãŒãã®ã¾ã¾æ®‹ã‚‹ï¼‰
            } catch (error) {
                console.error('Update cash given error:', error);
                alert('æ¸¡ã—é¡ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ç·¨é›†æ©Ÿèƒ½
        function editDept(id, name) {
            const newName = prompt('éƒ¨ç½²åã‚’ç·¨é›†:', name);
            if (newName && newName !== name) {
                fetch('/index.php?path=/api/masters/department', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, name: newName })
                }).then(r => r.json()).then(j => {
                    if (!j.ok) return alert(j.message);
                    alert('éƒ¨ç½²ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    load();
                });
            }
        }

        function editMember(id, name, departmentId) {
            const newName = prompt('å½¹å“¡åã‚’ç·¨é›†:', name);
            if (newName && newName !== name) {
                fetch('/index.php?path=/api/masters/member', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, name: newName, department_id: departmentId })
                }).then(r => r.json()).then(j => {
                    if (!j.ok) return alert(j.message);
                    alert('å½¹å“¡ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    load();
                });
            }
        }

        function editEvent(id, name) {
            const newName = prompt('è¡Œäº‹åã‚’ç·¨é›†:', name);
            if (newName && newName !== name) {
                fetch('/index.php?path=/api/masters/event', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, name: newName })
                }).then(r => r.json()).then(j => {
                    if (!j.ok) return alert(j.message);
                    alert('è¡Œäº‹ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    load();
                });
            }
        }

        function editPeriod(id, name) {
            const newName = prompt('æœŸé–“åã‚’ç·¨é›†:', name);
            if (newName && newName !== name) {
                fetch('/index.php?path=/api/masters/accounting-period', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, name: newName })
                }).then(r => r.json()).then(j => {
                    if (!j.ok) return alert(j.message);
                    alert('æœŸé–“ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    load();
                });
            }
        }

        async function togglePeriodActive(id, newActive) {
            try {
                const r = await fetch('/index.php?path=/api/masters/accounting-period', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id, is_active: newActive })
                });
                const j = await r.json();
                if (!j.ok) return alert(j.message);
                load();
            } catch (error) {
                console.error('Toggle period active error:', error);
                alert('çŠ¶æ…‹ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        async function deletePeriod(id, name) {
            if (!confirm(`è¨ˆä¸ŠæœŸé–“ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            try {
                const r = await fetch('/index.php?path=/api/masters/accounting-period', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', id: id })
                });
                const j = await r.json();
                if (!j.ok) return alert(j.message);
                alert('è¨ˆä¸ŠæœŸé–“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                load();
            } catch (error) {
                console.error('Delete period error:', error);
                alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // å‰Šé™¤é–¢æ•°
        async function deleteDepartment(id, name) {
            if (!confirm(`éƒ¨ç½²ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            const r = await fetch('/index.php?path=/api/masters/department', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'delete', id: id })
            });
            const j = await r.json();
            if (!j.ok) return alert(j.message);
            alert('éƒ¨ç½²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            load();
        }

        async function deleteMember(id, name) {
            if (!confirm(`å½¹å“¡ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            const r = await fetch('/index.php?path=/api/masters/member', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'delete', id: id })
            });
            const j = await r.json();
            if (!j.ok) return alert(j.message);
            alert('å½¹å“¡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            load();
        }

        function deleteEvent(id, name) {
            if (!confirm(`è¡Œäº‹ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            fetch('/index.php?path=/api/masters/event', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'delete', id: id })
            }).then(r => r.json()).then(j => {
                if (!j.ok) return alert(j.message);
                alert('è¡Œäº‹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                load();
            }).catch(e => {
                console.error('Delete event error:', e);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
        }

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜ã™ã‚‹ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆè¤‡æ•°ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã«å¯¾å¿œï¼‰
        let scrollPositionStack = [];

        // æ—¥ä»˜æ¡ä»¶ã¨è¨ˆä¸ŠæœŸé–“ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getReceiptDateParams() {
            const startDate = document.getElementById('receipt_start_date').value;
            const endDate = document.getElementById('receipt_end_date').value;
            const accountingPeriodId = document.getElementById('receipt_accounting_period').value;
            const params = new URLSearchParams();
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (accountingPeriodId) params.append('accounting_period_id', accountingPeriodId);
            return params.toString();
        }

        // æ—¥ä»˜æ¡ä»¶ã¨è¨ˆä¸ŠæœŸé–“ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
        window.clearReceiptDateFilter = function () {
            document.getElementById('receipt_start_date').value = '';
            document.getElementById('receipt_end_date').value = '';
            document.getElementById('receipt_accounting_period').value = '';
            // è¡Œäº‹ãƒã‚¹ã‚¿ã®ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
            load();
        };

        // è¡Œäº‹ã®ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§è¡¨ç¤º
        function viewEventReceipts(eventId, eventName) {
            // ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«ä¿å­˜
            scrollPositionStack.push(window.pageYOffset || document.documentElement.scrollTop);

            // æ—¥ä»˜æ¡ä»¶ã‚’å–å¾—
            const dateParams = getReceiptDateParams();
            const dateInfo = dateParams ? ` (æ—¥ä»˜æ¡ä»¶: ${document.getElementById('receipt_start_date').value || 'é–‹å§‹æ—¥ãªã—'} ï½ ${document.getElementById('receipt_end_date').value || 'çµ‚äº†æ—¥ãªã—'})` : '';

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆãƒ»è¡¨ç¤º
            const modal = document.createElement('div');
            modal.id = 'eventReceiptModal';
            modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
        align-items: center; justify-content: center;
    `;

            modal.innerHTML = `
        <div style="background: var(--bg-primary, white); padding: 20px; border-radius: 8px; max-width: 800px; max-height: 80vh; overflow-y: auto; color: var(--text-color, #333);">
            <h3 style="color: var(--text-color, #333);">${eventName} - ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§${dateInfo}</h3>
            <div id="eventReceiptList"></div>
            <div style="margin-top: 15px; text-align: right;">
                <button onclick="closeEventReceiptModal()" class="btn-secondary">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    `;

            document.body.appendChild(modal);

            // ãƒšãƒ¼ã‚¸ã®ä¸Šéƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’å–å¾—
            const url = `/index.php?path=/api/events/${eventId}/receipts${dateParams ? '&' + dateParams : ''}`;
            fetch(url)
                .then(r => r.json())
                .then(j => {
                    const receiptList = document.getElementById('eventReceiptList');
                    if (!j.ok || j.data.length === 0) {
                        receiptList.innerHTML = '<p>ãƒ¬ã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
                        return;
                    }

                    receiptList.innerHTML = j.data.map(receipt => `
                <div class="receipt-item" style="margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <strong>${receipt.kind}</strong> - Â¥${parseFloat(receipt.total).toLocaleString()}
                            ${receipt.change_returned > 0 ? ' (ãŠé‡£ã‚Š: Â¥' + parseFloat(receipt.change_returned).toLocaleString() + ')' : ''}
                        </div>
                        <div style="margin-left: 10px;">
                            <span style="font-size: 11px; color: #666; background-color: #f0f0f0; padding: 2px 6px; border-radius: 3px;">
                                ${receipt.receipt_no || 'æœªè¨­å®š'}
                            </span>
                        </div>
                    </div>
                    <div class="receipt-details" style="margin-top: 8px; padding: 6px; background-color: var(--bg-secondary, #f5f5f5); border: 1px solid var(--border-color, #e0e0e0); border-radius: 3px; font-size: 12px; color: var(--text-color, #333);">
                        <div class="receipt-detail-row" style="margin-bottom: 3px; display: flex; align-items: center;">
                            <label style="min-width: 60px; font-weight: bold; color: var(--text-muted, #666);">æ”¯æ‰•æ—¥:</label>
                            <span style="color: var(--text-color, #333);">${receipt.taken_at}</span>
                        </div>
                        ${receipt.subject ? `
                        <div class="receipt-detail-row" style="margin-bottom: 3px; display: flex; align-items: center;">
                            <label style="min-width: 60px; font-weight: bold; color: var(--text-muted, #666);">ç§‘ç›®:</label>
                            <span style="color: var(--text-color, #333);">${receipt.subject}</span>
                        </div>` : ''}
                        ${receipt.purpose ? `
                        <div class="receipt-detail-row" style="margin-bottom: 3px; display: flex; align-items: center;">
                            <label style="min-width: 60px; font-weight: bold; color: var(--text-muted, #666);">è³¼å…¥ç›®çš„:</label>
                            <span style="color: var(--text-color, #333);">${receipt.purpose}</span>
                        </div>` : ''}
                        ${receipt.payer ? `
                        <div class="receipt-detail-row" style="margin-bottom: 3px; display: flex; align-items: center;">
                            <label style="min-width: 60px; font-weight: bold; color: var(--text-muted, #666);">æ”¯æ‰•ã„è€…:</label>
                            <span style="color: var(--text-color, #333);">${receipt.payer}</span>
                        </div>` : ''}
                        ${receipt.receipt_date ? `
                        <div class="receipt-detail-row" style="margin-bottom: 3px; display: flex; align-items: center;">
                            <label style="min-width: 60px; font-weight: bold; color: var(--text-muted, #666);">ãƒ¬ã‚·ãƒ¼ãƒˆæ—¥ä»˜:</label>
                            <span style="color: var(--text-color, #333);">${receipt.receipt_date}</span>
                        </div>` : ''}
                        ${receipt.memo ? `
                        <div class="receipt-detail-row" style="margin-bottom: 3px; display: flex; align-items: center;">
                            <label style="min-width: 60px; font-weight: bold; color: var(--text-muted, #666);">ãƒ¡ãƒ¢:</label>
                            <span style="color: var(--text-color, #333);">${receipt.memo}</span>
                        </div>` : ''}
                    </div>
                </div>
            `).join('');
                })
                .catch(error => {
                    console.error('è¡Œäº‹ãƒ¬ã‚·ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    document.getElementById('eventReceiptList').innerHTML = '<p>ãƒ¬ã‚·ãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
                });
        }

        function closeEventReceiptModal() {
            const modal = document.getElementById('eventReceiptModal');
            if (modal) {
                modal.remove();
                // ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰æœ€å¾Œã®ä½ç½®ã‚’å–å¾—ã—ã¦å…ƒã®ä½ç½®ã«æˆ»ã‚‹
                if (scrollPositionStack.length > 0) {
                    const position = scrollPositionStack.pop();
                    window.scrollTo({ top: position, behavior: 'smooth' });
                }
            }
        }

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–¢é€£ã®é–¢æ•°
        function downloadBackup(filename) {
            window.open(`/index.php?path=/api/backups/download&file=${encodeURIComponent(filename)}`, '_blank');
        }

        async function deleteBackup(filename) {
            if (!confirm(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€Œ${filename}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            try {
                // ã¾ãšèªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
                const authResponse = await fetch('/index.php?path=/api/auth/check');
                const authData = await authResponse.json();

                if (!authData.ok) {
                    alert('èªè¨¼ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚');
                    window.location.href = '/pages/login.html';
                    return;
                }

                console.log('Auth check passed, proceeding with delete');

                const response = await fetch('/index.php?path=/api/backups/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename })
                });

                console.log('Delete response status:', response.status);
                console.log('Delete response headers:', response.headers);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Delete error response:', errorText);
                    alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ' + response.status);
                    return;
                }

                const data = await response.json();
                if (!data.ok) {
                    alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.message);
                    return;
                }

                alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
                // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                loadBackups();

            } catch (error) {
                console.error('Backup delete error:', error);
                alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function restoreBackup(filename) {
            if (!confirm(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€Œ${filename}ã€ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\n\næ³¨æ„: ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚å¾©å…ƒå‰ã«è‡ªå‹•çš„ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒä½œæˆã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }

            try {
                // ã¾ãšèªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
                const authResponse = await fetch('/index.php?path=/api/auth/check');
                const authData = await authResponse.json();

                if (!authData.ok) {
                    alert('èªè¨¼ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚');
                    window.location.href = '/pages/login.html';
                    return;
                }

                console.log('Auth check passed, proceeding with restore');
                console.log('Restoring backup:', filename);

                const response = await fetch('/index.php?path=/api/backups/restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename })
                });

                console.log('Restore response status:', response.status);
                console.log('Restore response headers:', response.headers);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Restore error response:', errorText);
                    alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ' + response.status + '\nã‚¨ãƒ©ãƒ¼: ' + errorText);
                    return;
                }

                const data = await response.json();
                console.log('Restore response data:', data);

                if (!data.ok) {
                    alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.message);
                    return;
                }

                alert(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸã€‚\nå¾©å…ƒãƒ•ã‚¡ã‚¤ãƒ«: ${data.data.restored_file}\nå¾©å…ƒå‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: ${data.data.restore_backup}`);
                // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                loadRequests();
                loadBackups();

            } catch (error) {
                console.error('Backup restore error:', error);
                alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å¾©å…ƒä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
        async function loadBackups() {
            try {
                const response = await fetch('/index.php?path=/api/backups');
                const data = await response.json();

                if (!data.ok) {
                    console.error('Failed to load backups:', data.message);
                    return;
                }

                // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆæ—¢å­˜ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ã‚¨ãƒªã‚¢ãŒã‚ã‚‹å ´åˆï¼‰
                const backupList = document.getElementById('backup_list');
                if (backupList) {
                    if (data.data.length === 0) {
                        backupList.innerHTML = '<p>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
                        return;
                    }

                    backupList.innerHTML = data.data.map(backup => `
                <div class="backup-item" style="margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${backup.filename}</strong><br/>
                            <small style="color: #666;">ä½œæˆæ—¥æ™‚: ${backup.created_at}</small><br/>
                            <small style="color: #666;">ã‚µã‚¤ã‚º: ${(backup.size / 1024).toFixed(2)} KB</small>
                        </div>
                        <div>
                            <button onclick="downloadBackup('${backup.filename}')" class="btn-info">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                            <button onclick="restoreBackup('${backup.filename}')" class="btn-success">å¾©å…ƒ</button>
                            <button onclick="deleteBackup('${backup.filename}')" class="btn-danger">å‰Šé™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
                }

            } catch (error) {
                console.error('Load backups error:', error);
            }
        }

        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾©å…ƒæ©Ÿèƒ½
        async function uploadAndRestore() {
            const fileInput = document.getElementById('backup_upload');
            const file = fileInput.files[0];

            if (!file) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (!file.name.endsWith('.sql')) {
                alert('SQLãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (!confirm(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\n\næ³¨æ„: ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚å¾©å…ƒå‰ã«è‡ªå‹•çš„ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒä½œæˆã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }

            const uploadButton = document.getElementById('upload_restore');
            const originalText = uploadButton.textContent;
            uploadButton.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
            uploadButton.disabled = true;

            try {
                // ã¾ãšèªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
                const authResponse = await fetch('/index.php?path=/api/auth/check');
                const authData = await authResponse.json();

                if (!authData.ok) {
                    alert('èªè¨¼ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚');
                    window.location.href = '/pages/login.html';
                    return;
                }

                // FormDataã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                const formData = new FormData();
                formData.append('backup_file', file);

                const response = await fetch('/index.php?path=/api/backups/upload-restore', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!data.ok) {
                    alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.message);
                    return;
                }

                alert(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸã€‚\nå¾©å…ƒãƒ•ã‚¡ã‚¤ãƒ«: ${data.data.uploaded_file}\nå¾©å…ƒå‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: ${data.data.restore_backup}`);

                // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                loadRequests();
                loadBackups();

                // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
                fileInput.value = '';

            } catch (error) {
                console.error('Upload restore error:', error);
                alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾©å…ƒä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                uploadButton.textContent = originalText;
                uploadButton.disabled = false;
            }
        }

        // ç®¡ç†è€…ç”¨ã‚¨ã‚¯ã‚»ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤º
        async function viewAdminExcel(id) {
            try {
                const r = await fetch(`/index.php?path=/api/requests/${id}/excel`);
                if (r.ok) {
                    const blob = await r.blob();
                    const url = URL.createObjectURL(blob);
                    window.open(url, '_blank');
                } else {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (e) {
                console.error('Excel view error:', e);
                alert('ã‚¨ã‚¯ã‚»ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        async function updateState(id) {
            const stateSelect = document.getElementById(`state_${id}`);
            const newState = stateSelect.value;
            if (!newState) return;

            const r = await fetch(`/index.php?path=/api/requests/${id}/state`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ next_state: newState })
            });
            const j = await r.json();
            if (!j.ok) {
                alert('çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + j.message);
                loadRequests();
                return;
            }
            alert('çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            loadRequests();
        }

        async function deleteRequest(id, requestNo) {
            if (!confirm(`ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€Œ${requestNo}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\næ³¨æ„: ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«é–¢é€£ã™ã‚‹ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒã‚„Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å«ã‚ã¦å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) return;

            try {
                // ãƒ¬ãƒ³ã‚¿ãƒ«ã‚µãƒ¼ãƒãƒ¼ã§ã¯DELETEãƒ¡ã‚½ãƒƒãƒ‰ãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€POSTãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
                const r = await fetch(`/index.php?path=/api/requests/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete' })
                });

                const j = await r.json();
                if (!j.ok) {
                    alert('ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + j.message);
                    return;
                }

                alert('ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                loadRequests(); // ä¸€è¦§ã‚’æ›´æ–°
            } catch (error) {
                console.error('Delete request error:', error);
                alert('ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ç®¡ç†è€…ç”¨ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§è¡¨ç¤º
        async function showAdminReceiptList(requestId) {
            try {
                console.log('Loading receipts for request ID:', requestId);

                const r = await fetch(`/index.php?path=/api/requests/${requestId}/receipts`);
                console.log('Receipts response status:', r.status);
                console.log('Receipts response headers:', Object.fromEntries(r.headers.entries()));

                if (!r.ok) {
                    const errorText = await r.text();
                    console.error('HTTP error:', r.status, errorText);
                    alert('ãƒ¬ã‚·ãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: HTTP ' + r.status);
                    return;
                }

                const j = await r.json();
                console.log('Receipts response JSON:', j);

                if (!j.ok) {
                    alert('ãƒ¬ã‚·ãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + j.message);
                    return;
                }

                // receiptListè¦ç´ ã®å­˜åœ¨ç¢ºèª
                const receiptList = document.getElementById('receiptList');
                if (!receiptList) {
                    console.error('receiptList element not found');
                    alert('ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ã®è¡¨ç¤ºã‚¨ãƒªã‚¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                console.log('receiptList element found');

                if (j.data.length === 0) {
                    receiptList.innerHTML = '<p>ãƒ¬ã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
                } else {
                    console.log('Rendering receipts:', j.data.length);
                    receiptList.innerHTML = j.data.map(receipt => `
                <div class="receipt-item" style="margin-bottom: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <strong>${receipt.kind}</strong> - Â¥${parseFloat(receipt.total).toLocaleString()}
                            ${receipt.change_returned > 0 ? ' (ãŠé‡£ã‚Š: Â¥' + parseFloat(receipt.change_returned).toLocaleString() + ')' : ''}
                        </div>
                        <div style="margin-left: 10px;">
                            <span style="font-size: 11px; color: #666; background-color: #f0f0f0; padding: 2px 6px; border-radius: 3px;">
                                ${receipt.receipt_no || 'æœªè¨­å®š'}
                            </span>
                        </div>
                    </div>
                    <div class="receipt-actions" style="margin-top: 8px; display: flex; gap: 8px;">
                        <button onclick="deleteAdminReceipt(${receipt.id}, ${requestId})" class="btn-danger">å‰Šé™¤</button>
                    </div>
                    <div class="receipt-details" style="margin-top: 8px; padding: 6px; background-color: var(--bg-secondary, #f5f5f5); border: 1px solid var(--border-color, #e0e0e0); border-radius: 3px; font-size: 12px; color: var(--text-color, #333);">
                        <div class="receipt-detail-row" style="margin-bottom: 3px; display: flex; align-items: center;">
                            <label style="min-width: 60px; font-weight: bold; color: var(--text-muted, #666);">æ”¯æ‰•æ—¥:</label>
                            <span style="color: var(--text-color, #333);">${receipt.taken_at}</span>
                        </div>
                        ${receipt.event_name ? `
                        <div class="receipt-detail-row" style="margin-bottom: 3px; display: flex; align-items: center;">
                            <label style="min-width: 60px; font-weight: bold; color: var(--text-muted, #666);">è¡Œäº‹:</label>
                            <span style="color: var(--text-color, #333);">${receipt.event_name}</span>
                        </div>` : ''}
                        ${receipt.subject ? `
                        <div class="receipt-detail-row" style="margin-bottom: 3px; display: flex; align-items: center;">
                            <label style="min-width: 60px; font-weight: bold; color: var(--text-muted, #666);">ç§‘ç›®:</label>
                            <span style="color: var(--text-color, #333);">${receipt.subject}</span>
                        </div>` : ''}
                        ${receipt.purpose ? `
                        <div class="receipt-detail-row" style="margin-bottom: 3px; display: flex; align-items: center;">
                            <label style="min-width: 60px; font-weight: bold; color: var(--text-muted, #666);">è³¼å…¥ç›®çš„:</label>
                            <span style="color: var(--text-color, #333);">${receipt.purpose}</span>
                        </div>` : ''}
                        ${receipt.payer ? `
                        <div class="receipt-detail-row" style="margin-bottom: 3px; display: flex; align-items: center;">
                            <label style="min-width: 60px; font-weight: bold; color: var(--text-muted, #666);">æ”¯æ‰•ã„è€…:</label>
                            <span style="color: var(--text-color, #333);">${receipt.payer}</span>
                        </div>` : ''}
                        ${receipt.receipt_date ? `
                        <div class="receipt-detail-row" style="margin-bottom: 3px; display: flex; align-items: center;">
                            <label style="min-width: 60px; font-weight: bold; color: var(--text-muted, #666);">ãƒ¬ã‚·ãƒ¼ãƒˆæ—¥ä»˜:</label>
                            <span style="color: var(--text-color, #333);">${receipt.receipt_date}</span>
                        </div>` : ''}
                        ${receipt.memo ? `
                        <div class="receipt-detail-row" style="margin-bottom: 3px; display: flex; align-items: center;">
                            <label style="min-width: 60px; font-weight: bold; color: var(--text-muted, #666);">ãƒ¡ãƒ¢:</label>
                            <span style="color: var(--text-color, #333);">${receipt.memo}</span>
                        </div>` : ''}
                    </div>
                </div>
            `).join('');
                }

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                const modal = document.getElementById('receiptListModal');
                if (modal) {
                    modal.classList.add('show');
                } else {
                    console.error('receiptListModal element not found');
                    alert('ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

            } catch (error) {
                console.error('Show admin receipt list error:', error);
                alert('ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°
        function closeReceiptListModal() {
            const modal = document.getElementById('receiptListModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // ç®¡ç†è€…ç”¨ãƒ¬ã‚·ãƒ¼ãƒˆå‰Šé™¤
        // ç®¡ç†è€…ç”¨ãƒ¬ã‚·ãƒ¼ãƒˆå‰Šé™¤
        async function deleteAdminReceipt(receiptId, requestId) {
            if (!confirm('ã“ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                console.log('Deleting receipt - Receipt ID:', receiptId, 'Request ID:', requestId);

                // ãƒ¬ãƒ³ã‚¿ãƒ«ã‚µãƒ¼ãƒãƒ¼ã§ã¯DELETEãƒ¡ã‚½ãƒƒãƒ‰ãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€POSTãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
                const r = await fetch(`/index.php?path=/api/requests/${requestId}/receipt`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'delete',
                        receipt_id: receiptId
                    })
                });

                console.log('Delete response status:', r.status);
                console.log('Delete response headers:', Object.fromEntries(r.headers.entries()));

                if (!r.ok) {
                    const errorText = await r.text();
                    console.error('HTTP error:', r.status, errorText);
                    alert('ãƒ¬ã‚·ãƒ¼ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: HTTP ' + r.status);
                    return;
                }

                const j = await r.json();
                console.log('Delete response JSON:', j);

                if (!j.ok) {
                    alert('ãƒ¬ã‚·ãƒ¼ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + j.message);
                    return;
                }

                alert('ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                showAdminReceiptList(requestId); // ä¸€è¦§ã‚’æ›´æ–°

            } catch (error) {
                console.error('Delete receipt error:', error);
                alert('ãƒ¬ã‚·ãƒ¼ãƒˆã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }


        // ç®¡ç†è€…ç”¨ãƒ¬ã‚·ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeAdminReceiptModal() {
            const modal = document.getElementById('adminReceiptModal');
            if (modal) {
                modal.remove();
            }
        }

        // ç®¡ç†è€…ãƒšãƒ¼ã‚¸ç”¨ã®å‡¦ç†æ¸ˆã¿é¡å–å¾—é–¢æ•°
        async function loadAdminProcessedAmount(requestId) {
            try {
                const r = await fetch(`/index.php?path=/api/requests/${requestId}/receipts`);
                const j = await r.json();
                if (j.ok) {
                    const totalAmount = j.data.reduce((sum, receipt) => sum + parseFloat(receipt.total), 0);
                    const processedElement = document.getElementById(`admin_processed_amount_${requestId}`);
                    if (processedElement) {
                        processedElement.textContent = 'Â¥' + totalAmount.toLocaleString();
                    }
                }
            } catch (e) {
                console.error('Failed to load processed amount:', e);
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
        async function logout() {
            try {
                await fetch('/index.php?path=/api/auth/logout', { method: 'POST' });
                location.href = '/pages/login.html';
            } catch (e) {
                console.error('Logout failed:', e);
                location.href = '/pages/login.html';
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('DOMContentLoaded', function () {
            // æ¤œç´¢æ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('searchRequestNo').addEventListener('input', () => {
                updateSearchOptions();
                filterRequests();
            });
            document.getElementById('searchMember').addEventListener('change', filterRequests);
            document.getElementById('searchDepartment').addEventListener('change', () => {
                updateMemberOptionsOnDepartmentChange();
                filterRequests();
            });
            document.getElementById('searchSummary').addEventListener('change', filterRequests);
            document.getElementById('clearSearch').addEventListener('click', clearSearch);

            // ãƒ¬ã‚·ãƒ¼ãƒˆæ—¥ä»˜æ¡ä»¶ã¨è¨ˆä¸ŠæœŸé–“ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const receiptStartDate = document.getElementById('receipt_start_date');
            const receiptEndDate = document.getElementById('receipt_end_date');
            const receiptAccountingPeriod = document.getElementById('receipt_accounting_period');
            if (receiptStartDate) {
                receiptStartDate.addEventListener('change', () => {
                    // è¡Œäº‹ãƒã‚¹ã‚¿ã®ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    load();
                });
            }
            if (receiptEndDate) {
                receiptEndDate.addEventListener('change', () => {
                    // è¡Œäº‹ãƒã‚¹ã‚¿ã®ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    load();
                });
            }
            if (receiptAccountingPeriod) {
                receiptAccountingPeriod.addEventListener('change', () => {
                    // è¡Œäº‹ãƒã‚¹ã‚¿ã®ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    load();
                });
            }

            // çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.querySelectorAll('.state-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    updateSearchOptions();
                    filterRequests();
                });
            });
            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¤œç´¢æœŸé–“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
            const today = new Date();
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(today.getMonth() - 1);

            // æ—¥ä»˜ã‚’YYYY-MM-DDå½¢å¼ã«å¤‰æ›
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            document.getElementById('backup_start_date').value = formatDate(oneMonthAgo);
            document.getElementById('backup_end_date').value = formatDate(today);

            // åˆæœŸèª­ã¿è¾¼ã¿
            console.log('=== DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆé–‹å§‹ ===');
            console.log('load()ã‚’å‘¼ã³å‡ºã—');
            load();
            console.log('loadRequests()ã‚’å‘¼ã³å‡ºã—');
            loadRequests();
            console.log('loadFundData()ã‚’å‘¼ã³å‡ºã—ï¼ˆé…å»¶å®Ÿè¡Œï¼‰');
            // DOMè¦ç´ ãŒç¢ºå®Ÿã«æº–å‚™ã§ãã¦ã‹ã‚‰å®Ÿè¡Œ
            setTimeout(() => {
                console.log('setTimeoutå†…ã§loadFundData()ã‚’å®Ÿè¡Œ');
                loadFundData();
            }, 100);
            console.log('=== DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆçµ‚äº† ===');

            // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('dep_add').onclick = async () => {
                const name = document.getElementById('dep_name').value.trim();
                if (!name) return;
                const r = await fetch('/index.php?path=/api/masters/department', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                const j = await r.json();
                if (!j.ok) return alert(j.message);
                document.getElementById('dep_name').value = '';
                load();
            };

            document.getElementById('member_add').onclick = async () => {
                const name = document.getElementById('member_name').value.trim();
                const departmentId = document.getElementById('member_department').value;
                if (!name || !departmentId) return alert('å½¹å“¡åã¨éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„');
                const r = await fetch('/index.php?path=/api/masters/member', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, department_id: parseInt(departmentId) })
                });
                const j = await r.json();
                if (!j.ok) return alert(j.message);
                document.getElementById('member_name').value = '';
                document.getElementById('member_department').value = '';
                load();
            };

            document.getElementById('event_add').onclick = async () => {
                const name = document.getElementById('event_name').value.trim();
                if (!name) return alert('è¡Œäº‹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                try {
                    const r = await fetch('/index.php?path=/api/masters/event', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });
                    const j = await r.json();
                    if (!j.ok) {
                        alert(`è¡Œäº‹ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ${j.message}`);
                        return;
                    }
                    document.getElementById('event_name').value = '';
                    load();
                } catch (error) {
                    console.error('è¡Œäº‹è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                    alert('è¡Œäº‹ã®è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                }
            };

            document.getElementById('period_add').onclick = async () => {
                const name = document.getElementById('period_name').value.trim();
                if (!name) return alert('æœŸé–“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                try {
                    const r = await fetch('/index.php?path=/api/masters/accounting-period', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, is_active: 0 })
                    });
                    const j = await r.json();
                    if (!j.ok) {
                        alert(`æœŸé–“ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ${j.message}`);
                        return;
                    }
                    document.getElementById('period_name').value = '';
                    load();
                } catch (error) {
                    console.error('æœŸé–“è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                    alert('æœŸé–“ã®è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                }
            };

            document.getElementById('reload_requests').onclick = loadRequests;

            // ç§‘ç›®åˆ¥åˆè¨ˆé‡‘é¡è¡¨ç¤ºé–¢æ•°
            window.showEventSubjectBreakdown = async function (eventId, eventName) {
                // ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«ä¿å­˜
                scrollPositionStack.push(window.pageYOffset || document.documentElement.scrollTop);

                const modal = document.getElementById('subjectBreakdownModal');
                const title = document.getElementById('subjectBreakdownTitle');
                const content = document.getElementById('subjectBreakdownContent');

                // æ—¥ä»˜æ¡ä»¶ã‚’å–å¾—
                const dateParams = getReceiptDateParams();
                const dateInfo = dateParams ? ` (æ—¥ä»˜æ¡ä»¶: ${document.getElementById('receipt_start_date').value || 'é–‹å§‹æ—¥ãªã—'} ï½ ${document.getElementById('receipt_end_date').value || 'çµ‚äº†æ—¥ãªã—'})` : '';

                title.textContent = `${eventName} - ç§‘ç›®åˆ¥åˆè¨ˆé‡‘é¡${dateInfo}`;
                content.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
                modal.style.display = 'block';

                // ãƒšãƒ¼ã‚¸ã®ä¸Šéƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                window.scrollTo({ top: 0, behavior: 'smooth' });

                try {
                    const url = `/index.php?path=/api/events/${eventId}/subject-breakdown${dateParams ? '&' + dateParams : ''}`;
                    const response = await fetch(url);
                    const result = await response.json();

                    if (!result.ok) {
                        content.innerHTML = `<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ${result.message}</p>`;
                        return;
                    }

                    if (result.data.length === 0) {
                        content.innerHTML = '<p>ã“ã®è¡Œäº‹ã«é–¢é€£ã™ã‚‹ãƒ¬ã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                        return;
                    }

                    // ç§‘ç›®åˆ¥åˆè¨ˆã‚’è¡¨ç¤º
                    const breakdownHtml = `
                <div style="margin-bottom: 20px;">
                    <h4>ç§‘ç›®åˆ¥åˆè¨ˆé‡‘é¡</h4>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <thead>
                            <tr style="background-color: var(--bg-secondary, #f5f5f5);">
                                <th style="padding: 8px; border: 1px solid var(--border, #ddd); text-align: left;">ç§‘ç›®å</th>
                                <th style="padding: 8px; border: 1px solid var(--border, #ddd); text-align: right;">åˆè¨ˆé‡‘é¡</th>
                                <th style="padding: 8px; border: 1px solid var(--border, #ddd); text-align: center;">ä»¶æ•°</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.data.map(item => `
                                <tr>
                                    <td style="padding: 8px; border: 1px solid var(--border, #ddd);">${item.subject || 'æœªè¨­å®š'}</td>
                                    <td style="padding: 8px; border: 1px solid var(--border, #ddd); text-align: right; font-weight: bold;">Â¥${parseFloat(item.total_amount).toLocaleString()}</td>
                                    <td style="padding: 8px; border: 1px solid var(--border, #ddd); text-align: center;">
                                        <button onclick="showSubjectReceipts(${eventId}, '${item.subject || 'æœªè¨­å®š'}')" 
                                                style="background: none; border: none; cursor: pointer; color: var(--brand, #007bff); text-decoration: underline; padding: 0;">
                                            ${item.count}ä»¶
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

                    content.innerHTML = breakdownHtml;

                } catch (error) {
                    console.error('Subject breakdown error:', error);
                    content.innerHTML = '<p style="color: red;">ç§‘ç›®åˆ¥åˆè¨ˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>';
                }
            };

            // ç§‘ç›®åˆ¥åˆè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°
            window.closeSubjectBreakdownModal = function () {
                document.getElementById('subjectBreakdownModal').style.display = 'none';
                // ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰æœ€å¾Œã®ä½ç½®ã‚’å–å¾—ã—ã¦å…ƒã®ä½ç½®ã«æˆ»ã‚‹
                if (scrollPositionStack.length > 0) {
                    const position = scrollPositionStack.pop();
                    window.scrollTo({ top: position, behavior: 'smooth' });
                }
            };

            // ç§‘ç›®åˆ¥ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§è¡¨ç¤ºé–¢æ•°
            window.showSubjectReceipts = async function (eventId, subject) {
                // ç§‘ç›®åˆ¥åˆè¨ˆé‡‘é¡ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹å ´åˆã€ç¾åœ¨ã®ä½ç½®ï¼ˆãƒšãƒ¼ã‚¸ä¸Šéƒ¨ï¼‰ã‚’ä¿å­˜ã™ã‚‹å¿…è¦ã¯ãªã„
                // ã‚¹ã‚¿ãƒƒã‚¯ã®æœ€å¾Œã®ä½ç½®ï¼ˆç§‘ç›®åˆ¥åˆè¨ˆé‡‘é¡ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸæ™‚ã®ä½ç½®ï¼‰ã‚’ä¿æŒã™ã‚‹ãŸã‚ã€ä½•ã‚‚ã—ãªã„

                const modal = document.getElementById('subjectReceiptsModal');
                const title = document.getElementById('subjectReceiptsTitle');
                const content = document.getElementById('subjectReceiptsContent');

                // æ—¥ä»˜æ¡ä»¶ã‚’å–å¾—
                const dateParams = getReceiptDateParams();
                const dateInfo = dateParams ? ` (æ—¥ä»˜æ¡ä»¶: ${document.getElementById('receipt_start_date').value || 'é–‹å§‹æ—¥ãªã—'} ï½ ${document.getElementById('receipt_end_date').value || 'çµ‚äº†æ—¥ãªã—'})` : '';

                title.textContent = `ç§‘ç›®: ${subject} - ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§${dateInfo}`;
                content.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
                modal.style.display = 'block';

                // ãƒšãƒ¼ã‚¸ã®ä¸Šéƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                window.scrollTo({ top: 0, behavior: 'smooth' });

                try {
                    // æŒ‡å®šã•ã‚ŒãŸè¡Œäº‹ã¨ç§‘ç›®ã®ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’å–å¾—
                    const url = `/index.php?path=/api/events/${eventId}/receipts?subject=${encodeURIComponent(subject)}${dateParams ? '&' + dateParams : ''}`;
                    const response = await fetch(url);
                    const result = await response.json();

                    if (!result.ok) {
                        content.innerHTML = `<div style="color: red; text-align: center; padding: 20px;">ã‚¨ãƒ©ãƒ¼: ${result.message}</div>`;
                        return;
                    }

                    if (!result.data || result.data.length === 0) {
                        content.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--muted);">è©²å½“ã™ã‚‹ãƒ¬ã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
                        return;
                    }

                    // ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’è¡¨ç¤º
                    const receiptsHtml = `
                <div style="margin-bottom: 20px;">
                    <h4>ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ (${result.data.length}ä»¶)</h4>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <thead>
                            <tr style="background-color: var(--bg-secondary, #f5f5f5);">
                                <th style="padding: 8px; border: 1px solid var(--border, #ddd); text-align: left;">ãƒ¬ã‚·ãƒ¼ãƒˆç•ªå·</th>
                                <th style="padding: 8px; border: 1px solid var(--border, #ddd); text-align: left;">ç§‘ç›®</th>
                                <th style="padding: 8px; border: 1px solid var(--border, #ddd); text-align: left;">è³¼å…¥ç›®çš„</th>
                                <th style="padding: 8px; border: 1px solid var(--border, #ddd); text-align: right;">é‡‘é¡</th>
                                <th style="padding: 8px; border: 1px solid var(--border, #ddd); text-align: left;">æ”¯æ‰•ã„è€…</th>
                                <th style="padding: 8px; border: 1px solid var(--border, #ddd); text-align: center;">æ—¥ä»˜</th>
                                <th style="padding: 8px; border: 1px solid var(--border, #ddd); text-align: center;">è¨˜å…¥çŠ¶æ³</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.data.map(receipt => `
                                <tr>
                                    <td style="padding: 8px; border: 1px solid var(--border, #ddd);">${receipt.receipt_no || 'æœªè¨­å®š'}</td>
                                    <td style="padding: 8px; border: 1px solid var(--border, #ddd);">${receipt.subject || 'æœªè¨­å®š'}</td>
                                    <td style="padding: 8px; border: 1px solid var(--border, #ddd);">${receipt.purpose || '-'}</td>
                                    <td style="padding: 8px; border: 1px solid var(--border, #ddd); text-align: right; font-weight: bold;">Â¥${parseFloat(receipt.total).toLocaleString()}</td>
                                    <td style="padding: 8px; border: 1px solid var(--border, #ddd);">${receipt.payer || '-'}</td>
                                    <td style="padding: 8px; border: 1px solid var(--border, #ddd); text-align: center;">${receipt.receipt_date || '-'}</td>
                                    <td style="padding: 8px; border: 1px solid var(--border, #ddd); text-align: center;">
                                        ${receipt.is_completed ? '<span style="color: green;">âœ“ è¨˜å…¥æ¸ˆã¿</span>' : '<span style="color: orange;">â—‹ æœªè¨˜å…¥</span>'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

                    content.innerHTML = receiptsHtml;

                } catch (error) {
                    console.error('ç§‘ç›®åˆ¥ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    content.innerHTML = '<div style="color: red; text-align: center; padding: 20px;">ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
                }
            };

            // ç§‘ç›®åˆ¥ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°
            window.closeSubjectReceiptsModal = function () {
                document.getElementById('subjectReceiptsModal').style.display = 'none';
                // ç§‘ç›®åˆ¥åˆè¨ˆé‡‘é¡ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã¾ã é–‹ã„ã¦ã„ã‚‹ãŸã‚ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã¯å¤‰æ›´ã—ãªã„
                // ç§‘ç›®åˆ¥åˆè¨ˆé‡‘é¡ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ãŸæ™‚ã«å…ƒã®ä½ç½®ã«æˆ»ã‚‹
            };

            // å‡¦ç†æ¸ˆã¿é¡å†è¨ˆç®—ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('recalculate_processed_amounts').onclick = async () => {
                if (!confirm('å…¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†æ¸ˆã¿é¡ã‚’å†è¨ˆç®—ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®å‡¦ç†ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚')) {
                    return;
                }

                const button = document.getElementById('recalculate_processed_amounts');
                const originalText = button.textContent;
                button.textContent = 'å†è¨ˆç®—ä¸­...';
                button.disabled = true;

                try {
                    const response = await fetch('/index.php?path=/api/requests/recalculate-processed-amounts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const result = await response.json();

                    if (!result.ok) {
                        alert('å‡¦ç†æ¸ˆã¿é¡ã®å†è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
                        return;
                    }

                    alert(`å‡¦ç†æ¸ˆã¿é¡ã®å†è¨ˆç®—ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\næ›´æ–°ä»¶æ•°: ${result.data.updated_count}ä»¶\nã‚¨ãƒ©ãƒ¼ä»¶æ•°: ${result.data.error_count}ä»¶`);

                    // ä¸€è¦§ã‚’æ›´æ–°
                    loadRequests();

                } catch (error) {
                    console.error('Recalculate processed amounts error:', error);
                    alert('å‡¦ç†æ¸ˆã¿é¡ã®å†è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                } finally {
                    button.textContent = originalText;
                    button.disabled = false;
                }
            };

            // ã‚¨ã‚¯ã‚»ãƒ«ä¸€æ‹¬ç™»éŒ²æ©Ÿèƒ½ã‚’è¿½åŠ 
            document.getElementById('bulk_upload').onclick = async () => {
                const fileInput = document.getElementById('excel_file');
                const file = fileInput.files[0];
                if (!file) {
                    alert('ã‚¨ã‚¯ã‚»ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }

                const formData = new FormData();
                formData.append('excel', file);

                try {
                    const r = await fetch('/index.php?path=/api/masters/bulk-upload', {
                        method: 'POST',
                        body: formData
                    });
                    const j = await r.json();
                    if (!j.ok) {
                        alert('ä¸€æ‹¬ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + j.message);
                        return;
                    }

                    document.getElementById('bulk_result').innerHTML = `
            <div style="margin:10px 0; padding:10px; background:#f0f8ff; border:1px solid #ccc;">
            <h4>ç™»éŒ²çµæœ</h4>
            <p>éƒ¨ç½²: ${j.data.departments_created}ä»¶è¿½åŠ </p>
            <p>å½¹å“¡: ${j.data.members_created}ä»¶è¿½åŠ </p>
            <p>ã‚¨ãƒ©ãƒ¼: ${j.data.errors.length}ä»¶</p>
            ${j.data.errors.length > 0 ? '<p style="color:red;">ã‚¨ãƒ©ãƒ¼è©³ç´°: ' + j.data.errors.join(', ') + '</p>' : ''}
            </div>
            `;

                    // ä¸€è¦§ã‚’æ›´æ–°
                    load();
                    fileInput.value = '';
                } catch (e) {
                    console.error('Bulk upload error:', e);
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            };

            // ãƒã‚¹ã‚¿ã‚¯ãƒªã‚¢æ©Ÿèƒ½ã‚’è¿½åŠ 
            document.getElementById('clear_departments').onclick = async () => {
                if (!confirm('éƒ¨ç½²ãƒã‚¹ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) return;

                // å‰Šé™¤ä¸­è¡¨ç¤ºã‚’é–‹å§‹
                const clearButton = document.getElementById('clear_departments');
                const originalText = clearButton.textContent;
                clearButton.textContent = 'å‰Šé™¤ä¸­...';
                clearButton.disabled = true;

                try {
                    // éƒ¨ç½²ã«é–¢é€£ã™ã‚‹å½¹å“¡ãŒã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const membersResponse = await fetch('/index.php?path=/api/masters/members');
                    const membersResult = await membersResponse.json();
                    if (membersResult.ok && membersResult.data.length > 0) {
                        if (!confirm('éƒ¨ç½²ã«é–¢é€£ã™ã‚‹å½¹å“¡ãŒå­˜åœ¨ã—ã¾ã™ã€‚å½¹å“¡ã‚‚ä¸€ç·’ã«å‰Šé™¤ã•ã‚Œã¾ã™ãŒã€ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                            clearButton.textContent = originalText;
                            clearButton.disabled = false;
                            return;
                        }
                    }

                    // éƒ¨ç½²ã‚’å‰Šé™¤ï¼ˆé–¢é€£ã™ã‚‹å½¹å“¡ã‚‚è‡ªå‹•å‰Šé™¤ã•ã‚Œã‚‹ï¼‰
                    const depsResponse = await fetch('/index.php?path=/api/masters/departments');
                    const depsResult = await depsResponse.json();
                    if (depsResult.ok) {
                        const totalDeps = depsResult.data.length;
                        for (let i = 0; i < depsResult.data.length; i++) {
                            const dep = depsResult.data[i];
                            clearButton.textContent = `å‰Šé™¤ä¸­... (${i + 1}/${totalDeps})`;

                            console.log('Deleting department:', dep.id, dep.name);

                            const deleteResponse = await fetch('/index.php?path=/api/masters/department', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ action: 'delete', id: dep.id })
                            });

                            console.log('Delete response status:', deleteResponse.status);
                            const deleteResult = await deleteResponse.json();
                            console.log('Delete result:', deleteResult);

                            if (!deleteResult.ok) {
                                console.error('Failed to delete department:', dep.id, deleteResult.message);
                            }
                        }
                    }
                    alert('éƒ¨ç½²ãƒã‚¹ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
                    load(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                } catch (error) {
                    console.error('éƒ¨ç½²ãƒã‚¹ã‚¿ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
                    alert('éƒ¨ç½²ãƒã‚¹ã‚¿ã‚¯ãƒªã‚¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                } finally {
                    // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                    clearButton.textContent = originalText;
                    clearButton.disabled = false;
                }
            };

            document.getElementById('clear_members').onclick = async () => {
                if (!confirm('å½¹å“¡ãƒã‚¹ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) return;

                // å‰Šé™¤ä¸­è¡¨ç¤ºã‚’é–‹å§‹
                const clearButton = document.getElementById('clear_members');
                const originalText = clearButton.textContent;
                clearButton.textContent = 'å‰Šé™¤ä¸­...';
                clearButton.disabled = true;

                try {
                    const response = await fetch('/index.php?path=/api/masters/members');
                    const result = await response.json();
                    if (result.ok) {
                        const totalMembers = result.data.length;
                        for (let i = 0; i < result.data.length; i++) {
                            const member = result.data[i];
                            clearButton.textContent = `å‰Šé™¤ä¸­... (${i + 1}/${totalMembers})`;

                            console.log('Deleting member:', member.id, member.name);

                            // POSTãƒ¡ã‚½ãƒƒãƒ‰ã§å‰Šé™¤å‡¦ç†ï¼ˆãƒ¬ãƒ³ã‚¿ãƒ«ã‚µãƒ¼ãƒãƒ¼å¯¾å¿œï¼‰
                            const deleteResponse = await fetch('/index.php?path=/api/masters/member', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ action: 'delete', id: member.id })
                            });

                            console.log('Delete response status:', deleteResponse.status);
                            const deleteResult = await deleteResponse.json();
                            console.log('Delete result:', deleteResult);

                            if (!deleteResult.ok) {
                                console.error('Failed to delete member:', member.id, deleteResult.message);
                            }
                        }
                    }
                    alert('å½¹å“¡ãƒã‚¹ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
                    load(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                } catch (error) {
                    console.error('å½¹å“¡ãƒã‚¹ã‚¿ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
                    alert('å½¹å“¡ãƒã‚¹ã‚¿ã‚¯ãƒªã‚¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                } finally {
                    // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                    clearButton.textContent = originalText;
                    clearButton.disabled = false;
                }
            };

            document.getElementById('clear_requests').onclick = async () => {
                if (!confirm('è³¼å…¥å¸Œæœ›ãƒªã‚¹ãƒˆã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) return;

                try {
                    // ã¾ãšç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’ç¢ºèª
                    const requestsResponse = await fetch('/index.php?path=/api/requests');
                    const requestsResult = await requestsResponse.json();
                    if (!requestsResult.ok || !requestsResult.data || requestsResult.data.length === 0) {
                        alert('å‰Šé™¤ã™ã‚‹è³¼å…¥å¸Œæœ›ãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                        return;
                    }

                    const requestCount = requestsResult.data.length;
                    if (!confirm(`ç¾åœ¨${requestCount}ä»¶ã®è³¼å…¥å¸Œæœ›ãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã™ã€‚\nå‰Šé™¤å‰ã«è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) return;

                    // è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ
                    console.log('è³¼å…¥å¸Œæœ›ãƒªã‚¹ãƒˆã‚¯ãƒªã‚¢å‰ã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆä¸­...');
                    const backupResponse = await fetch('/index.php?path=/api/backups', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'full' })
                    });
                    const backupResult = await backupResponse.json();

                    if (!backupResult.ok) {
                        alert('è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼: ' + backupResult.message + '\n\nå®‰å…¨ã®ãŸã‚ã€å‰Šé™¤ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚');
                        return;
                    }

                    console.log('è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆå®Œäº†:', backupResult.data.filename);

                    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆå®Œäº†ã‚’é€šçŸ¥
                    if (!confirm(`è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚\nãƒ•ã‚¡ã‚¤ãƒ«: ${backupResult.data.filename}\n\nè³¼å…¥å¸Œæœ›ãƒªã‚¹ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

                    // è³¼å…¥å¸Œæœ›ãƒªã‚¹ãƒˆã‚’å‰Šé™¤
                    let deletedCount = 0;
                    let errorCount = 0;

                    for (const request of requestsResult.data) {
                        try {
                            const deleteResponse = await fetch(`/index.php?path=/api/requests/${request.id}`, {
                                method: 'DELETE'
                            });
                            if (deleteResponse.ok) {
                                deletedCount++;
                            } else {
                                errorCount++;
                                console.error(`Failed to delete request ${request.id}:`, await deleteResponse.text());
                            }
                        } catch (error) {
                            errorCount++;
                            console.error(`Error deleting request ${request.id}:`, error);
                        }
                    }

                    // çµæœã‚’é€šçŸ¥
                    let message = `è³¼å…¥å¸Œæœ›ãƒªã‚¹ãƒˆã®å‰Šé™¤ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\nå‰Šé™¤ä»¶æ•°: ${deletedCount}ä»¶`;
                    if (errorCount > 0) {
                        message += `\nã‚¨ãƒ©ãƒ¼ä»¶æ•°: ${errorCount}ä»¶`;
                    }
                    message += `\n\nè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«: ${backupResult.data.filename}`;

                    alert(message);

                    // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    loadRequests();

                } catch (error) {
                    console.error('è³¼å…¥å¸Œæœ›ãƒªã‚¹ãƒˆã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
                    alert('è³¼å…¥å¸Œæœ›ãƒªã‚¹ãƒˆã‚¯ãƒªã‚¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            };

            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç†æ©Ÿèƒ½ã‚’è¿½åŠ 
            document.getElementById('create_backup').onclick = async () => {
                try {
                    const response = await fetch('/index.php?path=/api/backups', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'full' })
                    });

                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å†…å®¹ã‚’ç¢ºèª
                    const responseText = await response.text();
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    console.log('Response text:', responseText);

                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©ºã®å ´åˆã®å‡¦ç†
                    if (!responseText || responseText.trim() === '') {
                        console.error('Empty response from server');
                        alert('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                        return;
                    }

                    // JSONãƒ‘ãƒ¼ã‚¹ã‚’è©¦è¡Œ
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError);
                        console.error('Response was not JSON:', responseText);
                        alert('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ç„¡åŠ¹ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã¾ã—ãŸã€‚\n\nãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹:\n' + responseText);
                        return;
                    }

                    if (result.ok) {
                        alert(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒä½œæˆã•ã‚Œã¾ã—ãŸ:\nãƒ•ã‚¡ã‚¤ãƒ«: ${result.data.filename}\nã‚µã‚¤ã‚º: ${(result.data.size / 1024 / 1024).toFixed(2)} MB`);
                        if (result.data.debug_info) {
                            console.log('Backup debug info:', result.data.debug_info);
                        }
                        loadBackups();
                    } else {
                        let errorMsg = 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message;
                        if (result.debug_info) {
                            console.error('Backup debug info:', result.debug_info);
                            errorMsg += '\n\nãƒ‡ãƒãƒƒã‚°æƒ…å ±:\n' + result.debug_info.join('\n');
                        }
                        alert(errorMsg);
                    }
                } catch (error) {
                    console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            };

            document.getElementById('create_backup_from_list').onclick = async () => {
                try {
                    const response = await fetch('/index.php?path=/api/backups', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'full' })
                    });

                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å†…å®¹ã‚’ç¢ºèª
                    const responseText = await response.text();
                    console.log('Response text:', responseText);

                    // JSONãƒ‘ãƒ¼ã‚¹ã‚’è©¦è¡Œ
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError);
                        console.error('Response was not JSON:', responseText);
                        alert('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ç„¡åŠ¹ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã¾ã—ãŸã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚');
                        return;
                    }

                    if (result.ok) {
                        alert(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒä½œæˆã•ã‚Œã¾ã—ãŸ:\nãƒ•ã‚¡ã‚¤ãƒ«: ${result.data.filename}\nã‚µã‚¤ã‚º: ${(result.data.size / 1024 / 1024).toFixed(2)} MB`);
                        if (result.data.debug_info) {
                            console.log('Backup debug info:', result.data.debug_info);
                        }
                        loadBackups();
                    } else {
                        let errorMsg = 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message;
                        if (result.debug_info) {
                            console.error('Backup debug info:', result.debug_info);
                            errorMsg += '\n\nãƒ‡ãƒãƒƒã‚°æƒ…å ±:\n' + result.debug_info.join('\n');
                        }
                        alert(errorMsg);
                    }
                } catch (error) {
                    console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            };

            document.getElementById('search_backups').onclick = async () => {
                const startDate = document.getElementById('backup_start_date').value;
                const endDate = document.getElementById('backup_end_date').value;

                if (!startDate || !endDate) {
                    alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // æ—¥ä»˜å½¢å¼ã‚’YYYYMMDDã«å¤‰æ›
                const startDateFormatted = startDate.replace(/-/g, '');
                const endDateFormatted = endDate.replace(/-/g, '');

                console.log('Searching backups from', startDateFormatted, 'to', endDateFormatted);

                // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¤œç´¢å‡¦ç†
                try {
                    const response = await fetch(`/index.php?path=/api/backups/period&start_date=${startDateFormatted}&end_date=${endDateFormatted}`);
                    const data = await response.json();

                    console.log('Search response:', data);

                    if (!data.ok) {
                        alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.message);
                        return;
                    }

                    const backupList = document.getElementById('backup_list');
                    if (data.data.length === 0) {
                        backupList.innerHTML = '<p>æŒ‡å®šæœŸé–“å†…ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
                        return;
                    }

                    backupList.innerHTML = data.data.map(backup => `
                <div class="backup-item" style="margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${backup.filename}</strong><br/>
                            <small style="color: #666;">ä½œæˆæ—¥æ™‚: ${backup.created_at}</small><br/>
                            <small style="color: #666;">ã‚µã‚¤ã‚º: ${(backup.size / 1024).toFixed(2)} KB</small>
                        </div>
                        <div>
                            <button onclick="downloadBackup('${backup.filename}')" class="btn-info">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                            <button onclick="restoreBackup('${backup.filename}')" class="btn-success">å¾©å…ƒ</button>
                            <button onclick="deleteBackup('${backup.filename}')" class="btn-danger">å‰Šé™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');

                } catch (error) {
                    console.error('Backup search error:', error);
                    alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                }
            };

            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾©å…ƒãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('upload_restore').onclick = uploadAndRestore;

            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´æ©Ÿèƒ½ã‚’è¿½åŠ 
            document.getElementById('change_admin_password').onclick = async () => {
                const currentPassword = document.getElementById('admin_current_password').value;
                const newPassword = document.getElementById('admin_new_password').value;
                const confirmPassword = document.getElementById('admin_confirm_password').value;

                if (!currentPassword || !newPassword || !confirmPassword) {
                    alert('ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    alert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ç¢ºèªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚');
                    return;
                }

                if (newPassword.length < 6) {
                    alert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                try {
                    const response = await fetch('/index.php?path=/api/auth/change_password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            role: 'ADMIN',
                            current_password: currentPassword,
                            new_password: newPassword
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.ok) {
                        alert('ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚');
                        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                        document.getElementById('admin_current_password').value = '';
                        document.getElementById('admin_new_password').value = '';
                        document.getElementById('admin_confirm_password').value = '';
                    } else {
                        console.error('Password change failed:', result);
                        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                    }
                } catch (error) {
                    console.error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
                    if (error.message.includes('HTTP error')) {
                        alert('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                    } else if (error.message.includes('Failed to fetch')) {
                        alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    } else {
                        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                    }
                }
            };

            document.getElementById('change_finance_password').onclick = async () => {
                const currentPassword = document.getElementById('finance_current_password').value;
                const newPassword = document.getElementById('finance_new_password').value;
                const confirmPassword = document.getElementById('finance_confirm_password').value;

                if (!currentPassword || !newPassword || !confirmPassword) {
                    alert('ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    alert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ç¢ºèªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚');
                    return;
                }

                if (newPassword.length < 6) {
                    alert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                try {
                    const response = await fetch('/index.php?path=/api/auth/change_password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            role: 'FINANCE',
                            current_password: currentPassword,
                            new_password: newPassword
                        })
                    });
                    const result = await response.json();
                    if (result.ok) {
                        alert('è²¡å‹™ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚');
                        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                        document.getElementById('finance_current_password').value = '';
                        document.getElementById('finance_new_password').value = '';
                        document.getElementById('finance_confirm_password').value = '';
                    } else {
                        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
                    }
                } catch (error) {
                    console.error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                }
            };

            document.getElementById('change_officer_password').onclick = async () => {
                const currentPassword = document.getElementById('officer_current_password').value;
                const newPassword = document.getElementById('officer_new_password').value;
                const confirmPassword = document.getElementById('officer_confirm_password').value;

                if (!currentPassword || !newPassword || !confirmPassword) {
                    alert('ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    alert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ç¢ºèªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚');
                    return;
                }

                if (newPassword.length < 6) {
                    alert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                try {
                    const response = await fetch('/index.php?path=/api/auth/change_password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            role: 'OFFICER',
                            current_password: currentPassword,
                            new_password: newPassword
                        })
                    });
                    const result = await response.json();
                    if (result.ok) {
                        alert('å½¹å“¡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚');
                        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                        document.getElementById('officer_current_password').value = '';
                        document.getElementById('officer_new_password').value = '';
                        document.getElementById('officer_confirm_password').value = '';
                    } else {
                        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
                    }
                } catch (error) {
                    console.error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                }
            };
        });

        // nanashi-mumei.gif ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½
        document.addEventListener('DOMContentLoaded', function () {
            const mumeiGif = document.getElementById('nanashi-mumei-gif');
            const mumeiModal = document.getElementById('mumei-modal');
            const mumeiModalImg = document.getElementById('mumei-modal-img');

            if (mumeiGif && mumeiModal && mumeiModalImg) {
                mumeiGif.addEventListener('click', function (e) {
                    e.stopPropagation();
                    mumeiModal.classList.add('active');
                });

                mumeiModal.addEventListener('click', function () {
                    mumeiModal.classList.remove('active');
                });
            }
        });
    </script>
    <style>
        .mumei-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .mumei-modal.active {
            display: flex;
        }

        .mumei-modal img {
            height: 600px;
            width: auto;
            pointer-events: none;
        }
    </style>
    <div id="mumei-modal" class="mumei-modal">
        <img id="mumei-modal-img" src="../assets/nanashi-mumei.gif" alt="Nanashi Mumei">
    </div>
    <footer class="page-footer">
        <div class="footer-content">
            <img src="../assets/RyoyuLogo.png" alt="å¯®å‹ä¼šãƒ­ã‚´" class="footer-logo">
            <div class="footer-text">Â© åƒè‘‰å·¥æ¥­å¤§å­¦å¯®å‹ä¼šåŸ·è¡Œå½¹å“¡ä¼š / è²¡å‹™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - Lotus</div>
        </div>
    </footer>
</body>

</html>