<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lotus - æå‡ºãƒšãƒ¼ã‚¸ï¼ˆå½¹å“¡ï¼‰</title>
    <link rel="stylesheet" href="../assets/app.css?v=1">
</head>
<style>
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        z-index: 1000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
        max-width: 400px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .notification.show {
        opacity: 1;
        transform: translateX(0);
    }

    .notification.success {
        background-color: #4CAF50;
    }

    .notification.error {
        background-color: #f44336;
    }

    .notification.info {
        background-color: #2196F3;
    }

    .loading {
        display: none;
        text-align: center;
        margin: 20px 0;
        color: #666;
    }

    .loading.show {
        display: block;
    }

    .submit-btn {
        background-color: #4CAF50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
    }

    .submit-btn:hover {
        background-color: #45a049;
    }

    .submit-btn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }
</style>

<body class="officer-page">
    <div class="page-banner">
        <img id="banner-logo" src="../assets/logo-wh.png" alt="Lotus" class="banner-logo">
        <h1 class="banner-title">è³¼å…¥å¸Œæœ›å±Š æå‡º</h1>
        <div class="banner-spacer"></div>
        <img id="nanashi-mumei-gif" src="../assets/nanashi-mumei.gif" alt="Nanashi Mumei"
            style="height: 50px; width: auto; margin-right: 10px; cursor: pointer;">
        <button class="banner-logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
    <main class="container">
        <!-- æ–°è¦æå‡ºã‚«ãƒ¼ãƒ‰ -->
        <div class="submission-card">
            <h3>æ–°è¦æå‡º</h3>
            <form id="f" enctype="multipart/form-data">
                <div>
                    <label>éƒ¨ç½²: <select name="department_id" id="dept"></select></label>
                    <label>æ°å: <select name="member_id" id="member"></select></label>
                </div>
                <div>
                    <label>æ¦‚è¦: <input name="summary" required maxlength="255" style="color: #333 !important;" /></label>
                </div>
                <div>
                    <label>ãƒãƒƒãƒˆè³¼å…¥:
                        <select name="expects_network" id="networkSelect">
                            <option value="NONE">ãªã—ï¼ˆç¾é‡‘æ‰‹æ¸¡ã—ï¼‰</option>
                            <option value="CONVENIENCE">ã‚³ãƒ³ãƒ“ãƒ‹æ‰•ã„</option>
                            <option value="BANK_TRANSFER">æŒ¯è¾¼</option>
                        </select>
                    </label>
                </div>
                <div id="bankTransferFields" style="display: none;">
                    <label>æŒ¯è¾¼å…ˆéŠ€è¡Œå: <input name="bank_name" placeholder="ä¾‹: ä¸‰è±UFJéŠ€è¡Œ" maxlength="100"
                            style="color: #333 !important;" /></label>
                    <label>æ”¯åº—å: <input name="branch_name" placeholder="ä¾‹: æ–°å®¿æ”¯åº—" maxlength="100"
                            style="color: #333 !important;" /></label>
                    <label>å£åº§ç¨®åˆ¥:
                        <select name="account_type" style="color: #333 !important;">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="æ™®é€š">æ™®é€š</option>
                            <option value="å½“åº§">å½“åº§</option>
                            <option value="è²¯è“„">è²¯è“„</option>
                        </select>
                    </label>
                    <label>å£åº§ç•ªå·: <input name="account_number" placeholder="ä¾‹: 1234567" maxlength="20"
                            style="color: #333 !important;" /></label>
                    <label>å£åº§åç¾©: <input name="account_holder" placeholder="ä¾‹: ãƒ¤ãƒãƒ€ã‚¿ãƒ­ã‚¦" maxlength="100"
                            style="color: #333 !important;" /></label>
                </div>
                <div>
                    <label>è³¼å…¥å¸Œæœ›å±Šï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ï¼‰<span style="color: #666; font-size: 0.9em;">ï¼ˆä»»æ„ï¼‰</span><input type="file"
                            name="excel"
                            accept=".xlsx,.xls,.xlsm,.pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.bmp,.tiff,.zip,.rar,.7z" /></label>
                </div>
                <div class="loading" id="loading">
                    <p>æå‡ºä¸­...</p>
                </div>
                <button type="submit" class="submit-btn" id="submitBtn">æå‡º</button>
            </form>
        </div>

        <!-- æå‡ºå±¥æ­´ã‚«ãƒ¼ãƒ‰ -->
        <div class="submission-card">
            <h3>æå‡ºå±¥æ­´</h3>
            <div class="history-controls">
                <label>éƒ¨ç½²: <select id="historyDept"></select></label>
                <label>æ°å: <select id="historyMember"></select></label>
                <button id="loadHistory" class="btn">å±¥æ­´ã‚’è¡¨ç¤º</button>
            </div>
            <div
                style="margin: 10px 0; padding: 8px; background-color: var(--bg-secondary); border-radius: 4px; font-size: 12px; color: var(--muted);">
                <strong>æ³¨æ„:</strong> éƒ¨ç½²ãƒ»æ°åã‚’æŒ‡å®šã—ãªã„å ´åˆã¯ã€ç¾åœ¨å—ç†æ¸ˆã¿ã¾ãŸã¯æœªå—ç†ã®çŠ¶æ…‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å…¨ã¦è¡¨ç¤ºã—ã¾ã™ã€‚
            </div>
            <div id="historyList" class="history-list"></div>
        </div>
    </main>
    <script>
        // é€šçŸ¥è¡¨ç¤ºé–¢æ•°
        function showNotification(message, type = 'info', duration = 5000) {
            // æ—¢å­˜ã®é€šçŸ¥ã‚’å‰Šé™¤
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // æ–°ã—ã„é€šçŸ¥ã‚’ä½œæˆ
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            // é€šçŸ¥ã‚’è¡¨ç¤º
            document.body.appendChild(notification);

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // è‡ªå‹•ã§éè¡¨ç¤º
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, duration);
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºåˆ¶å¾¡
        function setLoading(show) {
            const loading = document.getElementById('loading');
            const submitBtn = document.getElementById('submitBtn');

            if (show) {
                loading.classList.add('show');
                submitBtn.disabled = true;
                submitBtn.textContent = 'æå‡ºä¸­...';
            } else {
                loading.classList.remove('show');
                submitBtn.disabled = false;
                submitBtn.textContent = 'æå‡º';
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetForm() {
            document.getElementById('f').reset();
            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚‚ãƒªã‚»ãƒƒãƒˆ
            const fileInput = document.querySelector('input[type="file"]');
            if (fileInput) {
                fileInput.value = '';
            }
            // æŒ¯è¾¼å£åº§è¨˜å…¥æ¬„ã‚’éè¡¨ç¤º
            document.getElementById('bankTransferFields').style.display = 'none';
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ãƒ¡ãƒ³ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
        let allMembers = [];

        // ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—
        async function fetchMasters() {
            try {
                const m = await (await fetch('/index.php?path=/api/masters/members')).json();
                const d = await (await fetch('/index.php?path=/api/masters/departments')).json();

                if (m.ok) {
                    allMembers = m.data; // å…¨ãƒ¡ãƒ³ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    updateMemberList(); // åˆæœŸè¡¨ç¤º
                } else {
                    showNotification('å½¹å“¡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }

                if (d.ok) {
                    const sel = document.getElementById('dept');
                    sel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' + d.data.map(x => `<option value="${x.id}">${x.name}</option>`).join('');

                    // éƒ¨ç½²é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                    sel.addEventListener('change', updateMemberList);
                } else {
                    showNotification('éƒ¨ç½²ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                showNotification('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // éƒ¨ç½²ã«åŸºã¥ã„ã¦ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateMemberList() {
            const departmentId = document.getElementById('dept').value;
            const memberSelect = document.getElementById('member');

            // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
            memberSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

            if (departmentId) {
                // é¸æŠã•ã‚ŒãŸéƒ¨ç½²ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ã‚’è¡¨ç¤º
                const departmentMembers = allMembers.filter(member => member.department_id == departmentId);
                memberSelect.innerHTML += departmentMembers.map(x => `<option value="${x.id}">${x.name}</option>`).join('');
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
        document.getElementById('f').onsubmit = async (e) => {
            e.preventDefault();

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const departmentId = document.querySelector('select[name="department_id"]').value;
            const memberId = document.querySelector('select[name="member_id"]').value;
            const summary = document.querySelector('input[name="summary"]').value.trim();
            const fileInput = document.querySelector('input[name="excel"]');

            if (!departmentId) {
                showNotification('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (!memberId) {
                showNotification('æ°åã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (!summary) {
                showNotification('æ¦‚è¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            // æŒ¯è¾¼é¸æŠæ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const expectsNetwork = document.querySelector('select[name="expects_network"]').value;
            if (expectsNetwork === 'BANK_TRANSFER') {
                const bankName = document.querySelector('input[name="bank_name"]').value.trim();
                const branchName = document.querySelector('input[name="branch_name"]').value.trim();
                const accountType = document.querySelector('select[name="account_type"]').value;
                const accountNumber = document.querySelector('input[name="account_number"]').value.trim();
                const accountHolder = document.querySelector('input[name="account_holder"]').value.trim();

                if (!bankName || !branchName || !accountType || !accountNumber || !accountHolder) {
                    showNotification('æŒ¯è¾¼ã‚’é¸æŠã—ãŸå ´åˆã¯ã€æŒ¯è¾¼å£åº§æƒ…å ±ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                    return;
                }
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ10MBåˆ¶é™ï¼‰- ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿
            if (fileInput.files && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                if (file.size > 10 * 1024 * 1024) {
                    showNotification('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ï¼‰', 'error');
                    return;
                }
            }

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹
            setLoading(true);

            try {
                const fd = new FormData(e.target);

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
                console.log('Form data being sent:');
                for (let [key, value] of fd.entries()) {
                    console.log(key + ':', value);
                }

                // ãƒ¬ãƒ³ã‚¿ãƒ«ã‚µãƒ¼ãƒãƒ¼ç”¨ã®å®Œå…¨URLã‚’ä½¿ç”¨
                console.log('Sending request to: /index.php?path=/api/requests');
                const r = await fetch('/index.php?path=/api/requests', {
                    method: 'POST',
                    body: fd
                });

                console.log('Response status:', r.status);
                console.log('Response headers:', r.headers);

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å†…å®¹ã‚’ç¢ºèª
                const responseText = await r.text();
                console.log('Raw response:', responseText);

                // HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
                if (!r.ok) {
                    throw new Error(`HTTP ${r.status}: ${r.statusText}\nResponse: ${responseText}`);
                }

                // JSONãƒ‘ãƒ¼ã‚¹ã‚’è©¦è¡Œ
                let j;
                try {
                    j = JSON.parse(responseText);
                    console.log('Parsed JSON:', j);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒç„¡åŠ¹ã§ã™: ${responseText}`);
                }

                if (j.ok) {
                    // ãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ã‚’è©³ç´°ã«ãƒã‚§ãƒƒã‚¯
                    console.log('Response data:', j.data);
                    console.log('Response data type:', typeof j.data);
                    console.log('Response data length:', j.data ? j.data.length : 'undefined');

                    if (j.data && j.data.request_no) {
                        // æˆåŠŸé€šçŸ¥
                        showNotification(`æå‡ºãŒå®Œäº†ã—ã¾ã—ãŸï¼\nå—ä»˜ç•ªå·: ${j.data.request_no}`, 'success', 8000);

                        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                        resetForm();

                        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
                        console.log('æå‡ºæˆåŠŸ:', j.data);
                    } else {
                        console.error('Request number not found in response:', j.data);
                        showNotification(`æå‡ºã¯å®Œäº†ã—ã¾ã—ãŸãŒã€å—ä»˜ç•ªå·ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚`, 'error');
                    }
                } else {
                    // ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼é€šçŸ¥
                    showNotification(`æå‡ºã«å¤±æ•—ã—ã¾ã—ãŸ: ${j.message}`, 'error');
                    console.error('æå‡ºã‚¨ãƒ©ãƒ¼:', j);
                }
            } catch (error) {
                // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã‚’åˆ¤å®š
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
                    showNotification('æå‡ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                } else if (error.message.includes('HTTP')) {
                    // HTTPã‚¨ãƒ©ãƒ¼
                    showNotification(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'error');
                } else {
                    // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
                    showNotification(`æå‡ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'error');
                }
                console.error('æå‡ºã‚¨ãƒ©ãƒ¼:', error);
            } finally {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
                setLoading(false);
            }
        };

        // ãƒãƒƒãƒˆè³¼å…¥é¸æŠæ™‚ã®å‡¦ç†
        document.getElementById('networkSelect').addEventListener('change', function () {
            const bankTransferFields = document.getElementById('bankTransferFields');
            if (this.value === 'BANK_TRANSFER') {
                bankTransferFields.style.display = 'block';
            } else {
                bankTransferFields.style.display = 'none';
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        fetchMasters();

        // æå‡ºå±¥æ­´è¡¨ç¤ºæ©Ÿèƒ½
        async function loadSubmissionHistory() {
            const deptId = document.getElementById('historyDept').value;
            const memberId = document.getElementById('historyMember').value;

            // èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
            try {
                const authCheck = await fetch('/index.php?path=/api/auth/check');
                if (!authCheck.ok) {
                    alert('èªè¨¼ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚');
                    location.href = '/pages/login.html';
                    return;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                alert('èªè¨¼ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚');
                location.href = '/pages/login.html';
                return;
            }

            try {
                // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
                const queryParams = new URLSearchParams();
                if (deptId) {
                    queryParams.append('department_id', deptId);
                }
                if (memberId) {
                    queryParams.append('member_id', memberId);
                }
                if (!deptId && !memberId) {
                    queryParams.append('state', 'NEW,ACCEPTED');
                }

                // URLã‚’æ§‹ç¯‰
                const baseUrl = '/index.php?path=/api/requests';
                const url = queryParams.toString() ? `${baseUrl}&${queryParams.toString()}` : baseUrl;

                console.log('Fetching history with URL:', url);
                const response = await fetch(url);
                console.log('Response status:', response.status);

                if (!response.ok) {
                    if (response.status === 401) {
                        alert('èªè¨¼ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚');
                        location.href = '/pages/login.html';
                        return;
                    }
                    const errorText = await response.text();
                    console.error('API Error:', errorText);
                    alert('å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: HTTP ' + response.status);
                    return;
                }

                const result = await response.json();
                console.log('API Result:', result);

                if (!result.ok) {
                    alert('å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
                    return;
                }

                displayHistoryList(result.data);
            } catch (error) {
                console.error('Failed to load history:', error);
                alert('å±¥æ­´ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function displayHistoryList(requests) {
            const historyList = document.getElementById('historyList');

            if (requests.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 20px;">æå‡ºå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            historyList.innerHTML = requests.map(request => `
        <div class="history-item">
            <div class="history-header">
                <span class="history-request-no">${request.request_no}</span>
                <span class="history-date">${new Date(request.submitted_at).toLocaleString('ja-JP')}</span>
            </div>
            <div class="history-summary">${request.summary}</div>
            <div class="history-details">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        <span style="color: var(--muted); font-size: 12px;">
                            ${request.expects_network === 'NONE' ? 'ç¾é‡‘æ‰‹æ¸¡ã—' :
                    request.expects_network === 'CONVENIENCE' ? 'ã‚³ãƒ³ãƒ“ãƒ‹æ‰•ã„' : 'æŒ¯è¾¼'}
                        </span>
                        <span style="color: var(--text); font-size: 14px; font-weight: 500;">
                            ${request.dept_name} - ${request.member_name}
                        </span>
                    </div>
                    ${request.cash_given ?
                    '<span style="color: var(--accent); font-weight: 600; font-size: 14px;">æ¸¡ã—é¡: Â¥' + parseFloat(request.cash_given).toLocaleString() + '</span>' :
                    '<span style="color: var(--muted); font-size: 12px;">æ¸¡ã—é¡: æœªè¨­å®š</span>'}
                </div>
                <div class="history-status">
                    <span class="badge ${request.state}">${getStateText(request.state)}</span>
                    ${request.state === 'REJECTED' && request.rejected_reason ?
                    '<div style="color: var(--muted); font-size: 12px; margin-top: 4px;">å´ä¸‹ç†ç”±: ' + request.rejected_reason + '</div>' : ''}
                </div>
            </div>
        </div>
    `).join('');
        }

        function getStateText(state) {
            const stateMap = {
                'NEW': 'ğŸ“‹ æœªå—ç†',
                'ACCEPTED': 'âœ… å—ç†æ¸ˆã¿',
                'CASH_GIVEN': 'ğŸ’° ç¾é‡‘æ¸¡ã—æ¸ˆã¿',
                'COLLECTED': 'ğŸ“„ å›åæ¸ˆã¿',
                'RECEIPT_DONE': 'ğŸ‰ å‡¦ç†å®Œäº†',
                'FINALIZED': 'âœ… è¨˜å…¥å®Œäº†',
                'REJECTED': 'âŒ å´ä¸‹',
                'CASH_WITHDRAWN': 'ğŸ§ ä¸‹ã‚ã—æ¸ˆã¿',
                'PAID': 'ğŸ’³ æ”¯æ‰•ã„æ¸ˆã¿',
                'TRANSFERRED': 'ğŸ¦ æŒ¯è¾¼æ¸ˆã¿'
            };
            return stateMap[state] || state;
        }

        // å±¥æ­´ç”¨ã®éƒ¨ç½²é¸æŠè‚¢ã‚’æ›´æ–°
        function updateHistoryDepartmentOptions() {
            const deptSelect = document.getElementById('historyDept');
            const memberSelect = document.getElementById('historyMember');

            // éƒ¨ç½²é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
            deptSelect.innerHTML = '<option value="">éƒ¨ç½²ã‚’é¸æŠ</option>';
            memberSelect.innerHTML = '<option value="">æ°åã‚’é¸æŠ</option>';

            // éƒ¨ç½²ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦é¸æŠè‚¢ã‚’è¿½åŠ 
            fetch('/index.php?path=/api/masters/departments')
                .then(response => response.json())
                .then(result => {
                    if (result.ok) {
                        deptSelect.innerHTML = '<option value="">éƒ¨ç½²ã‚’é¸æŠ</option>' +
                            result.data.map(dept => `<option value="${dept.id}">${dept.name}</option>`).join('');
                    }
                });
        }

        // éƒ¨ç½²é¸æŠæ™‚ã«æ°åé¸æŠè‚¢ã‚’æ›´æ–°
        function updateHistoryMemberOptions() {
            const deptId = document.getElementById('historyDept').value;
            const memberSelect = document.getElementById('historyMember');

            memberSelect.innerHTML = '<option value="">æ°åã‚’é¸æŠ</option>';

            if (!deptId) return;

            fetch('/index.php?path=/api/masters/members')
                .then(response => response.json())
                .then(result => {
                    if (result.ok) {
                        const members = result.data.filter(member => member.department_id == deptId);
                        memberSelect.innerHTML = '<option value="">æ°åã‚’é¸æŠ</option>' +
                            members.map(member => `<option value="${member.id}">${member.name}</option>`).join('');
                    }
                });
        }

        // ãƒ†ãƒ¼ãƒã«å¿œã˜ã¦ãƒ­ã‚´ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
        function updateBannerLogo() {
            const logo = document.getElementById('banner-logo');
            const isDarkTheme = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (isDarkTheme) {
                logo.src = '../assets/logo-wh.png'; // ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒæ™‚ã¯ç™½ã„ãƒ­ã‚´
            } else {
                logo.src = '../assets/logo-bl.png'; // ãƒ©ã‚¤ãƒˆãƒ†ãƒ¼ãƒæ™‚ã¯é»’ã„ãƒ­ã‚´
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
        async function logout() {
            try {
                await fetch('/index.php?path=/api/auth/logout', { method: 'POST' });
                location.href = '/pages/login.html';
            } catch (e) {
                console.error('Logout failed:', e);
                location.href = '/pages/login.html';
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ­ã‚´ã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', () => {
            updateBannerLogo();
            updateHistoryDepartmentOptions();
        });

        // ãƒ†ãƒ¼ãƒå¤‰æ›´ã‚’ç›£è¦–
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateBannerLogo);

        // å±¥æ­´è¡¨ç¤ºã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('loadHistory').addEventListener('click', loadSubmissionHistory);
        document.getElementById('historyDept').addEventListener('change', updateHistoryMemberOptions);

        // nanashi-mumei.gif ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½
        document.addEventListener('DOMContentLoaded', function () {
            const mumeiGif = document.getElementById('nanashi-mumei-gif');
            const mumeiModal = document.getElementById('mumei-modal');
            const mumeiModalImg = document.getElementById('mumei-modal-img');

            if (mumeiGif && mumeiModal && mumeiModalImg) {
                mumeiGif.addEventListener('click', function (e) {
                    e.stopPropagation();
                    mumeiModal.classList.add('active');
                });

                mumeiModal.addEventListener('click', function () {
                    mumeiModal.classList.remove('active');
                });
            }
        });
    </script>
    <style>
        .mumei-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .mumei-modal.active {
            display: flex;
            flex-direction: column;
        }

        .mumei-modal img {
            height: 600px;
            width: auto;
            pointer-events: none;
        }
    </style>
    <div id="mumei-modal" class="mumei-modal">
        <img id="mumei-modal-img" src="../assets/nanashi-mumei.gif" alt="Nanashi Mumei">
    </div>
</body>

</html>