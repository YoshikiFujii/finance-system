<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Lotus - è²¡å‹™ãƒšãƒ¼ã‚¸</title>
  <link rel="stylesheet" href="../assets/app.css?v=1" />
</head>

<body>
  <div class="page-banner">
    <img id="banner-logo" src="../assets/logo-wh.png" alt="Lotus" class="banner-logo">
    <h1 class="banner-title">è²¡å‹™ä¸€è¦§</h1>
    <div class="banner-spacer"></div>
    <img id="nanashi-mumei-gif" src="../assets/nanashi-mumei.gif" alt="Nanashi Mumei"
      style="height: 50px; width: auto; margin-right: 10px; cursor: pointer;">
    <button class="banner-logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
  <div class="finance-search-controls">
    <input id="q" placeholder="æ¤œç´¢ï¼ˆæå‡ºè€…/æ¦‚è¦ï¼‰" />
    <button id="reload">æ›´æ–°</button>
  </div>
  <table border="1" cellpadding="6">
    <thead>
      <tr>
        <th>å—ä»˜ç•ªå·</th>
        <th>æå‡ºæ—¥æ™‚</th>
        <th>æå‡ºè€…</th>
        <th>éƒ¨ç½²</th>
        <th>æ¦‚è¦</th>
        <th>ãƒãƒƒãƒˆ</th>
        <th>çŠ¶æ…‹</th>
        <th>æ¸¡ã—é¡</th>
        <th>å‡¦ç†æ¸ˆã¿é¡</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="list"></tbody>
  </table>
  <div id="detail"></div>

  <!-- ãƒ¬ã‚·ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="receiptUploadModal" class="modal-overlay">
    <div class="modal-content" style="min-width:400px;">
      <h3>ãƒ¬ã‚·ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
      <form id="receiptUploadForm" enctype="multipart/form-data">
        <input type="hidden" id="uploadRequestId" />
        <label>åˆè¨ˆé‡‘é¡:</label>
        <input type="number" id="receiptTotal" step="0.01" min="0" required />
        <label>è¡Œäº‹:</label>
        <select id="receiptEvent">
          <option value="">è¡Œäº‹ã‚’é¸æŠ</option>
        </select>
        <label>ç§‘ç›®:</label>
        <div style="display: flex; gap: 8px; align-items: center;">
          <select id="receiptSubject" required style="flex: 1;">
            <option value="">ç§‘ç›®ã‚’é¸æŠ</option>
          </select>
          <input type="text" id="receiptSubjectNew" placeholder="æ–°ã—ã„ç§‘ç›®ã‚’å…¥åŠ›" style="flex: 1; display: none;" />
          <button type="button" id="toggleSubjectInput" style="padding: 4px 8px; font-size: 12px;">æ–°è¦è¿½åŠ </button>
        </div>
        <label>è³¼å…¥ç›®çš„:</label>
        <select id="receiptPurpose" required>
          <option value="">è³¼å…¥ç›®çš„ã‚’é¸æŠ</option>
          <option value="å‚™å“è³¼å…¥">å‚™å“è³¼å…¥</option>
          <option value="é‹å–¶ç”¨å“è³¼å…¥">é‹å–¶ç”¨å“è³¼å…¥</option>
          <option value="æ™¯å“è³¼å…¥">æ™¯å“è³¼å…¥</option>
          <option value="åºƒå ±ç‰©ä½œæˆ">åºƒå ±ç‰©ä½œæˆ</option>
          <option value="æœãƒ»æ˜¼ãƒ»å¤œé£Ÿè³¼å…¥">æœãƒ»æ˜¼ãƒ»å¤œé£Ÿè³¼å…¥</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
        <div id="purposeOtherDiv" style="display: none;">
          <label>ãã®ä»–ã®è©³ç´°:</label>
          <input type="text" id="purposeOther" placeholder="è³¼å…¥ç›®çš„ã®è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
        </div>
        <label>æ”¯æ‰•ã„è€…:</label>
        <input type="text" id="receiptPayer" placeholder="æ”¯æ‰•ã„è€…å" />
        <label>ãƒ¬ã‚·ãƒ¼ãƒˆæ—¥ä»˜:</label>
        <input type="date" id="receiptDate" style="color-scheme: light dark;" />
        <div class="modal-buttons">
          <button type="button" onclick="closeReceiptUploadModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="receiptListModal" class="modal-overlay">
    <div class="modal-content" style="min-width:600px;">
      <h3>ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§</h3>
      <div id="receiptList"></div>
      <div class="modal-buttons">
        <button id="completeAllReceiptsBtn" onclick="completeAllReceipts()" style="display: none;">è¨˜å…¥å®Œäº†</button>
        <button onclick="closeReceiptListModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ãƒ¬ã‚·ãƒ¼ãƒˆå‡¦ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="receiptProcessModal" class="modal-overlay">
    <div class="modal-content" style="min-width:400px;">
      <h3>ãƒ¬ã‚·ãƒ¼ãƒˆå‡¦ç†</h3>
      <div id="receiptProcessInfo"></div>
      <label>ãŠé‡£ã‚Šã®é¡:</label>
      <input type="number" id="changeAmount" step="0.01" min="0" value="0" />
      <div class="modal-buttons">
        <button type="button" onclick="closeReceiptProcessModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="button" onclick="processReceipt()">å‡¦ç†å®Œäº†</button>
      </div>
    </div>
  </div>

  <script>
    async function load() {
      const q = document.getElementById('q').value;
      const r = await fetch('/index.php?path=/api/requests&q=' + encodeURIComponent(q));
      const j = await r.json();
      const tb = document.getElementById('list'); tb.innerHTML = '';
      if (!j.ok) { alert(j.message); return; }
      // è¨˜å…¥å®Œäº†ï¼ˆFINALIZEDï¼‰çŠ¶æ…‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é™¤å¤–
      const filteredData = j.data.filter(x => x.state !== 'FINALIZED');
      for (const x of filteredData) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${x.request_no}</td><td>${x.submitted_at}</td><td>${x.member_name}</td><td>${x.dept_name}</td>
<td>${x.summary}</td><td>${getNetworkText(x)}</td>
<td><span class="badge ${x.state}">${getStateText(x.state)}</span>${x.state === 'REJECTED' && x.rejected_reason ? '<br/><small style="color: var(--muted);">ç†ç”±: ' + x.rejected_reason + '</small>' : ''}</td>
<td>${x.cash_given ? 'Â¥' + parseFloat(x.cash_given).toLocaleString() : ''}</td>
<td>${x.processed_amount ? 'Â¥' + parseFloat(x.processed_amount).toLocaleString() : 'Â¥0'}</td>
<td>
<button data-id="${x.id}" class="view-excel" ${!x.excel_path ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>å†…å®¹ç¢ºèª</button>
<button data-id="${x.id}" class="accept">å—ç†</button>
<button data-id="${x.id}" class="reject">å´ä¸‹</button>
<button data-id="${x.id}" class="state-cash-given" style="display: none;">æ¸¡ã—æ¸ˆã¿</button>
<button data-id="${x.id}" class="transfer" style="display: none;">æŒ¯è¾¼æ¸ˆã¿</button>
<button data-id="${x.id}" class="state-collected" style="display: none;">å›åæ¸ˆã¿</button>
<button data-id="${x.id}" class="receipt-process" style="display: none;">å‡¦ç†</button>
<button data-id="${x.id}" class="upload-receipt" style="display: none;">ãƒ¬ã‚·ãƒ¼ãƒˆè¿½åŠ </button>
<button data-id="${x.id}" class="view-receipts" style="display: none;">ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§</button>
</td>`;
        tb.appendChild(tr);

        // çŠ¶æ…‹ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’åˆ¶å¾¡
        const row = tb.lastElementChild;
        const acceptBtn = row.querySelector('.accept');
        const rejectBtn = row.querySelector('.reject');
        const cashGivenBtn = row.querySelector('.state-cash-given');
        const collectedBtn = row.querySelector('.state-collected');
        const receiptBtn = row.querySelector('.receipt-process');
        const uploadReceiptBtn = row.querySelector('.upload-receipt');
        const viewReceiptsBtn = row.querySelector('.view-receipts');

        if (x.state === 'NEW') {
          acceptBtn.style.display = 'inline-block';
          rejectBtn.style.display = 'inline-block';
        } else if (x.state === 'ACCEPTED') {
          // éŠ€è¡ŒæŒ¯è¾¼ã®å ´åˆã¯æŒ¯è¾¼æ¸ˆã¿ãƒœã‚¿ãƒ³ã€ãã‚Œä»¥å¤–ã¯ç¾é‡‘æ¸¡ã—ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          if (x.expects_network === 'BANK_TRANSFER') {
            // æŒ¯è¾¼æ¸ˆã¿ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆå¾Œã§è¿½åŠ ï¼‰
            const transferBtn = row.querySelector('.transfer');
            if (transferBtn) transferBtn.style.display = 'inline-block';
          } else {
            cashGivenBtn.style.display = 'inline-block';
          }
        } else if (x.state === 'CASH_GIVEN') {
          collectedBtn.style.display = 'inline-block';
          uploadReceiptBtn.style.display = 'inline-block';
          viewReceiptsBtn.style.display = 'inline-block';
          // æ¸¡ã—æ¸ˆã¿çŠ¶æ…‹ã§ã¯å—ç†ãƒ»å´ä¸‹ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
          acceptBtn.style.display = 'none';
          rejectBtn.style.display = 'none';
        } else if (x.state === 'TRANSFERRED') {
          // æŒ¯è¾¼æ¸ˆã¿çŠ¶æ…‹ã§ã¯å›åæ¸ˆã¿ãƒœã‚¿ãƒ³ã¨ãƒ¬ã‚·ãƒ¼ãƒˆå‡¦ç†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          collectedBtn.style.display = 'inline-block';
          uploadReceiptBtn.style.display = 'inline-block';
          viewReceiptsBtn.style.display = 'inline-block';
          // æŒ¯è¾¼æ¸ˆã¿çŠ¶æ…‹ã§ã¯å—ç†ãƒ»å´ä¸‹ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
          acceptBtn.style.display = 'none';
          rejectBtn.style.display = 'none';
        } else if (x.state === 'COLLECTED') {
          receiptBtn.style.display = 'inline-block';
          uploadReceiptBtn.style.display = 'inline-block';
          viewReceiptsBtn.style.display = 'inline-block';
          // å›åæ¸ˆã¿çŠ¶æ…‹ã§ã‚‚å—ç†ãƒ»å´ä¸‹ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
          acceptBtn.style.display = 'none';
          rejectBtn.style.display = 'none';
        } else if (x.state === 'RECEIPT_DONE') {
          // å‡¦ç†å®Œäº†çŠ¶æ…‹ã§ã¯ãƒ¬ã‚·ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã€ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ã®ã¿è¡¨ç¤º
          uploadReceiptBtn.style.display = 'none';
          viewReceiptsBtn.style.display = 'inline-block';
          // å‡¦ç†å®Œäº†çŠ¶æ…‹ã§ã¯å—ç†ãƒ»å´ä¸‹ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
          acceptBtn.style.display = 'none';
          rejectBtn.style.display = 'none';
        } else if (x.state === 'FINALIZED') {
          // è¨˜å…¥å®Œäº†çŠ¶æ…‹ã§ã¯å…¨ã¦ã®ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
          uploadReceiptBtn.style.display = 'none';
          viewReceiptsBtn.style.display = 'inline-block';
          acceptBtn.style.display = 'none';
          rejectBtn.style.display = 'none';
        } else if (x.state === 'REJECTED') {
          // å´ä¸‹çŠ¶æ…‹ã§ã¯å—ç†ãƒ»å´ä¸‹ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
          acceptBtn.style.display = 'none';
          rejectBtn.style.display = 'none';
        }

      }
    }

    function getStateText(state) {
      const stateMap = {
        'NEW': 'ğŸ“‹ æœªå—ç†',
        'ACCEPTED': 'ğŸ”µ å—ç†æ¸ˆã¿',
        'CASH_GIVEN': 'ğŸ’° ç¾é‡‘æ¸¡ã—æ¸ˆã¿',
        'COLLECTED': 'ğŸ“„ å›åæ¸ˆã¿',
        'RECEIPT_DONE': 'ğŸ‰ å‡¦ç†å®Œäº†',
        'FINALIZED': 'âœ… è¨˜å…¥å®Œäº†',
        'REJECTED': 'âŒ å´ä¸‹',
        'CASH_WITHDRAWN': 'ğŸ§ ä¸‹ã‚ã—æ¸ˆã¿',
        'PAID': 'ğŸ’³ æ”¯æ‰•ã„æ¸ˆã¿',
        'TRANSFERRED': 'ğŸ¦ æŒ¯è¾¼æ¸ˆã¿'
      };
      return stateMap[state] || state;
    }

    function getNetworkText(request) {
      switch (request.expects_network) {
        case 'NONE':
          return 'ç¾é‡‘æ‰‹æ¸¡ã—';
        case 'CONVENIENCE':
          return 'ã‚³ãƒ³ãƒ“ãƒ‹æ‰•ã„';
        case 'BANK_TRANSFER':
          if (request.bank_name && request.branch_name && request.account_type && request.account_number && request.account_holder) {
            return `æŒ¯è¾¼<br/><small style="color: var(--muted); font-size: 11px;">
${request.bank_name} ${request.branch_name}<br/>
${request.account_type} ${request.account_number}<br/>
${request.account_holder}
</small>`;
          } else {
            return 'æŒ¯è¾¼ï¼ˆå£åº§æƒ…å ±æœªå…¥åŠ›ï¼‰';
          }
        default:
          return request.expects_network;
      }
    }

    load();


    document.getElementById('reload').onclick = load;


    document.addEventListener('click', async (e) => {
      const id = e.target?.dataset?.id; if (!id) return;
      if (e.target.className === 'view-excel') {
        // ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å‡¦ç†ã—ãªã„
        if (e.target.disabled) {
          return;
        }
        // ã‚¨ã‚¯ã‚»ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ¥ã‚¿ãƒ–ã§è¡¨ç¤º
        const r = await fetch(`/index.php?path=/api/requests/${id}/excel`);
        if (r.ok) {
          const blob = await r.blob();
          const url = URL.createObjectURL(blob);
          window.open(url, '_blank');
        } else {
          alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
      } else if (e.target.className === 'accept') {
        const r = await fetch(`/index.php?path=/api/requests/${id}/accept`, { method: 'POST' });
        const j = await r.json();
        if (!j.ok) return alert(j.message);
        load();
      } else if (e.target.className === 'state-cash-given') {
        const cashAmount = prompt('æ¸¡ã—é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); if (!cashAmount || isNaN(cashAmount)) return;
        const r = await fetch(`/index.php?path=/api/requests/${id}/cash`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ cash_given: parseFloat(cashAmount) }) });
        const j = await r.json(); if (!j.ok) return alert(j.message);
        const r2 = await fetch(`/index.php?path=/api/requests/${id}/state`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ next_state: 'CASH_GIVEN' }) });
        const j2 = await r2.json(); if (!j2.ok) return alert(j2.message); load();
      } else if (e.target.className === 'transfer') {
        const transferAmount = prompt('æŒ¯è¾¼é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); if (!transferAmount || isNaN(transferAmount)) return;
        const r = await fetch(`/index.php?path=/api/requests/${id}/cash`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ cash_given: parseFloat(transferAmount) }) });
        const j = await r.json(); if (!j.ok) return alert(j.message);
        const r3 = await fetch(`/index.php?path=/api/requests/${id}/state`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ next_state: 'TRANSFERRED' }) });
        const j3 = await r3.json(); if (!j3.ok) return alert(j3.message); load();
      } else if (e.target.className === 'state-collected') {
        const r = await fetch(`/index.php?path=/api/requests/${id}/state`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ next_state: 'COLLECTED' }) });
        const j = await r.json(); if (!j.ok) return alert(j.message); load();
      } else if (e.target.className === 'reject') {
        const reason = prompt('å´ä¸‹ç†ç”±'); if (!reason) return;
        const r = await fetch(`/index.php?path=/api/requests/${id}/reject`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ reason }) });
        const j = await r.json(); if (!j.ok) return alert(j.message); load();
      } else if (e.target.className === 'receipt-process') {
        showReceiptProcessModal(id);
      } else if (e.target.className === 'upload-receipt') {
        showReceiptUploadModal(id);
      } else if (e.target.className === 'view-receipts') {
        showReceiptListModal(id);
      }
    });


    // ãƒ¬ã‚·ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
    async function showReceiptUploadModal(requestId) {
      document.getElementById('uploadRequestId').value = requestId;
      document.getElementById('receiptDate').value = new Date().toISOString().slice(0, 10);

      // ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±ã‚’å–å¾—ã—ã¦æ”¯æ‰•ã„è€…åã‚’è¨­å®š
      try {
        const response = await fetch('/index.php?path=/api/requests');
        const result = await response.json();
        if (result.ok) {
          const request = result.data.find(r => r.id == requestId);
          if (request) {
            document.getElementById('receiptPayer').value = request.member_name;
          }
        }
      } catch (error) {
        console.error('Failed to load request info:', error);
      }

      // è¡Œäº‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      try {
        const response = await fetch('/index.php?path=/api/masters/events');
        const result = await response.json();
        if (result.ok) {
          const eventSelect = document.getElementById('receiptEvent');
          eventSelect.innerHTML = '<option value="">è¡Œäº‹ã‚’é¸æŠ</option>' +
            result.data.map(event => `<option value="${event.id}">${event.name}</option>`).join('');
        }
      } catch (error) {
        console.error('Failed to load events:', error);
      }

      // ç§‘ç›®ä¸€è¦§ã‚’ã‚¯ãƒªã‚¢
      const subjectSelect = document.getElementById('receiptSubject');
      subjectSelect.innerHTML = '<option value="">ç§‘ç›®ã‚’é¸æŠ</option>';
      subjectSelect.required = true;
      document.getElementById('receiptSubjectNew').style.display = 'none';
      document.getElementById('receiptSubjectNew').required = false;

      document.getElementById('receiptUploadModal').classList.add('show');
    }

    // è¡Œäº‹é¸æŠæ™‚ã«ç§‘ç›®ã‚’èª­ã¿è¾¼ã‚€
    document.getElementById('receiptEvent').addEventListener('change', async function () {
      const eventId = this.value;
      const subjectSelect = document.getElementById('receiptSubject');

      if (!eventId) {
        subjectSelect.innerHTML = '<option value="">ç§‘ç›®ã‚’é¸æŠ</option>';
        return;
      }

      try {
        const response = await fetch(`/index.php?path=/api/events/${eventId}/subjects`);
        const result = await response.json();

        if (result.ok) {
          subjectSelect.innerHTML = '<option value="">ç§‘ç›®ã‚’é¸æŠ</option>';
          result.data.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject;
            option.textContent = subject;
            subjectSelect.appendChild(option);
          });
        } else {
          subjectSelect.innerHTML = '<option value="">ç§‘ç›®ã‚’é¸æŠ</option>';
        }
      } catch (error) {
        console.error('Failed to load subjects:', error);
        subjectSelect.innerHTML = '<option value="">ç§‘ç›®ã‚’é¸æŠ</option>';
      }
    });

    // ç§‘ç›®ã®æ–°è¦è¿½åŠ åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById('toggleSubjectInput').addEventListener('click', function () {
      const subjectSelect = document.getElementById('receiptSubject');
      const subjectNew = document.getElementById('receiptSubjectNew');

      if (subjectNew.style.display === 'none') {
        // æ–°è¦å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
        subjectNew.style.display = 'block';
        subjectNew.required = true;
        subjectSelect.required = false;
        subjectSelect.style.display = 'none';
        this.textContent = 'é¸æŠã«æˆ»ã‚‹';
      } else {
        // é¸æŠãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
        subjectNew.style.display = 'none';
        subjectNew.required = false;
        subjectSelect.required = true;
        subjectSelect.style.display = 'block';
        this.textContent = 'æ–°è¦è¿½åŠ ';
      }
    });

    // è³¼å…¥ç›®çš„ã®é¸æŠã«å¿œã˜ã¦è©³ç´°å…¥åŠ›æ¬„ã‚’è¡¨ç¤º/éè¡¨ç¤º
    document.getElementById('receiptPurpose').addEventListener('change', function () {
      const purposeOtherDiv = document.getElementById('purposeOtherDiv');
      const purposeOtherInput = document.getElementById('purposeOther');

      if (this.value === 'ãã®ä»–') {
        purposeOtherDiv.style.display = 'block';
        purposeOtherInput.required = true;
      } else {
        purposeOtherDiv.style.display = 'none';
        purposeOtherInput.required = false;
        purposeOtherInput.value = ''; // å€¤ã‚’ã‚¯ãƒªã‚¢
      }
    });

    function closeReceiptUploadModal() {
      document.getElementById('receiptUploadModal').classList.remove('show');
      document.getElementById('receiptUploadForm').reset();
      // è©³ç´°å…¥åŠ›æ¬„ã‚‚éè¡¨ç¤ºã«æˆ»ã™
      document.getElementById('purposeOtherDiv').style.display = 'none';
      document.getElementById('purposeOther').required = false;
    }

    // ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
    async function showReceiptListModal(requestId) {
      // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®çŠ¶æ…‹ã‚’å–å¾—
      const requestResponse = await fetch('/index.php?path=/api/requests');
      const requestResult = await requestResponse.json();
      let currentRequest = null;
      if (requestResult.ok) {
        currentRequest = requestResult.data.find(r => r.id == requestId);
      }

      const r = await fetch(`/index.php?path=/api/requests/${requestId}/receipts`);
      const j = await r.json();
      if (!j.ok) {
        alert('ãƒ¬ã‚·ãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + j.message);
        return;
      }

      const receiptList = document.getElementById('receiptList');
      if (j.data.length === 0) {
        receiptList.innerHTML = '<p>ãƒ¬ã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
      } else {
        // å‡¦ç†å®Œäº†çŠ¶æ…‹ã®å ´åˆã®ã¿è¨˜å…¥ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆè¨˜å…¥å®Œäº†çŠ¶æ…‹ã§ã¯éè¡¨ç¤ºï¼‰
        const showCompletionButtons = currentRequest && currentRequest.state === 'RECEIPT_DONE';

        receiptList.innerHTML = j.data.map(receipt => `
<div class="receipt-item">
<div class="receipt-header">
<div class="receipt-info">
<strong>${receipt.kind}</strong> - Â¥${parseFloat(receipt.total).toLocaleString()}
${receipt.change_returned > 0 ? '<br/>ãŠé‡£ã‚Š: Â¥' + parseFloat(receipt.change_returned).toLocaleString() : ''}
</div>
<div class="receipt-management-info">
<span style="font-size: 11px; color: #666; background-color: #f0f0f0; padding: 2px 6px; border-radius: 3px;">
${receipt.receipt_no || 'æœªè¨­å®š'}
</span>
</div>
<div class="receipt-actions">
${showCompletionButtons ? `
<button onclick="toggleReceiptStatus(${receipt.id}, ${requestId}, ${receipt.is_completed ? 0 : 1})" 
        class="${receipt.is_completed ? 'btn-success' : 'btn-warning'}" 
        id="receipt-status-${receipt.id}">
  ${receipt.is_completed ? 'è¨˜å…¥æ¸ˆã¿' : 'æœªè¨˜å…¥'}
</button>` : ''}
<button onclick="deleteReceipt(${requestId}, ${receipt.id})" class="btn-danger">å‰Šé™¤</button>
</div>
</div>
<div class="receipt-details">
<div class="receipt-detail-row">
<label>æ’®å½±æ—¥æ™‚:</label>
<span>${receipt.taken_at}</span>
</div>
${receipt.event_name ? `
<div class="receipt-detail-row">
<label>è¡Œäº‹:</label>
<span>${receipt.event_name}</span>
</div>` : ''}
${receipt.subject ? `
<div class="receipt-detail-row">
<label>ç§‘ç›®:</label>
<span>${receipt.subject}</span>
</div>` : ''}
${receipt.purpose ? `
<div class="receipt-detail-row">
<label>è³¼å…¥ç›®çš„:</label>
<span>${receipt.purpose}</span>
</div>` : ''}
${receipt.payer ? `
<div class="receipt-detail-row">
<label>æ”¯æ‰•ã„è€…:</label>
<span>${receipt.payer}</span>
</div>` : ''}
${receipt.receipt_date ? `
<div class="receipt-detail-row">
<label>ãƒ¬ã‚·ãƒ¼ãƒˆæ—¥ä»˜:</label>
<span>${receipt.receipt_date}</span>
</div>` : ''}
${receipt.memo ? `
<div class="receipt-detail-row">
<label>ãƒ¡ãƒ¢:</label>
<span>${receipt.memo}</span>
</div>` : ''}
</div>
</div>
`).join('');
      }

      // è¨˜å…¥å®Œäº†ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
      const completeAllBtn = document.getElementById('completeAllReceiptsBtn');
      if (j.data.length > 0 && currentRequest && currentRequest.state === 'RECEIPT_DONE') {
        // å…¨ã¦ã®ãƒ¬ã‚·ãƒ¼ãƒˆãŒè¨˜å…¥æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
        const allCompleted = j.data.every(receipt => receipt.is_completed === 1);
        if (allCompleted) {
          completeAllBtn.style.display = 'inline-block';
          completeAllBtn.setAttribute('data-request-id', requestId);
        } else {
          completeAllBtn.style.display = 'none';
        }
      } else {
        completeAllBtn.style.display = 'none';
      }

      document.getElementById('receiptListModal').classList.add('show');
    }

    function closeReceiptListModal() {
      document.getElementById('receiptListModal').classList.remove('show');
    }

    // è¨˜å…¥å®Œäº†å‡¦ç†
    async function completeAllReceipts() {
      const completeBtn = document.getElementById('completeAllReceiptsBtn');
      const requestId = completeBtn.getAttribute('data-request-id');

      if (!requestId) {
        alert('ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDãŒå–å¾—ã§ãã¾ã›ã‚“');
        return;
      }

      if (!confirm('å…¨ã¦ã®ãƒ¬ã‚·ãƒ¼ãƒˆã®è¨˜å…¥ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨˜å…¥å®Œäº†çŠ¶æ…‹ã«ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      try {
        // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®çŠ¶æ…‹ã‚’è¨˜å…¥å®Œäº†ã«å¤‰æ›´
        const response = await fetch(`/index.php?path=/api/requests/${requestId}/state`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ next_state: 'FINALIZED' })
        });

        const result = await response.json();
        if (!result.ok) {
          alert('è¨˜å…¥å®Œäº†ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
          return;
        }

        alert('è¨˜å…¥å®Œäº†å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
        closeReceiptListModal();
        load(); // ä¸€è¦§ã‚’æ›´æ–°
      } catch (error) {
        console.error('Failed to complete all receipts:', error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }

    // ãƒ¬ã‚·ãƒ¼ãƒˆã®è¨˜å…¥çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
    async function toggleReceiptStatus(receiptId, requestId, newStatus) {
      try {
        const response = await fetch(`/index.php?path=/api/requests/${requestId}/receipt-status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            receipt_id: receiptId,
            is_completed: newStatus
          })
        });

        const result = await response.json();
        if (!result.ok) {
          alert('ãƒ¬ã‚·ãƒ¼ãƒˆã®çŠ¶æ…‹æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
          return;
        }

        // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
        const button = document.getElementById(`receipt-status-${receiptId}`);
        if (button) {
          if (newStatus === 1) {
            button.textContent = 'è¨˜å…¥æ¸ˆã¿';
            button.className = 'btn-success';
            button.onclick = () => toggleReceiptStatus(receiptId, requestId, 0);
          } else {
            button.textContent = 'æœªè¨˜å…¥';
            button.className = 'btn-warning';
            button.onclick = () => toggleReceiptStatus(receiptId, requestId, 1);
          }
        }

        // å…¨ã¦ã®ãƒ¬ã‚·ãƒ¼ãƒˆãŒè¨˜å…¥æ¸ˆã¿ã«ãªã£ãŸå ´åˆã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ã‚’æ›´æ–°
        if (result.all_completed) {
          alert('å…¨ã¦ã®ãƒ¬ã‚·ãƒ¼ãƒˆã®è¨˜å…¥ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¨˜å…¥å®Œäº†çŠ¶æ…‹ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚');
          closeReceiptListModal();
          load(); // ä¸€è¦§ã‚’æ›´æ–°
        }
      } catch (error) {
        console.error('Error updating receipt status:', error);
        alert('ãƒ¬ã‚·ãƒ¼ãƒˆã®çŠ¶æ…‹æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ãƒ¬ã‚·ãƒ¼ãƒˆå‡¦ç†ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
    let currentProcessRequestId = null;

    async function showReceiptProcessModal(requestId) {
      currentProcessRequestId = requestId;
      try {
        // ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±ã‚’å–å¾—
        const r = await fetch('/index.php?path=/api/requests&q=');
        const j = await r.json();
        if (!j.ok) {
          alert('ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }
        const request = j.data.find(req => req.id == requestId);
        if (!request) {
          alert('ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        // ãƒ¬ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’å–å¾—
        const receiptR = await fetch(`/index.php?path=/api/requests/${requestId}/receipts`);
        const receiptJ = await receiptR.json();
        if (!receiptJ.ok) {
          alert('ãƒ¬ã‚·ãƒ¼ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }

        const processedAmount = receiptJ.data.reduce((sum, receipt) => sum + parseFloat(receipt.total), 0);
        const cashGiven = parseFloat(request.cash_given) || 0;

        document.getElementById('receiptProcessInfo').innerHTML = `
<div style="margin:10px 0;">
<strong>æ¸¡ã—é¡:</strong> Â¥${cashGiven.toLocaleString()}<br/>
<strong>å‡¦ç†æ¸ˆã¿é¡:</strong> Â¥${processedAmount.toLocaleString()}<br/>
<strong>ãŠé‡£ã‚Šäºˆå®š:</strong> Â¥${(cashGiven - processedAmount).toLocaleString()}
</div>
`;

        document.getElementById('changeAmount').value = Math.max(0, cashGiven - processedAmount);
        document.getElementById('receiptProcessModal').classList.add('show');
      } catch (e) {
        console.error('Failed to show receipt process modal:', e);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }

    function closeReceiptProcessModal() {
      document.getElementById('receiptProcessModal').classList.remove('show');
      currentProcessRequestId = null;
    }

    // ãƒ¬ã‚·ãƒ¼ãƒˆå‡¦ç†å®Œäº†
    async function processReceipt() {
      if (!currentProcessRequestId) return;

      const changeAmount = parseFloat(document.getElementById('changeAmount').value) || 0;

      try {
        // ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±ã‚’å–å¾—
        const r = await fetch('/index.php?path=/api/requests&q=');
        const j = await r.json();
        if (!j.ok) {
          alert('ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }
        const request = j.data.find(req => req.id == currentProcessRequestId);
        if (!request) {
          alert('ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }

        // ãƒ¬ã‚·ãƒ¼ãƒˆæƒ…å ±ã‚’å–å¾—
        const receiptR = await fetch(`/index.php?path=/api/requests/${currentProcessRequestId}/receipts`);
        const receiptJ = await receiptR.json();
        if (!receiptJ.ok) {
          alert('ãƒ¬ã‚·ãƒ¼ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }

        const processedAmount = receiptJ.data.reduce((sum, receipt) => sum + parseFloat(receipt.total), 0);
        const cashGiven = parseFloat(request.cash_given) || 0;

        // æ¤œè¨¼: å‡¦ç†æ¸ˆã¿é¡ + ãŠé‡£ã‚Šé¡ = æ¸¡ã—é¡
        if (Math.abs((processedAmount + changeAmount) - cashGiven) > 0.01) {
          alert(`é‡‘é¡ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚\nå‡¦ç†æ¸ˆã¿é¡: Â¥${processedAmount.toLocaleString()}\nãŠé‡£ã‚Šé¡: Â¥${changeAmount.toLocaleString()}\nåˆè¨ˆ: Â¥${(processedAmount + changeAmount).toLocaleString()}\næ¸¡ã—é¡: Â¥${cashGiven.toLocaleString()}`);
          return;
        }

        // çŠ¶æ…‹ã‚’å‡¦ç†å®Œäº†ã«å¤‰æ›´
        const stateR = await fetch(`/index.php?path=/api/requests/${currentProcessRequestId}/state`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ next_state: 'RECEIPT_DONE' })
        });
        const stateJ = await stateR.json();
        if (!stateJ.ok) {
          alert('çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + stateJ.message);
          return;
        }

        alert('ãƒ¬ã‚·ãƒ¼ãƒˆå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
        closeReceiptProcessModal();
        load(); // ä¸€è¦§ã‚’æ›´æ–°
      } catch (e) {
        console.error('Failed to process receipt:', e);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }


    // ãƒ¬ã‚·ãƒ¼ãƒˆå‰Šé™¤
    async function deleteReceipt(requestId, receiptId) {
      if (!confirm('ã“ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      const r = await fetch(`/index.php?path=/api/requests/${requestId}/receipt/delete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ receipt_id: receiptId })
      });
      const j = await r.json();
      if (!j.ok) {
        alert('ãƒ¬ã‚·ãƒ¼ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + j.message);
        return;
      }
      alert('ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      showReceiptListModal(requestId); // ä¸€è¦§ã‚’æ›´æ–°
    }

    // ãƒ¬ã‚·ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById('receiptUploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const requestId = document.getElementById('uploadRequestId').value;

      // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
      console.log('Receipt upload debug - Request ID:', requestId);

      // ç§‘ç›®ã®å€¤ã‚’å–å¾—ï¼ˆé¸æŠã¾ãŸã¯æ–°è¦å…¥åŠ›ï¼‰
      const subjectSelect = document.getElementById('receiptSubject');
      const subjectNew = document.getElementById('receiptSubjectNew');
      const subjectValue = subjectNew.style.display !== 'none' ? subjectNew.value : subjectSelect.value;

      // JSONãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦é€ä¿¡
      const requestData = {
        total: parseFloat(document.getElementById('receiptTotal').value),
        change_returned: 0, // è¿”å´é¡ã¯å¸¸ã«0
        event_id: parseInt(document.getElementById('receiptEvent').value) || 0,
        subject: subjectValue,
        payer: document.getElementById('receiptPayer').value,
        receipt_date: document.getElementById('receiptDate').value
      };

      // è³¼å…¥ç›®çš„ã®å‡¦ç†
      const purpose = document.getElementById('receiptPurpose').value;
      if (purpose === 'ãã®ä»–') {
        const purposeOther = document.getElementById('purposeOther').value;
        if (purposeOther.trim() === '') {
          alert('ãã®ä»–ã‚’é¸æŠã—ãŸå ´åˆã¯è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        requestData.purpose = purposeOther; // è©³ç´°å†…å®¹ã‚’è³¼å…¥ç›®çš„ã¨ã—ã¦é€ä¿¡
      } else {
        requestData.purpose = purpose;
      }

      // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ã‚’ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
      console.log('Receipt upload debug - Request data:', requestData);

      console.log('Receipt upload debug - Sending request to:', `/index.php?path=/api/requests/${requestId}/receipt`);

      const r = await fetch(`/index.php?path=/api/requests/${requestId}/receipt`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
      });

      console.log('Receipt upload debug - Response status:', r.status);
      console.log('Receipt upload debug - Response headers:', Object.fromEntries(r.headers.entries()));

      const j = await r.json();
      console.log('Receipt upload debug - Response JSON:', j);

      if (!j.ok) {
        console.error('Receipt upload debug - Upload failed:', j.message);
        alert('ãƒ¬ã‚·ãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + j.message);
        return;
      }
      alert('ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');

      // å‡¦ç†æ¸ˆã¿é¡ã‚’æ›´æ–°
      await loadProcessedAmount(requestId);

      // ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’æ›´æ–°ï¼ˆé–‹ã„ã¦ã„ã‚‹å ´åˆï¼‰
      const receiptListModal = document.getElementById('receiptListModal');
      if (receiptListModal.classList.contains('show')) {
        showReceiptListModal(requestId);
      }

      // ãƒ¡ã‚¤ãƒ³ã®ä¸€è¦§ã‚’æ›´æ–°
      load();
    });

    // å‡¦ç†æ¸ˆã¿é¡ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°
    async function loadProcessedAmount(requestId) {
      try {
        const r = await fetch(`/index.php?path=/api/requests/${requestId}/receipts`);
        const j = await r.json();
        if (j.ok) {
          const totalAmount = j.data.reduce((sum, receipt) => sum + parseFloat(receipt.total), 0);
          const processedElement = document.getElementById(`processed_amount_${requestId}`);
          if (processedElement) {
            processedElement.textContent = 'Â¥' + totalAmount.toLocaleString();
          }
        }
      } catch (error) {
        console.error('Load processed amount error:', error);
      }
    }

    // ãƒ†ãƒ¼ãƒã«å¿œã˜ã¦ãƒ­ã‚´ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
    function updateBannerLogo() {
      const logo = document.getElementById('banner-logo');
      const isDarkTheme = window.matchMedia('(prefers-color-scheme: dark)').matches;

      if (isDarkTheme) {
        logo.src = '../assets/logo-wh.png'; // ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒæ™‚ã¯ç™½ã„ãƒ­ã‚´
      } else {
        logo.src = '../assets/logo-bl.png'; // ãƒ©ã‚¤ãƒˆãƒ†ãƒ¼ãƒæ™‚ã¯é»’ã„ãƒ­ã‚´
      }
    }

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
    async function logout() {
      try {
        await fetch('/index.php?path=/api/auth/logout', { method: 'POST' });
        location.href = '/pages/login.html';
      } catch (e) {
        console.error('Logout failed:', e);
        location.href = '/pages/login.html';
      }
    }


    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ­ã‚´ã‚’è¨­å®š
    document.addEventListener('DOMContentLoaded', updateBannerLogo);

    // ãƒ†ãƒ¼ãƒå¤‰æ›´ã‚’ç›£è¦–
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateBannerLogo);

    // nanashi-mumei.gif ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½
    document.addEventListener('DOMContentLoaded', function () {
      const mumeiGif = document.getElementById('nanashi-mumei-gif');
      const mumeiModal = document.getElementById('mumei-modal');
      const mumeiModalImg = document.getElementById('mumei-modal-img');

      if (mumeiGif && mumeiModal && mumeiModalImg) {
        mumeiGif.addEventListener('click', function (e) {
          e.stopPropagation();
          mumeiModal.classList.add('active');
        });

        mumeiModal.addEventListener('click', function () {
          mumeiModal.classList.remove('active');
        });
      }
    });
  </script>
  <style>
    .mumei-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }

    .mumei-modal.active {
      display: flex;
    }

    .mumei-modal img {
      height: 600px;
      width: auto;
      pointer-events: none;
    }
  </style>
  <div id="mumei-modal" class="mumei-modal">
    <img id="mumei-modal-img" src="../assets/nanashi-mumei.gif" alt="Nanashi Mumei">
  </div>
  <footer class="page-footer">
    <div class="footer-content">
      <img src="../assets/RyoyuLogo.png" alt="å¯®å‹ä¼šãƒ­ã‚´" class="footer-logo">
      <div class="footer-text">Â© åƒè‘‰å·¥æ¥­å¤§å­¦å¯®å‹ä¼šåŸ·è¡Œå½¹å“¡ä¼š / è²¡å‹™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - Lotus</div>
    </div>
  </footer>
</body>

</html>