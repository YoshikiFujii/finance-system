<!doctype html><html lang="ja"><meta charset="utf-8"/>
<title>提出ページ（役員）</title>
<style>
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    z-index: 1000;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
    max-width: 400px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
.notification.show {
    opacity: 1;
    transform: translateX(0);
}
.notification.success {
    background-color: #4CAF50;
}
.notification.error {
    background-color: #f44336;
}
.notification.info {
    background-color: #2196F3;
}
.loading {
    display: none;
    text-align: center;
    margin: 20px 0;
    color: #666;
}
.loading.show {
    display: block;
}
.submit-btn {
    background-color: #4CAF50;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.3s;
}
.submit-btn:hover {
    background-color: #45a049;
}
.submit-btn:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}
</style>
<body>
<h1>購入希望届 提出</h1>
<form id="f" enctype="multipart/form-data">
<div>
<label>部署: <select name="department_id" id="dept"></select></label>
<label>氏名: <select name="member_id" id="member"></select></label>
</div>
<div>
<label>概要: <input name="summary" required maxlength="255"/></label>
</div>
<div>
<label>ネット購入:
<select name="expects_network">
<option value="NONE">なし（現金手渡し）</option>
<option value="CONVENIENCE">コンビニ払い</option>
<option value="BANK_TRANSFER">振込</option>
</select>
</label>
</div>
<div>
<label>購入希望届（Excel）<input type="file" name="excel" accept=".xlsx,.xls" required/></label>
</div>
<div class="loading" id="loading">
    <p>提出中...</p>
</div>
<button type="submit" class="submit-btn" id="submitBtn">提出</button>
</form>
<script>
// 通知表示関数
function showNotification(message, type = 'info', duration = 5000) {
    // 既存の通知を削除
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // 新しい通知を作成
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    // 通知を表示
    document.body.appendChild(notification);
    
    // アニメーション開始
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);
    
    // 自動で非表示
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, duration);
}

// ローディング表示制御
function setLoading(show) {
    const loading = document.getElementById('loading');
    const submitBtn = document.getElementById('submitBtn');
    
    if (show) {
        loading.classList.add('show');
        submitBtn.disabled = true;
        submitBtn.textContent = '提出中...';
    } else {
        loading.classList.remove('show');
        submitBtn.disabled = false;
        submitBtn.textContent = '提出';
    }
}

// フォームリセット
function resetForm() {
    document.getElementById('f').reset();
    // ファイル入力もリセット
    const fileInput = document.querySelector('input[type="file"]');
    if (fileInput) {
        fileInput.value = '';
    }
}

// グローバル変数でメンバーデータを保持
let allMembers = [];

// マスターデータ取得
async function fetchMasters(){
    try {
        const m = await (await fetch('/api/masters/members')).json();
        const d = await (await fetch('/api/masters/departments')).json();
        
        if(m.ok){ 
            allMembers = m.data; // 全メンバーデータを保存
            updateMemberList(); // 初期表示
        } else {
            showNotification('役員データの取得に失敗しました', 'error');
        }
        
        if(d.ok){ 
            const sel = document.getElementById('dept'); 
            sel.innerHTML = '<option value="">選択してください</option>' + d.data.map(x=>`<option value="${x.id}">${x.name}</option>`).join(''); 
            
            // 部署選択時のイベントリスナーを追加
            sel.addEventListener('change', updateMemberList);
        } else {
            showNotification('部署データの取得に失敗しました', 'error');
        }
    } catch (error) {
        showNotification('データの取得中にエラーが発生しました', 'error');
    }
}

// 部署に基づいてメンバーリストを更新
function updateMemberList() {
    const departmentId = document.getElementById('dept').value;
    const memberSelect = document.getElementById('member');
    
    // メンバーリストをクリア
    memberSelect.innerHTML = '<option value="">選択してください</option>';
    
    if (departmentId) {
        // 選択された部署のメンバーのみを表示
        const departmentMembers = allMembers.filter(member => member.department_id == departmentId);
        memberSelect.innerHTML += departmentMembers.map(x => `<option value="${x.id}">${x.name}</option>`).join('');
    }
}

// フォーム送信処理
document.getElementById('f').onsubmit = async (e)=>{
    e.preventDefault();
    
    // バリデーション
    const departmentId = document.querySelector('select[name="department_id"]').value;
    const memberId = document.querySelector('select[name="member_id"]').value;
    const summary = document.querySelector('input[name="summary"]').value.trim();
    const fileInput = document.querySelector('input[name="excel"]');
    
    if (!departmentId) {
        showNotification('部署を選択してください', 'error');
        return;
    }
    
    if (!memberId) {
        showNotification('氏名を選択してください', 'error');
        return;
    }
    
    if (!summary) {
        showNotification('概要を入力してください', 'error');
        return;
    }
    
    if (!fileInput.files || fileInput.files.length === 0) {
        showNotification('Excelファイルを選択してください', 'error');
        return;
    }
    
    // ファイルサイズチェック（10MB制限）
    const file = fileInput.files[0];
    if (file.size > 10 * 1024 * 1024) {
        showNotification('ファイルサイズが大きすぎます（10MB以下にしてください）', 'error');
        return;
    }
    
    // ローディング開始
    setLoading(true);
    
    try {
        const fd = new FormData(e.target);
        const r = await fetch('/api/requests', {method: 'POST', body: fd});
        
        // HTTPステータスコードをチェック
        if (!r.ok) {
            throw new Error(`HTTP ${r.status}: ${r.statusText}`);
        }
        
        const j = await r.json();
        
        if (j.ok) {
            // 成功通知
            showNotification(`提出が完了しました！\n受付番号: ${j.data.request_no}`, 'success', 8000);
            
            // フォームリセット
            resetForm();
            
            // 成功メッセージをコンソールにも出力
            console.log('提出成功:', j.data);
        } else {
            // サーバーエラー通知
            showNotification(`提出に失敗しました: ${j.message}`, 'error');
            console.error('提出エラー:', j);
        }
    } catch (error) {
        // エラーの種類を判定
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            // ネットワークエラー
            showNotification('提出中にエラーが発生しました。ネットワーク接続を確認してください。', 'error');
        } else if (error.message.includes('HTTP')) {
            // HTTPエラー
            showNotification(`サーバーエラーが発生しました: ${error.message}`, 'error');
        } else {
            // その他のエラー
            showNotification(`提出中にエラーが発生しました: ${error.message}`, 'error');
        }
        console.error('提出エラー:', error);
    } finally {
        // ローディング終了
        setLoading(false);
    }
};

// ページ読み込み時にマスターデータを取得
fetchMasters();
</script>
</body></html>